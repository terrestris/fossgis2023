import{B as y,A as Le,g as K,bB as Fe,bl as $e,l as At,u as Be,E as W,b7 as Xe,W as V,v as re,z as M,C as St,bR as Lt,bS as Ct,F as bt,b as Ut,D as Nt,y as ae,bj as ie,bi as me,bT as et,m as tt,bU as vt,aE as Pt,bV as rt,aK as H,aJ as de,i as It,b4 as Ot,bk as Gt,e as Dt,h as ze,f as nt,bf as wt,bW as Mt,bX as Ft,Y as $t}from"./Source.13d28e10.js";import{o as Bt,s as Te,r as Xt,t as zt,E as jt,T as Ht,a as Yt,h as Wt,f as Kt,l as Vt,g as Zt,b as kt,e as je,m as _e,I as He,R as xe,k as qt,u as Ye,L as Jt,d as ye}from"./TileEventType.16115d42.js";import{B as Qt}from"./BaseTile.8715c233.js";function le(n){return n instanceof Image||n instanceof HTMLCanvasElement||n instanceof HTMLVideoElement?n:null}function Ae(n){return n instanceof Uint8Array||n instanceof Uint8ClampedArray||n instanceof Float32Array||n instanceof DataView?n:null}let q=null;function er(n){q||(q=Le(n.width,n.height,void 0,{willReadFrequently:!0}));const e=q.canvas,t=n.width;e.width!==t&&(e.width=t);const r=n.height;return e.height!==r&&(e.height=r),q.drawImage(n,t,r),q.getImageData(0,0,t,r).data}const tr=[256,256];class rr extends Bt{constructor(e){const t=y.IDLE;super(e.tileCoord,t,{transition:e.transition,interpolate:e.interpolate}),this.loader_=e.loader,this.data_=null,this.error_=null,this.size_=e.size||null}getSize(){if(this.size_)return this.size_;const e=le(this.data_);return e?[e.width,e.height]:tr}getData(){return this.data_}getError(){return this.error_}load(){if(this.state!==y.IDLE&&this.state!==y.ERROR)return;this.state=y.LOADING,this.changed();const e=this;this.loader_().then(function(t){e.data_=t,e.state=y.LOADED,e.changed()}).catch(function(t){e.error_=t,e.state=y.ERROR,e.changed()})}}const Ce=rr;class nr extends Ce{constructor(e){super({tileCoord:e.tileCoord,loader:()=>Promise.resolve(new Uint8Array(4)),interpolate:e.interpolate,transition:e.transition}),this.pixelRatio_=e.pixelRatio,this.gutter_=e.gutter,this.reprojData_=null,this.reprojError_=null,this.reprojSize_=void 0,this.sourceTileGrid_=e.sourceTileGrid,this.targetTileGrid_=e.targetTileGrid,this.wrappedTileCoord_=e.wrappedTileCoord||e.tileCoord,this.sourceTiles_=[],this.sourcesListenerKeys_=null,this.sourceZ_=0;const t=this.targetTileGrid_.getTileCoordExtent(this.wrappedTileCoord_),r=this.targetTileGrid_.getExtent();let i=this.sourceTileGrid_.getExtent();const s=r?K(t,r):t;if(Fe(s)===0){this.state=y.EMPTY;return}const o=e.sourceProj,a=o.getExtent();a&&(i?i=K(i,a):i=a);const u=this.targetTileGrid_.getResolution(this.wrappedTileCoord_[0]),l=e.targetProj,h=zt(o,l,s,u);if(!isFinite(h)||h<=0){this.state=y.EMPTY;return}const c=e.errorThreshold!==void 0?e.errorThreshold:jt;if(this.triangulation_=new Ht(o,l,s,i,h*c,u),this.triangulation_.getTriangles().length===0){this.state=y.EMPTY;return}this.sourceZ_=this.sourceTileGrid_.getZForResolution(h);let T=this.triangulation_.calculateSourceExtent();if(i&&(o.canWrapX()?(T[1]=Xe(T[1],i[1],i[3]),T[3]=Xe(T[3],i[1],i[3])):T=K(T,i)),!Fe(T))this.state=y.EMPTY;else{const _=this.sourceTileGrid_.getTileRangeForExtentAndZ(T,this.sourceZ_),m=e.getTileFunction;for(let b=_.minX;b<=_.maxX;b++)for(let p=_.minY;p<=_.maxY;p++){const S=m(this.sourceZ_,b,p,this.pixelRatio_);S&&this.sourceTiles_.push(S)}this.sourceTiles_.length===0&&(this.state=y.EMPTY)}}getSize(){return this.reprojSize_}getData(){return this.reprojData_}getError(){return this.reprojError_}reproject_(){const e=[];if(this.sourceTiles_.forEach(t=>{if(!t||t.getState()!==y.LOADED)return;const r=t.getSize(),i=this.gutter_;let s;const o=Ae(t.getData());o?s=o:s=er(le(t.getData()));const a=[r[0]+2*i,r[1]+2*i],u=s instanceof Float32Array,l=a[0]*a[1],h=u?Float32Array:Uint8Array,c=new h(s.buffer),T=h.BYTES_PER_ELEMENT,_=T*c.length/l,m=c.byteLength/a[1],b=Math.floor(m/T/a[0]),p=l*b;let S=c;if(c.length!==p){S=new h(p);let R=0,x=0;const A=a[0]*b;for(let v=0;v<a[1];++v){for(let P=0;P<A;++P)S[R++]=c[x+P];x+=m/T}}e.push({extent:this.sourceTileGrid_.getTileCoordExtent(t.tileCoord),data:new Uint8Array(S.buffer),dataType:h,bytesPerPixel:_,pixelSize:a})}),this.sourceTiles_.length=0,e.length===0)this.state=y.ERROR;else{const t=this.wrappedTileCoord_[0],r=this.targetTileGrid_.getTileSize(t),i=typeof r=="number"?r:r[0],s=typeof r=="number"?r:r[1],o=this.targetTileGrid_.getResolution(t),a=this.sourceTileGrid_.getResolution(this.sourceZ_),u=this.targetTileGrid_.getTileCoordExtent(this.wrappedTileCoord_);let l,h;const c=e[0].bytesPerPixel,T=Math.ceil(c/3);for(let _=T-1;_>=0;--_){const m=[];for(let A=0,v=e.length;A<v;++A){const P=e[A],L=P.data,C=P.pixelSize,I=C[0],O=C[1],G=Le(I,O,Te),D=G.createImageData(I,O),w=D.data;let X=_*3;for(let z=0,fe=w.length;z<fe;z+=4)w[z]=L[X],w[z+1]=L[X+1],w[z+2]=L[X+2],w[z+3]=255,X+=c;G.putImageData(D,0,0),m.push({extent:P.extent,image:G.canvas})}const b=Xt(i,s,this.pixelRatio_,a,this.sourceTileGrid_.getExtent(),o,u,this.triangulation_,m,this.gutter_,!1,!1);for(let A=0,v=m.length;A<v;++A){const L=m[A].image.getContext("2d");$e(L),Te.push(L.canvas)}const p=b.getContext("2d"),S=p.getImageData(0,0,b.width,b.height);$e(p),Te.push(b),l||(h=new Uint8Array(c*S.width*S.height),l=new e[0].dataType(h.buffer));const R=S.data;let x=_*3;for(let A=0,v=R.length;A<v;A+=4)R[A+3]===255?(h[x]=R[A],h[x+1]=R[A+1],h[x+2]=R[A+2]):(h[x]=0,h[x+1]=0,h[x+2]=0),x+=c}this.reprojData_=l,this.reprojSize_=[Math.round(i*this.pixelRatio_),Math.round(s*this.pixelRatio_)],this.state=y.LOADED}this.changed()}load(){if(this.state!==y.IDLE&&this.state!==y.ERROR)return;this.state=y.LOADING,this.changed();let e=0;this.sourcesListenerKeys_=[],this.sourceTiles_.forEach(t=>{const r=t.getState();if(r!==y.IDLE&&r!==y.LOADING)return;e++;const i=At(t,W.CHANGE,function(){const s=t.getState();(s==y.LOADED||s==y.ERROR||s==y.EMPTY)&&(Be(i),e--,e===0&&(this.unlistenSources_(),this.reproject_()))},this);this.sourcesListenerKeys_.push(i)}),e===0?setTimeout(this.reproject_.bind(this),0):this.sourceTiles_.forEach(function(t){t.getState()==y.IDLE&&t.load()})}unlistenSources_(){this.sourcesListenerKeys_.forEach(Be),this.sourcesListenerKeys_=null}}const Se=nr;class ir extends Yt{constructor(e){const t=e.projection===void 0?"EPSG:3857":e.projection;let r=e.tileGrid;r===void 0&&t&&(r=Wt({extent:Kt(t),maxResolution:e.maxResolution,maxZoom:e.maxZoom,minZoom:e.minZoom,tileSize:e.tileSize})),super({cacheSize:.1,attributions:e.attributions,attributionsCollapsible:e.attributionsCollapsible,projection:t,tileGrid:r,opaque:e.opaque,state:e.state,wrapX:e.wrapX,transition:e.transition,interpolate:e.interpolate}),this.gutter_=e.gutter!==void 0?e.gutter:0,this.tileSize_=e.tileSize?V(e.tileSize):null,this.tileSizes_=null,this.tileLoadingKeys_={},this.loader_=e.loader,this.handleTileChange_=this.handleTileChange_.bind(this),this.bandCount=e.bandCount===void 0?4:e.bandCount,this.tileGridForProjection_={},this.tileCacheForProjection_={}}setTileSizes(e){this.tileSizes_=e}getTileSize(e){if(this.tileSizes_)return this.tileSizes_[e];if(this.tileSize_)return this.tileSize_;const t=this.getTileGrid();return t?V(t.getTileSize(e)):[256,256]}getGutterForProjection(e){const t=this.getProjection();return!t||re(t,e)?this.gutter_:0}setLoader(e){this.loader_=e}getReprojTile_(e,t,r,i,s){const o=this.getTileCacheForProjection(i),a=je(e,t,r);if(o.containsKey(a)){const p=o.get(a);if(p&&p.key==this.getKey())return p}const u=this.getTileGrid(),l=Math.max.apply(null,u.getResolutions().map((p,S)=>{const R=V(u.getTileSize(S)),x=this.getTileSize(S);return Math.max(x[0]/R[0],x[1]/R[1])})),h=this.getTileGridForProjection(s),c=this.getTileGridForProjection(i),T=[e,t,r],_=this.getTileCoordForTileUrlFunction(T,i),m=Object.assign({sourceProj:s,sourceTileGrid:h,targetProj:i,targetTileGrid:c,tileCoord:T,wrappedTileCoord:_,pixelRatio:l,gutter:this.getGutterForProjection(s),getTileFunction:(p,S,R,x)=>this.getTile(p,S,R,x,s)},this.tileOptions),b=new Se(m);return b.key=this.getKey(),b}getTile(e,t,r,i,s){const o=this.getProjection();if(o&&s&&!re(o,s))return this.getReprojTile_(e,t,r,s,o);const a=this.getTileSize(e),u=je(e,t,r);if(this.tileCache.containsKey(u))return this.tileCache.get(u);const l=this.loader_;function h(){return Lt(function(){return l(e,t,r)})}const c=Object.assign({tileCoord:[e,t,r],loader:h,size:a},this.tileOptions),T=new Ce(c);return T.key=this.getKey(),T.addEventListener(W.CHANGE,this.handleTileChange_),this.tileCache.set(u,T),T}handleTileChange_(e){const t=e.target,r=M(t),i=t.getState();let s;i==y.LOADING?(this.tileLoadingKeys_[r]=!0,s=_e.TILELOADSTART):r in this.tileLoadingKeys_&&(delete this.tileLoadingKeys_[r],s=i==y.ERROR?_e.TILELOADERROR:i==y.LOADED?_e.TILELOADEND:void 0),s&&this.dispatchEvent(new Vt(s,t))}getTileGridForProjection(e){const t=this.getProjection();if(this.tileGrid&&(!t||re(t,e)))return this.tileGrid;const r=M(e);return r in this.tileGridForProjection_||(this.tileGridForProjection_[r]=Zt(e)),this.tileGridForProjection_[r]}setTileGridForProjection(e,t){const r=St(e);if(r){const i=M(r);i in this.tileGridForProjection_||(this.tileGridForProjection_[i]=t)}}getTileCacheForProjection(e){const t=this.getProjection();if(!t||re(t,e))return this.tileCache;const r=M(e);return r in this.tileCacheForProjection_||(this.tileCacheForProjection_[r]=new kt(.1)),this.tileCacheForProjection_[r]}expireCache(e,t){const r=this.getTileCacheForProjection(e);this.tileCache.expireCache(this.tileCache==r?t:{});for(const i in this.tileCacheForProjection_){const s=this.tileCacheForProjection_[i];s.expireCache(s==r?t:{})}}clear(){super.clear();for(const e in this.tileCacheForProjection_)this.tileCacheForProjection_[e].clear()}}const Xr=ir,be=34962,Ue=34963,sr=35040,Ne=35044,or=35048,ar=5121,lr=5123,cr=5125,it=5126,We=["experimental-webgl","webgl","webkit-3d","moz-webgl"];function st(n,e){e=Object.assign({preserveDrawingBuffer:!0,antialias:!Ct},e);const t=We.length;for(let r=0;r<t;++r)try{const i=n.getContext(We[r],e);if(i)return i}catch{}return null}const ur={STATIC_DRAW:Ne,STREAM_DRAW:sr,DYNAMIC_DRAW:or};class hr{constructor(e,t){this.array=null,this.type=e,bt(e===be||e===Ue,62),this.usage=t!==void 0?t:ur.STATIC_DRAW}ofSize(e){this.array=new(Ee(this.type))(e)}fromArray(e){this.array=Ee(this.type).from(e)}fromArrayBuffer(e){this.array=new(Ee(this.type))(e)}getType(){return this.type}getArray(){return this.array}getUsage(){return this.usage}getSize(){return this.array?this.array.length:0}}function Ee(n){switch(n){case be:return Float32Array;case Ue:return Uint32Array;default:return Float32Array}}const ot=hr;function at(n,e,t){const r=t?n.LINEAR:n.NEAREST;n.bindTexture(n.TEXTURE_2D,e),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_S,n.CLAMP_TO_EDGE),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_T,n.CLAMP_TO_EDGE),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MIN_FILTER,r),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MAG_FILTER,r)}function fr(n,e,t,r){at(n,e,r),n.texImage2D(n.TEXTURE_2D,0,n.RGBA,n.RGBA,n.UNSIGNED_BYTE,t)}function Ke(n,e,t,r,i,s){const o=n.getGL();let a,u;t instanceof Float32Array?(a=o.FLOAT,n.getExtension("OES_texture_float"),u=n.getExtension("OES_texture_float_linear")!==null):(a=o.UNSIGNED_BYTE,u=!0),at(o,e,s&&u);const l=t.byteLength/r[1];let h=1;l%8===0?h=8:l%4===0?h=4:l%2===0&&(h=2);let c;switch(i){case 1:{c=o.LUMINANCE;break}case 2:{c=o.LUMINANCE_ALPHA;break}case 3:{c=o.RGB;break}case 4:{c=o.RGBA;break}default:throw new Error(`Unsupported number of bands: ${i}`)}const T=o.getParameter(o.UNPACK_ALIGNMENT);o.pixelStorei(o.UNPACK_ALIGNMENT,h),o.texImage2D(o.TEXTURE_2D,0,c,r[0],r[1],0,c,a,t),o.pixelStorei(o.UNPACK_ALIGNMENT,T)}let Y=null;function dr(){Y=Le(1,1,void 0,{willReadFrequently:!0})}class Tr extends Ut{constructor(e){super(),this.tile,this.textures=[],this.handleTileChange_=this.handleTileChange_.bind(this),this.renderSize_=V(e.grid.getTileSize(e.tile.tileCoord[0])),this.gutter_=e.gutter||0,this.bandCount=NaN,this.helper_=e.helper;const t=new ot(be,Ne);t.fromArray([0,1,1,1,1,0,0,0]),this.helper_.flushBufferData(t),this.coords=t,this.setTile(e.tile)}setTile(e){if(e!==this.tile)if(this.tile&&this.tile.removeEventListener(W.CHANGE,this.handleTileChange_),this.tile=e,this.textures.length=0,this.loaded=e.getState()===y.LOADED,this.loaded)this.uploadTile_();else{if(e instanceof He){const t=e.getImage();t instanceof Image&&!t.crossOrigin&&(t.crossOrigin="anonymous")}e.addEventListener(W.CHANGE,this.handleTileChange_)}}uploadTile_(){const e=this.helper_,t=e.getGL(),r=this.tile;let i;r instanceof He||r instanceof xe?i=r.getImage():i=r.getData();const s=le(i);if(s){const R=t.createTexture();this.textures.push(R),this.bandCount=4,fr(t,R,s,r.interpolate);return}i=Ae(i);const o=r.getSize(),a=[o[0]+2*this.gutter_,o[1]+2*this.gutter_],u=i instanceof Float32Array,l=a[0]*a[1],h=u?Float32Array:Uint8Array,c=h.BYTES_PER_ELEMENT,T=i.byteLength/a[1];this.bandCount=Math.floor(T/c/a[0]);const _=Math.ceil(this.bandCount/4);if(_===1){const R=t.createTexture();this.textures.push(R),Ke(e,R,i,a,this.bandCount,r.interpolate);return}const m=new Array(_);for(let R=0;R<_;++R){const x=t.createTexture();this.textures.push(x);const A=R<_-1?4:(this.bandCount-1)%4+1;m[R]=new h(l*A)}let b=0,p=0;const S=a[0]*this.bandCount;for(let R=0;R<a[1];++R){for(let x=0;x<S;++x){const A=i[p+x],v=Math.floor(b/this.bandCount),P=x%this.bandCount,L=Math.floor(P/4),C=m[L],I=C.length/l,O=P%4;C[v*I+O]=A,++b}p+=T/c}for(let R=0;R<_;++R){const x=this.textures[R],A=m[R],v=A.length/l;Ke(e,x,A,a,v,r.interpolate)}}handleTileChange_(){this.tile.getState()===y.LOADED&&(this.loaded=!0,this.uploadTile_(),this.dispatchEvent(W.CHANGE))}disposeInternal(){const e=this.helper_.getGL();this.helper_.deleteBuffer(this.coords);for(let t=0;t<this.textures.length;++t)e.deleteTexture(this.textures[t]);this.tile.removeEventListener(W.CHANGE,this.handleTileChange_)}getImagePixelData_(e,t,r){const i=this.gutter_,s=this.renderSize_[0],o=this.renderSize_[1];Y||dr(),Y.clearRect(0,0,1,1);const a=e.width,u=e.height,l=a-2*i,h=u-2*i,c=i+Math.floor(l*(t/s)),T=i+Math.floor(h*(r/o));let _;try{Y.drawImage(e,c,T,1,1,0,0,1,1),_=Y.getImageData(0,0,1,1).data}catch{return Y=null,null}return _}getArrayPixelData_(e,t,r,i){const s=this.gutter_,o=this.renderSize_[0],a=this.renderSize_[1],u=t[0],l=t[1],h=u+2*s,c=l+2*s,T=s+Math.floor(u*(r/o)),_=s+Math.floor(l*(i/a));if(e instanceof DataView){const b=e.byteLength/(h*c),p=b*(_*h+T),S=e.buffer.slice(p,p+b);return new DataView(S)}const m=this.bandCount*(_*h+T);return e.slice(m,m+this.bandCount)}getPixelData(e,t){if(!this.loaded)return null;if(this.tile instanceof Ce){const r=this.tile.getData(),i=Ae(r);if(i){const s=this.tile.getSize();return this.getArrayPixelData_(i,s,e,t)}return this.getImagePixelData_(le(r),e,t)}return this.getImagePixelData_(this.tile.getImage(),e,t)}}const _r=Tr,ne={LOST:"webglcontextlost",RESTORED:"webglcontextrestored"},Er=`
  precision mediump float;
  
  attribute vec2 a_position;
  varying vec2 v_texCoord;
  varying vec2 v_screenCoord;
  
  uniform vec2 u_screenSize;
   
  void main() {
    v_texCoord = a_position * 0.5 + 0.5;
    v_screenCoord = v_texCoord * u_screenSize;
    gl_Position = vec4(a_position, 0.0, 1.0);
  }
`,gr=`
  precision mediump float;
   
  uniform sampler2D u_image;
  uniform float u_opacity;
   
  varying vec2 v_texCoord;
   
  void main() {
    gl_FragColor = texture2D(u_image, v_texCoord) * u_opacity;
  }
`;class Rr{constructor(e){this.gl_=e.webGlContext;const t=this.gl_;this.scaleRatio_=e.scaleRatio||1,this.renderTargetTexture_=t.createTexture(),this.renderTargetTextureSize_=null,this.frameBuffer_=t.createFramebuffer();const r=t.createShader(t.VERTEX_SHADER);t.shaderSource(r,e.vertexShader||Er),t.compileShader(r);const i=t.createShader(t.FRAGMENT_SHADER);t.shaderSource(i,e.fragmentShader||gr),t.compileShader(i),this.renderTargetProgram_=t.createProgram(),t.attachShader(this.renderTargetProgram_,r),t.attachShader(this.renderTargetProgram_,i),t.linkProgram(this.renderTargetProgram_),this.renderTargetVerticesBuffer_=t.createBuffer();const s=[-1,-1,1,-1,-1,1,1,-1,1,1,-1,1];t.bindBuffer(t.ARRAY_BUFFER,this.renderTargetVerticesBuffer_),t.bufferData(t.ARRAY_BUFFER,new Float32Array(s),t.STATIC_DRAW),this.renderTargetAttribLocation_=t.getAttribLocation(this.renderTargetProgram_,"a_position"),this.renderTargetUniformLocation_=t.getUniformLocation(this.renderTargetProgram_,"u_screenSize"),this.renderTargetOpacityLocation_=t.getUniformLocation(this.renderTargetProgram_,"u_opacity"),this.renderTargetTextureLocation_=t.getUniformLocation(this.renderTargetProgram_,"u_image"),this.uniforms_=[],e.uniforms&&Object.keys(e.uniforms).forEach(o=>{this.uniforms_.push({value:e.uniforms[o],location:t.getUniformLocation(this.renderTargetProgram_,o)})})}getGL(){return this.gl_}init(e){const t=this.getGL(),r=[t.drawingBufferWidth*this.scaleRatio_,t.drawingBufferHeight*this.scaleRatio_];if(t.bindFramebuffer(t.FRAMEBUFFER,this.getFrameBuffer()),t.viewport(0,0,r[0],r[1]),!this.renderTargetTextureSize_||this.renderTargetTextureSize_[0]!==r[0]||this.renderTargetTextureSize_[1]!==r[1]){this.renderTargetTextureSize_=r;const i=0,s=t.RGBA,o=0,a=t.RGBA,u=t.UNSIGNED_BYTE,l=null;t.bindTexture(t.TEXTURE_2D,this.renderTargetTexture_),t.texImage2D(t.TEXTURE_2D,i,s,r[0],r[1],o,a,u,l),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,this.renderTargetTexture_,0)}}apply(e,t,r,i){const s=this.getGL(),o=e.size;if(s.bindFramebuffer(s.FRAMEBUFFER,t?t.getFrameBuffer():null),s.activeTexture(s.TEXTURE0),s.bindTexture(s.TEXTURE_2D,this.renderTargetTexture_),!t){const u=M(s.canvas);if(!e.renderTargets[u]){const l=s.getContextAttributes();l&&l.preserveDrawingBuffer&&(s.clearColor(0,0,0,0),s.clear(s.COLOR_BUFFER_BIT)),e.renderTargets[u]=!0}}s.enable(s.BLEND),s.blendFunc(s.ONE,s.ONE_MINUS_SRC_ALPHA),s.viewport(0,0,s.drawingBufferWidth,s.drawingBufferHeight),s.bindBuffer(s.ARRAY_BUFFER,this.renderTargetVerticesBuffer_),s.useProgram(this.renderTargetProgram_),s.enableVertexAttribArray(this.renderTargetAttribLocation_),s.vertexAttribPointer(this.renderTargetAttribLocation_,2,s.FLOAT,!1,0,0),s.uniform2f(this.renderTargetUniformLocation_,o[0],o[1]),s.uniform1i(this.renderTargetTextureLocation_,0);const a=e.layerStatesArray[e.layerIndex].opacity;s.uniform1f(this.renderTargetOpacityLocation_,a),this.applyUniforms(e),r&&r(s,e),s.drawArrays(s.TRIANGLES,0,6),i&&i(s,e)}getFrameBuffer(){return this.frameBuffer_}applyUniforms(e){const t=this.getGL();let r,i=1;this.uniforms_.forEach(function(s){if(r=typeof s.value=="function"?s.value(e):s.value,r instanceof HTMLCanvasElement||r instanceof ImageData)s.texture||(s.texture=t.createTexture()),t.activeTexture(t[`TEXTURE${i}`]),t.bindTexture(t.TEXTURE_2D,s.texture),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),r instanceof ImageData?t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,r.width,r.height,0,t.UNSIGNED_BYTE,new Uint8Array(r.data)):t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,r),t.uniform1i(s.location,i++);else if(Array.isArray(r))switch(r.length){case 2:t.uniform2f(s.location,r[0],r[1]);return;case 3:t.uniform3f(s.location,r[0],r[1],r[2]);return;case 4:t.uniform4f(s.location,r[0],r[1],r[2],r[3]);return;default:return}else typeof r=="number"&&t.uniform1f(s.location,r)})}}const Ve=Rr;function lt(){return[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]}function se(n,e){return n[0]=e[0],n[1]=e[1],n[4]=e[2],n[5]=e[3],n[12]=e[4],n[13]=e[5],n}const j={PROJECTION_MATRIX:"u_projectionMatrix",OFFSET_SCALE_MATRIX:"u_offsetScaleMatrix",OFFSET_ROTATION_MATRIX:"u_offsetRotateMatrix",TIME:"u_time",ZOOM:"u_zoom",RESOLUTION:"u_resolution",SIZE_PX:"u_sizePx",PIXEL_RATIO:"u_pixelRatio"},J={UNSIGNED_BYTE:ar,UNSIGNED_SHORT:lr,UNSIGNED_INT:cr,FLOAT:it},ce={};function Ze(n){return"shared/"+n}let ke=0;function pr(){const n="unique/"+ke;return ke+=1,n}function mr(n){let e=ce[n];if(!e){const t=document.createElement("canvas");t.style.position="absolute",t.style.left="0",e={users:0,canvas:t},ce[n]=e}return e.users+=1,e.canvas}function xr(n){const e=ce[n];if(!e||(e.users-=1,e.users>0))return;const t=e.canvas,i=st(t).getExtension("WEBGL_lose_context");i&&i.loseContext(),delete ce[n]}class yr extends Nt{constructor(e){super(),e=e||{},this.boundHandleWebGLContextLost_=this.handleWebGLContextLost.bind(this),this.boundHandleWebGLContextRestored_=this.handleWebGLContextRestored.bind(this),this.canvasCacheKey_=e.canvasCacheKey?Ze(e.canvasCacheKey):pr(),this.canvas_=mr(this.canvasCacheKey_),this.gl_=st(this.canvas_),this.bufferCache_={},this.extensionCache_={},this.currentProgram_=null,this.canvas_.addEventListener(ne.LOST,this.boundHandleWebGLContextLost_),this.canvas_.addEventListener(ne.RESTORED,this.boundHandleWebGLContextRestored_),this.offsetRotateMatrix_=ae(),this.offsetScaleMatrix_=ae(),this.tmpMat4_=lt(),this.uniformLocations_={},this.attribLocations_={},this.uniforms_=[],e.uniforms&&this.setUniforms(e.uniforms);const t=this.getGL();this.postProcessPasses_=e.postProcesses?e.postProcesses.map(function(r){return new Ve({webGlContext:t,scaleRatio:r.scaleRatio,vertexShader:r.vertexShader,fragmentShader:r.fragmentShader,uniforms:r.uniforms})}):[new Ve({webGlContext:t})],this.shaderCompileErrors_=null,this.startTime_=Date.now()}setUniforms(e){this.uniforms_=[];for(const t in e)this.uniforms_.push({name:t,value:e[t]});this.uniformLocations_={}}canvasCacheKeyMatches(e){return this.canvasCacheKey_===Ze(e)}getExtension(e){if(e in this.extensionCache_)return this.extensionCache_[e];const t=this.gl_.getExtension(e);return this.extensionCache_[e]=t,t}bindBuffer(e){const t=this.getGL(),r=M(e);let i=this.bufferCache_[r];if(!i){const s=t.createBuffer();i={buffer:e,webGlBuffer:s},this.bufferCache_[r]=i}t.bindBuffer(e.getType(),i.webGlBuffer)}flushBufferData(e){const t=this.getGL();this.bindBuffer(e),t.bufferData(e.getType(),e.getArray(),e.getUsage())}deleteBuffer(e){const t=this.getGL(),r=M(e),i=this.bufferCache_[r];i&&!t.isContextLost()&&t.deleteBuffer(i.webGlBuffer),delete this.bufferCache_[r]}disposeInternal(){this.canvas_.removeEventListener(ne.LOST,this.boundHandleWebGLContextLost_),this.canvas_.removeEventListener(ne.RESTORED,this.boundHandleWebGLContextRestored_),xr(this.canvasCacheKey_),delete this.gl_,delete this.canvas_}prepareDraw(e,t){const r=this.getGL(),i=this.getCanvas(),s=e.size,o=e.pixelRatio;i.width=s[0]*o,i.height=s[1]*o,i.style.width=s[0]+"px",i.style.height=s[1]+"px";for(let a=this.postProcessPasses_.length-1;a>=0;a--)this.postProcessPasses_[a].init(e);r.bindTexture(r.TEXTURE_2D,null),r.clearColor(0,0,0,0),r.clear(r.COLOR_BUFFER_BIT),r.enable(r.BLEND),r.blendFunc(r.ONE,t?r.ZERO:r.ONE_MINUS_SRC_ALPHA)}prepareDrawToRenderTarget(e,t,r){const i=this.getGL(),s=t.getSize();i.bindFramebuffer(i.FRAMEBUFFER,t.getFramebuffer()),i.viewport(0,0,s[0],s[1]),i.bindTexture(i.TEXTURE_2D,t.getTexture()),i.clearColor(0,0,0,0),i.clear(i.COLOR_BUFFER_BIT),i.enable(i.BLEND),i.blendFunc(i.ONE,r?i.ZERO:i.ONE_MINUS_SRC_ALPHA)}drawElements(e,t){const r=this.getGL();this.getExtension("OES_element_index_uint");const i=r.UNSIGNED_INT,s=4,o=t-e,a=e*s;r.drawElements(r.TRIANGLES,o,i,a)}finalizeDraw(e,t,r){for(let i=0,s=this.postProcessPasses_.length;i<s;i++)i===s-1?this.postProcessPasses_[i].apply(e,null,t,r):this.postProcessPasses_[i].apply(e,this.postProcessPasses_[i+1])}getCanvas(){return this.canvas_}getGL(){return this.gl_}applyFrameState(e){const t=e.size,r=e.viewState.rotation,i=e.pixelRatio,s=ie(this.offsetScaleMatrix_);me(s,2/t[0],2/t[1]);const o=ie(this.offsetRotateMatrix_);r!==0&&et(o,-r),this.setUniformMatrixValue(j.OFFSET_SCALE_MATRIX,se(this.tmpMat4_,s)),this.setUniformMatrixValue(j.OFFSET_ROTATION_MATRIX,se(this.tmpMat4_,o)),this.setUniformFloatValue(j.TIME,(Date.now()-this.startTime_)*.001),this.setUniformFloatValue(j.ZOOM,e.viewState.zoom),this.setUniformFloatValue(j.RESOLUTION,e.viewState.resolution),this.setUniformFloatValue(j.PIXEL_RATIO,i),this.setUniformFloatVec2(j.SIZE_PX,[t[0],t[1]])}applyUniforms(e){const t=this.getGL();let r,i=0;this.uniforms_.forEach(s=>{if(r=typeof s.value=="function"?s.value(e):s.value,r instanceof HTMLCanvasElement||r instanceof HTMLImageElement||r instanceof ImageData)s.texture||(s.prevValue=void 0,s.texture=t.createTexture()),t.activeTexture(t[`TEXTURE${i}`]),t.bindTexture(t.TEXTURE_2D,s.texture),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),(!(r instanceof HTMLImageElement)||r.complete)&&s.prevValue!==r&&(s.prevValue=r,t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,r)),t.uniform1i(this.getUniformLocation(s.name),i++);else if(Array.isArray(r)&&r.length===6)this.setUniformMatrixValue(s.name,se(this.tmpMat4_,r));else if(Array.isArray(r)&&r.length<=4)switch(r.length){case 2:t.uniform2f(this.getUniformLocation(s.name),r[0],r[1]);return;case 3:t.uniform3f(this.getUniformLocation(s.name),r[0],r[1],r[2]);return;case 4:t.uniform4f(this.getUniformLocation(s.name),r[0],r[1],r[2],r[3]);return;default:return}else typeof r=="number"&&t.uniform1f(this.getUniformLocation(s.name),r)})}useProgram(e,t){this.getGL().useProgram(e),this.currentProgram_=e,this.uniformLocations_={},this.attribLocations_={},this.applyFrameState(t),this.applyUniforms(t)}compileShader(e,t){const r=this.getGL(),i=r.createShader(t);return r.shaderSource(i,e),r.compileShader(i),i}getProgram(e,t){const r=this.getGL(),i=this.compileShader(e,r.FRAGMENT_SHADER),s=this.compileShader(t,r.VERTEX_SHADER),o=r.createProgram();if(r.attachShader(o,i),r.attachShader(o,s),r.linkProgram(o),!r.getShaderParameter(i,r.COMPILE_STATUS)){const a=`Fragment shader compilation failed: ${r.getShaderInfoLog(i)}`;throw new Error(a)}if(r.deleteShader(i),!r.getShaderParameter(s,r.COMPILE_STATUS)){const a=`Vertex shader compilation failed: ${r.getShaderInfoLog(s)}`;throw new Error(a)}if(r.deleteShader(s),!r.getProgramParameter(o,r.LINK_STATUS)){const a=`GL program linking failed: ${r.getShaderInfoLog(s)}`;throw new Error(a)}return o}getUniformLocation(e){return this.uniformLocations_[e]===void 0&&(this.uniformLocations_[e]=this.getGL().getUniformLocation(this.currentProgram_,e)),this.uniformLocations_[e]}getAttributeLocation(e){return this.attribLocations_[e]===void 0&&(this.attribLocations_[e]=this.getGL().getAttribLocation(this.currentProgram_,e)),this.attribLocations_[e]}makeProjectionTransform(e,t){const r=e.size,i=e.viewState.rotation,s=e.viewState.resolution,o=e.viewState.center;return ie(t),tt(t,0,0,2/(s*r[0]),2/(s*r[1]),-i,-o[0],-o[1]),t}setUniformFloatValue(e,t){this.getGL().uniform1f(this.getUniformLocation(e),t)}setUniformFloatVec2(e,t){this.getGL().uniform2fv(this.getUniformLocation(e),t)}setUniformFloatVec4(e,t){this.getGL().uniform4fv(this.getUniformLocation(e),t)}setUniformMatrixValue(e,t){this.getGL().uniformMatrix4fv(this.getUniformLocation(e),!1,t)}enableAttributeArray_(e,t,r,i,s){const o=this.getAttributeLocation(e);o<0||(this.getGL().enableVertexAttribArray(o),this.getGL().vertexAttribPointer(o,t,r,!1,i,s))}enableAttributes(e){const t=Ar(e);let r=0;for(let i=0;i<e.length;i++){const s=e[i];this.enableAttributeArray_(s.name,s.size,s.type||it,t,r),r+=s.size*ct(s.type)}}handleWebGLContextLost(){vt(this.bufferCache_),this.currentProgram_=null}handleWebGLContextRestored(){}createTexture(e,t,r){const i=this.getGL();r=r||i.createTexture();const s=0,o=i.RGBA,a=0,u=i.RGBA,l=i.UNSIGNED_BYTE;return i.bindTexture(i.TEXTURE_2D,r),t?i.texImage2D(i.TEXTURE_2D,s,o,u,l,t):i.texImage2D(i.TEXTURE_2D,s,o,e[0],e[1],a,u,l,null),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MIN_FILTER,i.LINEAR),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_S,i.CLAMP_TO_EDGE),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_T,i.CLAMP_TO_EDGE),r}}function Ar(n){let e=0;for(let t=0;t<n.length;t++){const r=n[t];e+=r.size*ct(r.type)}return e}function ct(n){switch(n){case J.UNSIGNED_BYTE:return Uint8Array.BYTES_PER_ELEMENT;case J.UNSIGNED_SHORT:return Uint16Array.BYTES_PER_ELEMENT;case J.UNSIGNED_INT:return Uint32Array.BYTES_PER_ELEMENT;case J.FLOAT:default:return Float32Array.BYTES_PER_ELEMENT}}class ve extends Pt{constructor(e,t){super(e),t=t||{},this.inversePixelTransform_=ae(),this.pixelContext_=null,this.postProcesses_=t.postProcesses,this.uniforms_=t.uniforms,this.helper,e.addChangeListener(rt.MAP,this.removeHelper.bind(this)),this.dispatchPreComposeEvent=this.dispatchPreComposeEvent.bind(this),this.dispatchPostComposeEvent=this.dispatchPostComposeEvent.bind(this)}dispatchPreComposeEvent(e,t){const r=this.getLayer();if(r.hasListener(H.PRECOMPOSE)){const i=new de(H.PRECOMPOSE,void 0,t,e);r.dispatchEvent(i)}}dispatchPostComposeEvent(e,t){const r=this.getLayer();if(r.hasListener(H.POSTCOMPOSE)){const i=new de(H.POSTCOMPOSE,void 0,t,e);r.dispatchEvent(i)}}reset(e){this.uniforms_=e.uniforms,this.helper&&this.helper.setUniforms(this.uniforms_)}removeHelper(){this.helper&&(this.helper.dispose(),delete this.helper)}prepareFrame(e){if(this.getLayer().getRenderSource()){let t=!0,r=-1,i;for(let o=0,a=e.layerStatesArray.length;o<a;o++){const u=e.layerStatesArray[o].layer,l=u.getRenderer();if(!(l instanceof ve)){t=!0;continue}const h=u.getClassName();if((t||h!==i)&&(r+=1,t=!1),i=h,l===this)break}const s="map/"+e.mapId+"/group/"+r;(!this.helper||!this.helper.canvasCacheKeyMatches(s))&&(this.removeHelper(),this.helper=new yr({postProcesses:this.postProcesses_,uniforms:this.uniforms_,canvasCacheKey:s}),i&&(this.helper.getCanvas().className=i),this.afterHelperCreated())}return this.prepareFrameInternal(e)}afterHelperCreated(){}prepareFrameInternal(e){return!0}disposeInternal(){this.removeHelper(),super.disposeInternal()}dispatchRenderEvent_(e,t,r){const i=this.getLayer();if(i.hasListener(e)){tt(this.inversePixelTransform_,0,0,r.pixelRatio,-r.pixelRatio,0,0,-r.size[1]);const s=new de(e,this.inversePixelTransform_,r,t);i.dispatchEvent(s)}}preRender(e,t){this.dispatchRenderEvent_(H.PRERENDER,e,t)}postRender(e,t){this.dispatchRenderEvent_(H.POSTRENDER,e,t)}}const Sr=ve,E={TILE_TEXTURE_ARRAY:"u_tileTextures",TILE_TRANSFORM:"u_tileTransform",TRANSITION_ALPHA:"u_transitionAlpha",DEPTH:"u_depth",TEXTURE_PIXEL_WIDTH:"u_texturePixelWidth",TEXTURE_PIXEL_HEIGHT:"u_texturePixelHeight",TEXTURE_RESOLUTION:"u_textureResolution",TEXTURE_ORIGIN_X:"u_textureOriginX",TEXTURE_ORIGIN_Y:"u_textureOriginY",RENDER_EXTENT:"u_renderExtent",RESOLUTION:"u_resolution",ZOOM:"u_zoom"},oe={TEXTURE_COORD:"a_textureCoord"},Lr=[{name:oe.TEXTURE_COORD,size:2,type:J.FLOAT}],Cr={};function br(n){return 2*(1-1/(n+1))-1}function Ur(){return{tileIds:new Set,texturesByZ:{}}}function qe(n,e){return n.tileIds.has(M(e))}function Je(n,e,t){const r=n.texturesByZ;t in r||(r[t]=new Set),r[t].add(e),n.tileIds.add(M(e.tile))}function ge(n,e){const t=n.layerStatesArray[n.layerIndex];t.extent&&(e=K(e,nt(t.extent,n.viewState.projection)));const r=t.layer.getRenderSource();if(!r.getWrapX()){const i=r.getTileGridForProjection(n.viewState.projection).getExtent();i&&(e=K(e,i))}return e}function Re(n,e){return`${n.getKey()},${ye(e)}`}class Nr extends Sr{constructor(e,t){super(e,{uniforms:t.uniforms}),this.renderComplete=!1,this.tileTransform_=ae(),this.tempMat4_=lt(),this.tempTileRange_=new qt(0,0,0,0),this.tempTileCoord_=Ye(0,0,0),this.tempSize_=[0,0],this.program_,this.vertexShader_=t.vertexShader,this.fragmentShader_=t.fragmentShader,this.indices_=new ot(Ue,Ne),this.indices_.fromArray([0,1,3,1,2,3]);const r=t.cacheSize!==void 0?t.cacheSize:512;this.tileTextureCache_=new Jt(r),this.paletteTextures_=t.paletteTextures||[],this.frameState_=null,this.projection_=void 0}reset(e){super.reset({uniforms:e.uniforms}),this.vertexShader_=e.vertexShader,this.fragmentShader_=e.fragmentShader,this.paletteTextures_=e.paletteTextures||[],this.helper&&(this.program_=this.helper.getProgram(this.fragmentShader_,this.vertexShader_))}afterHelperCreated(){this.program_=this.helper.getProgram(this.fragmentShader_,this.vertexShader_),this.helper.flushBufferData(this.indices_)}isDrawableTile_(e){const t=this.getLayer(),r=e.getState(),i=t.getUseInterimTilesOnError();return r==y.LOADED||r==y.EMPTY||r==y.ERROR&&!i}prepareFrameInternal(e){this.projection_?e.viewState.projection!==this.projection_&&(this.clearCache(),this.projection_=e.viewState.projection):this.projection_=e.viewState.projection;const r=this.getLayer().getRenderSource();return!r||It(ge(e,e.extent))?!1:r.getState()==="ready"}enqueueTiles(e,t,r,i,s){const o=e.viewState,a=this.getLayer(),u=a.getRenderSource(),l=u.getTileGridForProjection(o.projection),h=u.getGutterForProjection(o.projection),c=M(u);c in e.wantedTiles||(e.wantedTiles[c]={});const T=e.wantedTiles[c],_=this.tileTextureCache_,m=a.getMapInternal(),b=Math.max(r-s,l.getMinZoom(),l.getZForResolution(Math.min(a.getMaxResolution(),m?m.getView().getResolutionForZoom(Math.max(a.getMinZoom(),0)):l.getResolution(0)),u.zDirection));for(let p=r;p>=b;--p){const S=l.getTileRangeForExtentAndZ(t,p,this.tempTileRange_),R=l.getResolution(p);for(let x=S.minX;x<=S.maxX;++x)for(let A=S.minY;A<=S.maxY;++A){const v=Ye(p,x,A,this.tempTileCoord_),P=Re(u,v);let L,C;if(_.containsKey(P)&&(L=_.get(P),C=L.tile),(!L||L.tile.key!==u.getKey())&&(C=u.getTile(p,x,A,e.pixelRatio,o.projection)),qe(i,C))continue;if(!L)L=new _r({tile:C,grid:l,helper:this.helper,gutter:h}),_.set(P,L);else if(this.isDrawableTile_(C))L.setTile(C);else{const O=C.getInterimTile();L.setTile(O)}Je(i,L,p);const I=C.getKey();T[I]=!0,C.getState()===y.IDLE&&(e.tileQueue.isKeyQueued(I)||e.tileQueue.enqueue([C,c,l.getTileCoordCenter(v),R]))}}}renderFrame(e){this.frameState_=e,this.renderComplete=!0;const t=this.helper.getGL();this.preRender(t,e);const r=e.viewState,i=this.getLayer(),s=i.getRenderSource(),o=s.getTileGridForProjection(r.projection),a=s.getGutterForProjection(r.projection),u=ge(e,e.extent),l=o.getZForResolution(r.resolution,s.zDirection),h=Ur(),c=i.getPreload();if(e.nextExtent){const L=o.getZForResolution(r.nextResolution,s.zDirection),C=ge(e,e.nextExtent);this.enqueueTiles(e,C,L,h,c)}this.enqueueTiles(e,u,l,h,0),c>0&&setTimeout(()=>{this.enqueueTiles(e,u,l-1,h,c-1)},0);const T={},_=M(this),m=e.time;let b=!1;for(const L of h.texturesByZ[l]){const C=L.tile;if((C instanceof xe||C instanceof Se)&&C.getState()===y.EMPTY)continue;const I=C.tileCoord;if(L.loaded){const D=C.getAlpha(_,m);if(D===1){C.endTransition(_);continue}b=!0;const w=ye(I);T[w]=D}if(this.renderComplete=!1,this.findAltTiles_(o,I,l+1,h))continue;const G=o.getMinZoom();for(let D=l-1;D>=G&&!this.findAltTiles_(o,I,D,h);--D);}this.helper.useProgram(this.program_,e),this.helper.prepareDraw(e,!b);const p=h.texturesByZ,S=Object.keys(p).map(Number).sort(Ot),R=r.center[0],x=r.center[1];for(let L=0,C=S.length;L<C;++L){const I=S[L],O=o.getResolution(I),G=V(o.getTileSize(I),this.tempSize_),D=o.getOrigin(I),w=G[0]+2*a,X=G[1]+2*a,z=w/X,fe=(R-D[0])/(G[0]*O),mt=(D[1]-x)/(G[1]*O),Oe=r.resolution/O,xt=br(I);for(const Z of p[I]){if(!Z.loaded)continue;const Q=Z.tile.tileCoord,Ge=ye(Q),De=Q[1],we=Q[2];ie(this.tileTransform_),me(this.tileTransform_,2/(e.size[0]*Oe/w),-2/(e.size[1]*Oe/w)),et(this.tileTransform_,r.rotation),me(this.tileTransform_,1,1/z),Gt(this.tileTransform_,(G[0]*(De-fe)-a)/w,(G[1]*(we-mt)-a)/X),this.helper.setUniformMatrixValue(E.TILE_TRANSFORM,se(this.tempMat4_,this.tileTransform_)),this.helper.bindBuffer(Z.coords),this.helper.bindBuffer(this.indices_),this.helper.enableAttributes(Lr);let B=0;for(;B<Z.textures.length;){const k="TEXTURE"+B,te=`${E.TILE_TEXTURE_ARRAY}[${B}]`;t.activeTexture(t[k]),t.bindTexture(t.TEXTURE_2D,Z.textures[B]),t.uniform1i(this.helper.getUniformLocation(te),B),++B}for(let k=0;k<this.paletteTextures_.length;++k){const te=this.paletteTextures_[k];t.activeTexture(t["TEXTURE"+B]);const yt=te.getTexture(t);t.bindTexture(t.TEXTURE_2D,yt),t.uniform1i(this.helper.getUniformLocation(te.name),B),++B}const Me=Ge in T?T[Ge]:1;Me<1&&(e.animate=!0),this.helper.setUniformFloatValue(E.TRANSITION_ALPHA,Me),this.helper.setUniformFloatValue(E.DEPTH,xt),this.helper.setUniformFloatValue(E.TEXTURE_PIXEL_WIDTH,w),this.helper.setUniformFloatValue(E.TEXTURE_PIXEL_HEIGHT,X),this.helper.setUniformFloatValue(E.TEXTURE_RESOLUTION,O),this.helper.setUniformFloatValue(E.TEXTURE_ORIGIN_X,D[0]+De*G[0]*O-a*O),this.helper.setUniformFloatValue(E.TEXTURE_ORIGIN_Y,D[1]-we*G[1]*O+a*O);let ee=u;a>0&&(ee=o.getTileCoordExtent(Q),K(ee,u,ee)),this.helper.setUniformFloatVec4(E.RENDER_EXTENT,ee),this.helper.setUniformFloatValue(E.RESOLUTION,r.resolution),this.helper.setUniformFloatValue(E.ZOOM,r.zoom),this.helper.drawElements(0,this.indices_.getSize())}}this.helper.finalizeDraw(e,this.dispatchPreComposeEvent,this.dispatchPostComposeEvent);const A=this.helper.getCanvas(),v=this.tileTextureCache_;for(;v.canExpireCache();)v.pop().dispose();const P=function(L,C){s.updateCacheSize(.1,C.viewState.projection),s.expireCache(C.viewState.projection,Cr)};return e.postRenderFunctions.push(P),this.postRender(t,e),A}getData(e){if(!this.helper.getGL())return null;const r=this.frameState_;if(!r)return null;const i=this.getLayer(),s=Dt(r.pixelToCoordinateTransform,e.slice()),o=r.viewState,a=i.getExtent();if(a&&!ze(nt(a,o.projection),s))return null;const u=i.getSources(wt([s]),o.resolution);let l,h,c;for(l=u.length-1;l>=0;--l)if(h=u[l],h.getState()==="ready"){if(c=h.getTileGridForProjection(o.projection),h.getWrapX())break;const _=c.getExtent();if(!_||ze(_,s))break}if(l<0)return null;const T=this.tileTextureCache_;for(let _=c.getZForResolution(o.resolution);_>=c.getMinZoom();--_){const m=c.getTileCoordForCoordAndZ(s,_),b=Re(h,m);if(!T.containsKey(b))continue;const p=T.get(b),S=p.tile;if((S instanceof xe||S instanceof Se)&&S.getState()===y.EMPTY)return null;if(!p.loaded)continue;const R=c.getOrigin(_),x=V(c.getTileSize(_)),A=c.getResolution(_),v=(s[0]-R[0])/A-m[1]*x[0],P=(R[1]-s[1])/A-m[2]*x[1];return p.getPixelData(v,P)}return null}findAltTiles_(e,t,r,i){const s=e.getTileRangeForTileCoordAndZ(t,r,this.tempTileRange_);if(!s)return!1;let o=!0;const a=this.tileTextureCache_,u=this.getLayer().getRenderSource();for(let l=s.minX;l<=s.maxX;++l)for(let h=s.minY;h<=s.maxY;++h){const c=Re(u,[r,l,h]);let T=!1;if(a.containsKey(c)){const _=a.get(c);_.loaded&&!qe(i,_.tile)&&(Je(i,_,r),T=!0)}T||(o=!1)}return o}clearCache(){const e=this.tileTextureCache_;e.forEach(t=>t.dispose()),e.clear()}removeHelper(){this.helper&&this.clearCache(),super.removeHelper()}disposeInternal(){const e=this.helper;e&&(e.getGL().deleteProgram(this.program_),delete this.program_,e.deleteBuffer(this.indices_)),super.disposeInternal(),delete this.indices_,delete this.tileTextureCache_,delete this.frameState_}}const vr=Nr;class Pr{constructor(e,t){this.name=e,this.data=t,this.texture_=null}getTexture(e){if(!this.texture_){const t=e.createTexture();e.bindTexture(e.TEXTURE_2D,t),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,this.data.length/4,1,0,e.RGBA,e.UNSIGNED_BYTE,this.data),this.texture_=t}return this.texture_}}const Ir=Pr,f={NUMBER:1,STRING:2,COLOR:4,BOOLEAN:8,NUMBER_ARRAY:16,ANY:31,NONE:0},g={};function F(n){if(typeof n=="number")return f.NUMBER;if(typeof n=="boolean")return f.BOOLEAN;if(typeof n=="string")return Ft(n)?f.COLOR|f.STRING:f.STRING;if(!Array.isArray(n))throw new Error(`Unhandled value type: ${JSON.stringify(n)}`);const e=n;if(e.every(function(i){return typeof i=="number"}))return e.length===3||e.length===4?f.COLOR|f.NUMBER_ARRAY:f.NUMBER_ARRAY;if(typeof e[0]!="string")throw new Error(`Expected an expression operator but received: ${JSON.stringify(e)}`);const r=g[e[0]];if(r===void 0)throw new Error(`Unrecognized expression operator: ${JSON.stringify(e)}`);return r.getReturnType(e.slice(1))}function Or(n){return Math.log2(n)%1===0}function ue(n){const e=n.toString();return e.includes(".")?e:e+".0"}function ut(n){if(n.length<2||n.length>4)throw new Error("`formatArray` can only output `vec2`, `vec3` or `vec4` arrays.");return`vec${n.length}(${n.map(ue).join(", ")})`}function Gr(n){const e=$t(n).slice();return e.length<4&&e.push(1),ut(e.map(function(t,r){return r<3?t/255:t}))}function ht(n,e){return n.stringLiteralsMap[e]===void 0&&(n.stringLiteralsMap[e]=Object.keys(n.stringLiteralsMap).length),n.stringLiteralsMap[e]}function Dr(n,e){return ue(ht(n,e))}function d(n,e,t){if(Array.isArray(e)&&typeof e[0]=="string"){const i=g[e[0]];if(i===void 0)throw new Error(`Unrecognized expression operator: ${JSON.stringify(e)}`);return i.toGlsl(n,e.slice(1),t)}const r=F(e);if((r&f.NUMBER)>0)return ue(e);if((r&f.BOOLEAN)>0)return e.toString();if((r&f.STRING)>0&&(t===void 0||t==f.STRING))return Dr(n,e.toString());if((r&f.COLOR)>0&&(t===void 0||t==f.COLOR))return Gr(e);if((r&f.NUMBER_ARRAY)>0)return ut(e);throw new Error(`Unexpected expression ${e} (expected type ${t})`)}function ft(n){if(!(F(n)&f.NUMBER))throw new Error(`A numeric value was expected, got ${JSON.stringify(n)} instead`)}function N(n){for(let e=0;e<n.length;e++)ft(n[e])}function dt(n){if(!(F(n)&f.STRING))throw new Error(`A string value was expected, got ${JSON.stringify(n)} instead`)}function Pe(n){if(!(F(n)&f.BOOLEAN))throw new Error(`A boolean value was expected, got ${JSON.stringify(n)} instead`)}function U(n,e){if(n.length!==e)throw new Error(`Exactly ${e} arguments were expected, got ${n.length} instead`)}function $(n,e){if(n.length<e)throw new Error(`At least ${e} arguments were expected, got ${n.length} instead`)}function he(n,e){if(n.length>e)throw new Error(`At most ${e} arguments were expected, got ${n.length} instead`)}function Tt(n){if(n.length%2!==0)throw new Error(`An even amount of arguments was expected, got ${n} instead`)}function wr(n){if(n.length%2===0)throw new Error(`An odd amount of arguments was expected, got ${n} instead`)}function Ie(n,e){if(!Or(e))throw new Error(`Could not infer only one type from the following expression: ${JSON.stringify(n)}`)}g.get={getReturnType:function(n){return f.ANY},toGlsl:function(n,e){U(e,1),dt(e[0]);const t=e[0].toString();return n.attributes.includes(t)||n.attributes.push(t),(n.inFragmentShader?"v_":"a_")+t}};function _t(n){return"u_var_"+n}g.var={getReturnType:function(n){return f.ANY},toGlsl:function(n,e){U(e,1),dt(e[0]);const t=e[0].toString();return n.variables.includes(t)||n.variables.push(t),_t(t)}};const Et="u_paletteTextures";g.palette={getReturnType:function(n){return f.COLOR},toGlsl:function(n,e){U(e,2),ft(e[0]);const t=d(n,e[0]),r=e[1];if(!Array.isArray(r))throw new Error("The second argument of palette must be an array");const i=r.length,s=new Uint8Array(i*4);for(let u=0;u<i;u++){const l=r[u];let h;if(typeof l=="string")h=Mt(l);else{if(!Array.isArray(l))throw new Error("The second argument of palette must be an array of strings or colors");const T=l.length;if(T===4)h=l;else{if(T!==3)throw new Error(`Expected palette color to have 3 or 4 values, got ${T}`);h=[l[0],l[1],l[2],1]}}const c=u*4;s[c]=h[0],s[c+1]=h[1],s[c+2]=h[2],s[c+3]=h[3]*255}n.paletteTextures||(n.paletteTextures=[]);const o=`${Et}[${n.paletteTextures.length}]`,a=new Ir(o,s);return n.paletteTextures.push(a),`texture2D(${o}, vec2((${t} + 0.5) / ${i}.0, 0.5))`}};const pe="getBandValue";g.band={getReturnType:function(n){return f.NUMBER},toGlsl:function(n,e){$(e,1),he(e,3);const t=e[0];if(!(pe in n.functions)){let o="";const a=n.bandCount||1;for(let u=0;u<a;u++){const l=Math.floor(u/4);let h=u%4;u===a-1&&h===1&&(h=3);const c=`${E.TILE_TEXTURE_ARRAY}[${l}]`;o+=`
          if (band == ${u+1}.0) {
            return texture2D(${c}, v_textureCoord + vec2(dx, dy))[${h}];
          }
        `}n.functions[pe]=`
        float getBandValue(float band, float xOffset, float yOffset) {
          float dx = xOffset / ${E.TEXTURE_PIXEL_WIDTH};
          float dy = yOffset / ${E.TEXTURE_PIXEL_HEIGHT};
          ${o}
        }
      `}const r=d(n,t),i=d(n,e[1]||0),s=d(n,e[2]||0);return`${pe}(${r}, ${i}, ${s})`}};g.time={getReturnType:function(n){return f.NUMBER},toGlsl:function(n,e){return U(e,0),"u_time"}};g.zoom={getReturnType:function(n){return f.NUMBER},toGlsl:function(n,e){return U(e,0),"u_zoom"}};g.resolution={getReturnType:function(n){return f.NUMBER},toGlsl:function(n,e){return U(e,0),"u_resolution"}};g["*"]={getReturnType:function(n){return f.NUMBER},toGlsl:function(n,e){return $(e,2),N(e),`(${e.map(t=>d(n,t)).join(" * ")})`}};g["/"]={getReturnType:function(n){return f.NUMBER},toGlsl:function(n,e){return U(e,2),N(e),`(${d(n,e[0])} / ${d(n,e[1])})`}};g["+"]={getReturnType:function(n){return f.NUMBER},toGlsl:function(n,e){return $(e,2),N(e),`(${e.map(t=>d(n,t)).join(" + ")})`}};g["-"]={getReturnType:function(n){return f.NUMBER},toGlsl:function(n,e){return U(e,2),N(e),`(${d(n,e[0])} - ${d(n,e[1])})`}};g.clamp={getReturnType:function(n){return f.NUMBER},toGlsl:function(n,e){U(e,3),N(e);const t=d(n,e[1]),r=d(n,e[2]);return`clamp(${d(n,e[0])}, ${t}, ${r})`}};g["%"]={getReturnType:function(n){return f.NUMBER},toGlsl:function(n,e){return U(e,2),N(e),`mod(${d(n,e[0])}, ${d(n,e[1])})`}};g["^"]={getReturnType:function(n){return f.NUMBER},toGlsl:function(n,e){return U(e,2),N(e),`pow(${d(n,e[0])}, ${d(n,e[1])})`}};g.abs={getReturnType:function(n){return f.NUMBER},toGlsl:function(n,e){return U(e,1),N(e),`abs(${d(n,e[0])})`}};g.floor={getReturnType:function(n){return f.NUMBER},toGlsl:function(n,e){return U(e,1),N(e),`floor(${d(n,e[0])})`}};g.round={getReturnType:function(n){return f.NUMBER},toGlsl:function(n,e){return U(e,1),N(e),`floor(${d(n,e[0])} + 0.5)`}};g.ceil={getReturnType:function(n){return f.NUMBER},toGlsl:function(n,e){return U(e,1),N(e),`ceil(${d(n,e[0])})`}};g.sin={getReturnType:function(n){return f.NUMBER},toGlsl:function(n,e){return U(e,1),N(e),`sin(${d(n,e[0])})`}};g.cos={getReturnType:function(n){return f.NUMBER},toGlsl:function(n,e){return U(e,1),N(e),`cos(${d(n,e[0])})`}};g.atan={getReturnType:function(n){return f.NUMBER},toGlsl:function(n,e){return $(e,1),he(e,2),N(e),e.length===2?`atan(${d(n,e[0])}, ${d(n,e[1])})`:`atan(${d(n,e[0])})`}};g[">"]={getReturnType:function(n){return f.BOOLEAN},toGlsl:function(n,e){return U(e,2),N(e),`(${d(n,e[0])} > ${d(n,e[1])})`}};g[">="]={getReturnType:function(n){return f.BOOLEAN},toGlsl:function(n,e){return U(e,2),N(e),`(${d(n,e[0])} >= ${d(n,e[1])})`}};g["<"]={getReturnType:function(n){return f.BOOLEAN},toGlsl:function(n,e){return U(e,2),N(e),`(${d(n,e[0])} < ${d(n,e[1])})`}};g["<="]={getReturnType:function(n){return f.BOOLEAN},toGlsl:function(n,e){return U(e,2),N(e),`(${d(n,e[0])} <= ${d(n,e[1])})`}};function gt(n){return{getReturnType:function(e){return f.BOOLEAN},toGlsl:function(e,t){U(t,2);let r=f.ANY;for(let i=0;i<t.length;i++)r&=F(t[i]);if(r===f.NONE)throw new Error(`All arguments should be of compatible type, got ${JSON.stringify(t)} instead`);return r&=~f.COLOR,`(${d(e,t[0],r)} ${n} ${d(e,t[1],r)})`}}}g["=="]=gt("==");g["!="]=gt("!=");g["!"]={getReturnType:function(n){return f.BOOLEAN},toGlsl:function(n,e){return U(e,1),Pe(e[0]),`(!${d(n,e[0])})`}};function Rt(n){return{getReturnType:function(e){return f.BOOLEAN},toGlsl:function(e,t){$(t,2);for(let i=0;i<t.length;i++)Pe(t[i]);let r="";return r=t.map(i=>d(e,i)).join(` ${n} `),r=`(${r})`,r}}}g.all=Rt("&&");g.any=Rt("||");g.between={getReturnType:function(n){return f.BOOLEAN},toGlsl:function(n,e){U(e,3),N(e);const t=d(n,e[1]),r=d(n,e[2]),i=d(n,e[0]);return`(${i} >= ${t} && ${i} <= ${r})`}};g.array={getReturnType:function(n){return f.NUMBER_ARRAY},toGlsl:function(n,e){$(e,2),he(e,4),N(e);const t=e.map(function(r){return d(n,r,f.NUMBER)});return`vec${e.length}(${t.join(", ")})`}};g.color={getReturnType:function(n){return f.COLOR},toGlsl:function(n,e){$(e,3),he(e,4),N(e);const t=e;e.length===3&&t.push(1);const r=e.map(function(i,s){return d(n,i,f.NUMBER)+(s<3?" / 255.0":"")});return`vec${e.length}(${r.join(", ")})`}};g.interpolate={getReturnType:function(n){let e=f.COLOR|f.NUMBER;for(let t=3;t<n.length;t+=2)e=e&F(n[t]);return e},toGlsl:function(n,e,t){Tt(e),$(e,6);const r=e[0];let i;switch(r[0]){case"linear":i=1;break;case"exponential":i=r[1];break;default:i=null}if(!i)throw new Error(`Invalid interpolation type for "interpolate" operator, received: ${JSON.stringify(r)}`);t=t!==void 0?t:f.ANY;const s=g.interpolate.getReturnType(e)&t;Ie(e,s);const o=d(n,e[1]),a=ue(i);let u="";for(let l=2;l<e.length-2;l+=2){const h=d(n,e[l]),c=u||d(n,e[l+1],s),T=d(n,e[l+2]),_=d(n,e[l+3],s);u=`mix(${c}, ${_}, pow(clamp((${o} - ${h}) / (${T} - ${h}), 0.0, 1.0), ${a}))`}return u}};g.match={getReturnType:function(n){let e=f.ANY;for(let t=2;t<n.length;t+=2)e=e&F(n[t]);return e=e&F(n[n.length-1]),e},toGlsl:function(n,e,t){Tt(e),$(e,4),t=t!==void 0?t:f.ANY;const r=g.match.getReturnType(e)&t;Ie(e,r);const i=d(n,e[0]),s=d(n,e[e.length-1],r);let o=null;for(let a=e.length-3;a>=1;a-=2){const u=d(n,e[a]),l=d(n,e[a+1],r);o=`(${i} == ${u} ? ${l} : ${o||s})`}return o}};g.case={getReturnType:function(n){let e=f.ANY;for(let t=1;t<n.length;t+=2)e=e&F(n[t]);return e=e&F(n[n.length-1]),e},toGlsl:function(n,e,t){wr(e),$(e,3),t=t!==void 0?t:f.ANY;const r=g.case.getReturnType(e)&t;Ie(e,r);for(let o=0;o<e.length-1;o+=2)Pe(e[o]);const i=d(n,e[e.length-1],r);let s=null;for(let o=e.length-3;o>=0;o-=2){const a=d(n,e[o]),u=d(n,e[o+1],r);s=`(${a} ? ${u} : ${s||i})`}return s}};function Qe(n,e){const t=`
    attribute vec2 ${oe.TEXTURE_COORD};
    uniform mat4 ${E.TILE_TRANSFORM};
    uniform float ${E.TEXTURE_PIXEL_WIDTH};
    uniform float ${E.TEXTURE_PIXEL_HEIGHT};
    uniform float ${E.TEXTURE_RESOLUTION};
    uniform float ${E.TEXTURE_ORIGIN_X};
    uniform float ${E.TEXTURE_ORIGIN_Y};
    uniform float ${E.DEPTH};

    varying vec2 v_textureCoord;
    varying vec2 v_mapCoord;

    void main() {
      v_textureCoord = ${oe.TEXTURE_COORD};
      v_mapCoord = vec2(
        ${E.TEXTURE_ORIGIN_X} + ${E.TEXTURE_RESOLUTION} * ${E.TEXTURE_PIXEL_WIDTH} * v_textureCoord[0],
        ${E.TEXTURE_ORIGIN_Y} - ${E.TEXTURE_RESOLUTION} * ${E.TEXTURE_PIXEL_HEIGHT} * v_textureCoord[1]
      );
      gl_Position = ${E.TILE_TRANSFORM} * vec4(${oe.TEXTURE_COORD}, ${E.DEPTH}, 1.0);
    }
  `,r={inFragmentShader:!0,variables:[],attributes:[],stringLiteralsMap:{},functions:{},bandCount:e},i=[];if(n.color!==void 0){const c=d(r,n.color,f.COLOR);i.push(`color = ${c};`)}if(n.contrast!==void 0){const c=d(r,n.contrast,f.NUMBER);i.push(`color.rgb = clamp((${c} + 1.0) * color.rgb - (${c} / 2.0), vec3(0.0, 0.0, 0.0), vec3(1.0, 1.0, 1.0));`)}if(n.exposure!==void 0){const c=d(r,n.exposure,f.NUMBER);i.push(`color.rgb = clamp((${c} + 1.0) * color.rgb, vec3(0.0, 0.0, 0.0), vec3(1.0, 1.0, 1.0));`)}if(n.saturation!==void 0){const c=d(r,n.saturation,f.NUMBER);i.push(`
      float saturation = ${c} + 1.0;
      float sr = (1.0 - saturation) * 0.2126;
      float sg = (1.0 - saturation) * 0.7152;
      float sb = (1.0 - saturation) * 0.0722;
      mat3 saturationMatrix = mat3(
        sr + saturation, sr, sr,
        sg, sg + saturation, sg,
        sb, sb, sb + saturation
      );
      color.rgb = clamp(saturationMatrix * color.rgb, vec3(0.0, 0.0, 0.0), vec3(1.0, 1.0, 1.0));
    `)}if(n.gamma!==void 0){const c=d(r,n.gamma,f.NUMBER);i.push(`color.rgb = pow(color.rgb, vec3(1.0 / ${c}));`)}if(n.brightness!==void 0){const c=d(r,n.brightness,f.NUMBER);i.push(`color.rgb = clamp(color.rgb + ${c}, vec3(0.0, 0.0, 0.0), vec3(1.0, 1.0, 1.0));`)}const s={},o=r.variables.length;if(o>1&&!n.variables)throw new Error(`Missing variables in style (expected ${r.variables})`);for(let c=0;c<o;++c){const T=r.variables[c];if(!(T in n.variables))throw new Error(`Missing '${T}' in style variables`);const _=_t(T);s[_]=function(){let m=n.variables[T];return typeof m=="string"&&(m=ht(r,m)),m!==void 0?m:-9999999}}const a=Object.keys(s).map(function(c){return`uniform float ${c};`}),u=Math.ceil(e/4);a.push(`uniform sampler2D ${E.TILE_TEXTURE_ARRAY}[${u}];`),r.paletteTextures&&a.push(`uniform sampler2D ${Et}[${r.paletteTextures.length}];`);const l=Object.keys(r.functions).map(function(c){return r.functions[c]}),h=`
    #ifdef GL_FRAGMENT_PRECISION_HIGH
    precision highp float;
    #else
    precision mediump float;
    #endif

    varying vec2 v_textureCoord;
    varying vec2 v_mapCoord;
    uniform vec4 ${E.RENDER_EXTENT};
    uniform float ${E.TRANSITION_ALPHA};
    uniform float ${E.TEXTURE_PIXEL_WIDTH};
    uniform float ${E.TEXTURE_PIXEL_HEIGHT};
    uniform float ${E.RESOLUTION};
    uniform float ${E.ZOOM};

    ${a.join(`
`)}

    ${l.join(`
`)}

    void main() {
      if (
        v_mapCoord[0] < ${E.RENDER_EXTENT}[0] ||
        v_mapCoord[1] < ${E.RENDER_EXTENT}[1] ||
        v_mapCoord[0] > ${E.RENDER_EXTENT}[2] ||
        v_mapCoord[1] > ${E.RENDER_EXTENT}[3]
      ) {
        discard;
      }

      vec4 color = texture2D(${E.TILE_TEXTURE_ARRAY}[0],  v_textureCoord);

      ${i.join(`
`)}

      if (color.a == 0.0) {
        discard;
      }

      gl_FragColor = color;
      gl_FragColor.rgb *= gl_FragColor.a;
      gl_FragColor *= ${E.TRANSITION_ALPHA};
    }`;return{vertexShader:t,fragmentShader:h,uniforms:s,paletteTextures:r.paletteTextures}}class pt extends Qt{constructor(e){e=e?Object.assign({},e):{};const t=e.style||{};delete e.style;const r=e.cacheSize;delete e.cacheSize,super(e),this.sources_=e.sources,this.renderedSource_=null,this.renderedResolution_=NaN,this.style_=t,this.cacheSize_=r,this.styleVariables_=this.style_.variables||{},this.addChangeListener(rt.SOURCE,this.handleSourceUpdate_)}getSources(e,t){const r=this.getSource();return this.sources_?typeof this.sources_=="function"?this.sources_(e,t):this.sources_:r?[r]:[]}getRenderSource(){return this.renderedSource_||this.getSource()}getSourceState(){const e=this.getRenderSource();return e?e.getState():"undefined"}handleSourceUpdate_(){this.hasRenderer()&&this.getRenderer().clearCache(),this.getSource()&&this.setStyle(this.style_)}getSourceBandCount_(){const e=Number.MAX_SAFE_INTEGER,t=this.getSources([-e,-e,e,e],e);return t&&t.length&&"bandCount"in t[0]?t[0].bandCount:4}createRenderer(){const e=Qe(this.style_,this.getSourceBandCount_());return new vr(this,{vertexShader:e.vertexShader,fragmentShader:e.fragmentShader,uniforms:e.uniforms,cacheSize:this.cacheSize_,paletteTextures:e.paletteTextures})}renderSources(e,t){const r=this.getRenderer();let i;for(let s=0,o=t.length;s<o;++s)this.renderedSource_=t[s],r.prepareFrame(e)&&(i=r.renderFrame(e));return i}render(e,t){this.rendered=!0;const r=e.viewState,i=this.getSources(e.extent,r.resolution);let s=!0;for(let a=0,u=i.length;a<u;++a){const l=i[a],h=l.getState();if(h=="loading"){const c=()=>{l.getState()=="ready"&&(l.removeEventListener("change",c),this.changed())};l.addEventListener("change",c)}s=s&&h=="ready"}const o=this.renderSources(e,i);if(this.getRenderer().renderComplete&&s)return this.renderedResolution_=r.resolution,o;if(this.renderedResolution_>.5*r.resolution){const a=this.getSources(e.extent,this.renderedResolution_).filter(u=>!i.includes(u));if(a.length>0)return this.renderSources(e,a)}return o}setStyle(e){this.styleVariables_=e.variables||{},this.style_=e;const t=Qe(this.style_,this.getSourceBandCount_());this.getRenderer().reset({vertexShader:t.vertexShader,fragmentShader:t.fragmentShader,uniforms:t.uniforms,paletteTextures:t.paletteTextures}),this.changed()}updateStyleVariables(e){Object.assign(this.styleVariables_,e),this.changed()}}pt.prototype.dispose;const zr=pt;export{Xr as D,zr as T};
