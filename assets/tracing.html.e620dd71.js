import{b5 as hr,aX as ur,i as dr,b6 as fr,b7 as _r,b8 as gr,b9 as Tr,ba as Er,a8 as le,bb as At,bc as Pt,b4 as bt,bd as K,be as Te,bf as pr,bg as at,bh as mr,bi as Rr,bj as xr,az as H,bk as j,bl as yr,Y as ie,bm as Dt,an as De,ao as Ee,bn as ct,ap as Cr,aq as wt,al as It,bo as Lr,b3 as Sr,am as Ut,bp as Ar,bq as vt,br as Be,G as M,s as Pr,aH as W,aG as se,b1 as lt,aV as br,Q as Dr,bs as wr,bt as Ir,bu as Ur,bv as vr,at as Ve,as as Gr,u as S,D as J,bw as ht,bx as we,by as Or,au as ut,bz as Nr,bA as Mr,bB as Fr,bC as Br,a as $r,bD as Xr,y as $e,x as dt,R as Xe,bE as kr,O as xe,a5 as pe,a3 as ke,bF as Gt,H as Ot,bG as jr,bH as zr,bI as Nt,bJ as V,bK as Ie,t as Hr,bL as ft,bM as Vr,bN as Wr,aO as je,L as Yr,a6 as Kr,v as Zr,w as _t,B as Mt,bO as qr,bP as Jr,bQ as Qr,d as en,e as tn,p as rn,V as nn}from"./featureloader.09c78551.js";import{V as We,a as Ye,F as te,c as sn,R as on,d as gt,T as an,G as cn}from"./Vector.fa9826be.js";class Se extends hr{constructor(e,t,r){super(),r!==void 0&&t===void 0?this.setFlatCoordinates(r,e):(t=t||0,this.setCenterAndRadius(e,t,r))}clone(){const e=new Se(this.flatCoordinates.slice(),void 0,this.layout);return e.applyProperties(this),e}closestPointXY(e,t,r,n){const s=this.flatCoordinates,o=e-s[0],a=t-s[1],c=o*o+a*a;if(c<n){if(c===0)for(let l=0;l<this.stride;++l)r[l]=s[l];else{const l=this.getRadius()/Math.sqrt(c);r[0]=s[0]+l*o,r[1]=s[1]+l*a;for(let u=2;u<this.stride;++u)r[u]=s[u]}return r.length=this.stride,c}return n}containsXY(e,t){const r=this.flatCoordinates,n=e-r[0],s=t-r[1];return n*n+s*s<=this.getRadiusSquared_()}getCenter(){return this.flatCoordinates.slice(0,this.stride)}computeExtent(e){const t=this.flatCoordinates,r=t[this.stride]-t[0];return ur(t[0]-r,t[1]-r,t[0]+r,t[1]+r,e)}getRadius(){return Math.sqrt(this.getRadiusSquared_())}getRadiusSquared_(){const e=this.flatCoordinates[this.stride]-this.flatCoordinates[0],t=this.flatCoordinates[this.stride+1]-this.flatCoordinates[1];return e*e+t*t}getType(){return"Circle"}intersectsExtent(e){const t=this.getExtent();if(dr(e,t)){const r=this.getCenter();return e[0]<=r[0]&&e[2]>=r[0]||e[1]<=r[1]&&e[3]>=r[1]?!0:fr(e,this.intersectsCoordinate.bind(this))}return!1}setCenter(e){const t=this.stride,r=this.flatCoordinates[t]-this.flatCoordinates[0],n=e.slice();n[t]=n[0]+r;for(let s=1;s<t;++s)n[t+s]=e[s];this.setFlatCoordinates(this.layout,n),this.changed()}setCenterAndRadius(e,t,r){this.setLayout(r,e,0),this.flatCoordinates||(this.flatCoordinates=[]);const n=this.flatCoordinates;let s=_r(n,0,e,this.stride);n[s++]=n[0]+t;for(let o=1,a=this.stride;o<a;++o)n[s++]=n[o];n.length=s,this.changed()}getCoordinates(){return null}setCoordinates(e,t){}setRadius(e){this.flatCoordinates[this.stride]=this.flatCoordinates[0]+e,this.changed()}rotate(e,t){const r=this.getCenter(),n=this.getStride();this.setCenter(gr(r,0,r.length,n,e,t,r)),this.changed()}translate(e,t){const r=this.getCenter(),n=this.getStride();this.setCenter(Tr(r,0,r.length,n,e,t,r)),this.changed()}}Se.prototype.transform;const ln=Se;class hn extends Er{constructor(e){e=e||{};const t=Object.assign({},e);delete t.preload,delete t.useInterimTilesOnError,super(t),this.on,this.once,this.un,this.setPreload(e.preload!==void 0?e.preload:0),this.setUseInterimTilesOnError(e.useInterimTilesOnError!==void 0?e.useInterimTilesOnError:!0)}getPreload(){return this.get(le.PRELOAD)}setPreload(e){this.set(le.PRELOAD,e)}getUseInterimTilesOnError(){return this.get(le.USE_INTERIM_TILES_ON_ERROR)}setUseInterimTilesOnError(e){this.set(le.USE_INTERIM_TILES_ON_ERROR,e)}getData(e){return super.getData(e)}}const un=hn;const he={DRAWSTART:"drawstart",DRAWEND:"drawend",DRAWABORT:"drawabort"};class ue extends Sr{constructor(e,t){super(e),this.feature=t}}function dn(i,e){const t=[];for(let r=0;r<e.length;++r){const s=e[r].getGeometry();Ft(i,s,t)}return t}function de(i,e){return vt(i[0],i[1],e[0],e[1])}function Z(i,e){const t=i.length;return e<0?i[e+t]:e>=t?i[e-t]:i[e]}function fe(i,e,t){let r,n;e<t?(r=e,n=t):(r=t,n=e);const s=Math.ceil(r),o=Math.floor(n);if(s>o){const c=q(i,r),l=q(i,n);return de(c,l)}let a=0;if(r<s){const c=q(i,r),l=Z(i,s);a+=de(c,l)}if(o<n){const c=Z(i,o),l=q(i,n);a+=de(c,l)}for(let c=s;c<o-1;++c){const l=Z(i,c),u=Z(i,c+1);a+=de(l,u)}return a}function Ft(i,e,t){if(e instanceof Ee){_e(i,e.getCoordinates(),!1,t);return}if(e instanceof wt){const r=e.getCoordinates();for(let n=0,s=r.length;n<s;++n)_e(i,r[n],!1,t);return}if(e instanceof Ut){const r=e.getCoordinates();for(let n=0,s=r.length;n<s;++n)_e(i,r[n],!0,t);return}if(e instanceof It){const r=e.getCoordinates();for(let n=0,s=r.length;n<s;++n){const o=r[n];for(let a=0,c=o.length;a<c;++a)_e(i,o[a],!0,t)}return}if(e instanceof sn){const r=e.getGeometries();for(let n=0;n<r.length;++n)Ft(i,r[n],t);return}}const Ue={index:-1,endIndex:NaN};function fn(i,e,t,r){const n=i[0],s=i[1];let o=1/0,a=-1,c=NaN;for(let h=0;h<e.targets.length;++h){const d=e.targets[h],f=d.coordinates;let T=1/0,p;for(let E=0;E<f.length-1;++E){const y=f[E],x=f[E+1],C=Bt(n,s,y,x);C.squaredDistance<T&&(T=C.squaredDistance,p=E+C.along)}T<o&&(o=T,d.ring&&e.targetIndex===h&&(d.endIndex>d.startIndex?p<d.startIndex&&(p+=f.length):d.endIndex<d.startIndex&&p>d.startIndex&&(p-=f.length)),c=p,a=h)}const l=e.targets[a];let u=l.ring;if(e.targetIndex===a&&u){const h=q(l.coordinates,c),d=t.getPixelFromCoordinate(h);Dt(d,e.startPx)>r&&(u=!1)}if(u){const h=l.coordinates,d=h.length,f=l.startIndex,T=c;if(f<T){const p=fe(h,f,T);fe(h,f,T-d)<p&&(c-=d)}else{const p=fe(h,f,T);fe(h,f,T+d)<p&&(c+=d)}}return Ue.index=a,Ue.endIndex=c,Ue}function _e(i,e,t,r){const n=i[0],s=i[1];for(let o=0,a=e.length-1;o<a;++o){const c=e[o],l=e[o+1],u=Bt(n,s,c,l);if(u.squaredDistance===0){const h=o+u.along;r.push({coordinates:e,ring:t,startIndex:h,endIndex:h});return}}}const ve={along:0,squaredDistance:0};function Bt(i,e,t,r){const n=t[0],s=t[1],o=r[0],a=r[1],c=o-n,l=a-s;let u=0,h=n,d=s;return(c!==0||l!==0)&&(u=Be(((i-n)*c+(e-s)*l)/(c*c+l*l),0,1),h+=c*u,d+=l*u),ve.along=u,ve.squaredDistance=Ar(vt(i,e,h,d),10),ve}function q(i,e){const t=i.length;let r=Math.floor(e);const n=e-r;r>=t?r-=t:r<0&&(r+=t);let s=r+1;s>=t&&(s-=t);const o=i[r],a=o[0],c=o[1],l=i[s],u=l[0]-a,h=l[1]-c;return[a+u*n,c+h*n]}class _n extends At{constructor(e){const t=e;t.stopDown||(t.stopDown=Pt),super(t),this.on,this.once,this.un,this.shouldHandle_=!1,this.downPx_=null,this.downTimeout_,this.lastDragTime_,this.pointerType_,this.freehand_=!1,this.source_=e.source?e.source:null,this.features_=e.features?e.features:null,this.snapTolerance_=e.snapTolerance?e.snapTolerance:12,this.type_=e.type,this.mode_=Tn(this.type_),this.stopClick_=!!e.stopClick,this.minPoints_=e.minPoints?e.minPoints:this.mode_==="Polygon"?3:2,this.maxPoints_=this.mode_==="Circle"?2:e.maxPoints?e.maxPoints:1/0,this.finishCondition_=e.finishCondition?e.finishCondition:bt,this.geometryLayout_=e.geometryLayout?e.geometryLayout:"XY";let r=e.geometryFunction;if(!r){const n=this.mode_;if(n==="Circle")r=function(s,o,a){const c=o||new ln([NaN,NaN]),l=K(s[0]),u=Te(l,K(s[s.length-1]));return c.setCenterAndRadius(l,Math.sqrt(u),this.geometryLayout_),c};else{let s;n==="Point"?s=De:n==="LineString"?s=Ee:n==="Polygon"&&(s=Ut),r=function(o,a,c){return a?n==="Polygon"?o[0].length?a.setCoordinates([o[0].concat([o[0][0]])],this.geometryLayout_):a.setCoordinates([],this.geometryLayout_):a.setCoordinates(o,this.geometryLayout_):a=new s(o,this.geometryLayout_),a}}}this.geometryFunction_=r,this.dragVertexDelay_=e.dragVertexDelay!==void 0?e.dragVertexDelay:500,this.finishCoordinate_=null,this.sketchFeature_=null,this.sketchPoint_=null,this.sketchCoords_=null,this.sketchLine_=null,this.sketchLineCoords_=null,this.squaredClickTolerance_=e.clickTolerance?e.clickTolerance*e.clickTolerance:36,this.overlay_=new We({source:new Ye({useSpatialIndex:!1,wrapX:e.wrapX?e.wrapX:!1}),style:e.style?e.style:gn(),updateWhileInteracting:!0}),this.geometryName_=e.geometryName,this.condition_=e.condition?e.condition:pr,this.freehandCondition_,e.freehand?this.freehandCondition_=at:this.freehandCondition_=e.freehandCondition?e.freehandCondition:mr,this.traceCondition_,this.setTrace(e.trace||!1),this.traceState_={active:!1},this.traceSource_=e.traceSource||e.source||null,this.addChangeListener(Rr.ACTIVE,this.updateState_)}setTrace(e){let t;e?e===!0?t=at:t=e:t=xr,this.traceCondition_=t}setMap(e){super.setMap(e),this.updateState_()}getOverlay(){return this.overlay_}handleEvent(e){e.originalEvent.type===H.CONTEXTMENU&&e.originalEvent.preventDefault(),this.freehand_=this.mode_!=="Point"&&this.freehandCondition_(e);let t=e.type===j.POINTERMOVE,r=!0;return!this.freehand_&&this.lastDragTime_&&e.type===j.POINTERDRAG&&(Date.now()-this.lastDragTime_>=this.dragVertexDelay_?(this.downPx_=e.pixel,this.shouldHandle_=!this.freehand_,t=!0):this.lastDragTime_=void 0,this.shouldHandle_&&this.downTimeout_!==void 0&&(clearTimeout(this.downTimeout_),this.downTimeout_=void 0)),this.freehand_&&e.type===j.POINTERDRAG&&this.sketchFeature_!==null?(this.addToDrawing_(e.coordinate),r=!1):this.freehand_&&e.type===j.POINTERDOWN?r=!1:t&&this.getPointerCount()<2?(r=e.type===j.POINTERMOVE,r&&this.freehand_?(this.handlePointerMove_(e),this.shouldHandle_&&e.originalEvent.preventDefault()):(e.originalEvent.pointerType==="mouse"||e.type===j.POINTERDRAG&&this.downTimeout_===void 0)&&this.handlePointerMove_(e)):e.type===j.DBLCLICK&&(r=!1),super.handleEvent(e)&&r}handleDownEvent(e){return this.shouldHandle_=!this.freehand_,this.freehand_?(this.downPx_=e.pixel,this.finishCoordinate_||this.startDrawing_(e.coordinate),!0):this.condition_(e)?(this.lastDragTime_=Date.now(),this.downTimeout_=setTimeout(()=>{this.handlePointerMove_(new yr(j.POINTERMOVE,e.map,e.originalEvent,!1,e.frameState))},this.dragVertexDelay_),this.downPx_=e.pixel,!0):(this.lastDragTime_=void 0,!1)}deactivateTrace_(){this.traceState_={active:!1}}toggleTraceState_(e){if(!this.traceSource_||!this.traceCondition_(e))return;if(this.traceState_.active){this.deactivateTrace_();return}const t=this.getMap(),r=t.getCoordinateFromPixel([e.pixel[0]-this.snapTolerance_,e.pixel[1]+this.snapTolerance_]),n=t.getCoordinateFromPixel([e.pixel[0]+this.snapTolerance_,e.pixel[1]-this.snapTolerance_]),s=ie([r,n]),o=this.traceSource_.getFeaturesInExtent(s);if(o.length===0)return;const a=dn(e.coordinate,o);a.length&&(this.traceState_={active:!0,startPx:e.pixel.slice(),targets:a,targetIndex:-1})}addOrRemoveTracedCoordinates_(e,t){const r=e.startIndex<=e.endIndex,n=e.startIndex<=t;r===n?r&&t>e.endIndex||!r&&t<e.endIndex?this.addTracedCoordinates_(e,e.endIndex,t):(r&&t<e.endIndex||!r&&t>e.endIndex)&&this.removeTracedCoordinates_(t,e.endIndex):(this.removeTracedCoordinates_(e.startIndex,e.endIndex),this.addTracedCoordinates_(e,e.startIndex,t))}removeTracedCoordinates_(e,t){if(e===t)return;let r=0;if(e<t){const n=Math.ceil(e);let s=Math.floor(t);s===t&&(s-=1),r=s-n+1}else{const n=Math.floor(e);let s=Math.ceil(t);s===t&&(s+=1),r=n-s+1}r>0&&this.removeLastPoints_(r)}addTracedCoordinates_(e,t,r){if(t===r)return;const n=[];if(t<r){const s=Math.ceil(t);let o=Math.floor(r);o===r&&(o-=1);for(let a=s;a<=o;++a)n.push(Z(e.coordinates,a))}else{const s=Math.floor(t);let o=Math.ceil(r);o===r&&(o+=1);for(let a=s;a>=o;--a)n.push(Z(e.coordinates,a))}n.length&&this.appendCoordinates(n)}updateTrace_(e){const t=this.traceState_;if(!t.active||t.targetIndex===-1&&Dt(t.startPx,e.pixel)<this.snapTolerance_)return;const r=fn(e.coordinate,t,this.getMap(),this.snapTolerance_);if(t.targetIndex!==r.index){if(t.targetIndex!==-1){const c=t.targets[t.targetIndex];this.removeTracedCoordinates_(c.startIndex,c.endIndex)}const a=t.targets[r.index];this.addTracedCoordinates_(a,a.startIndex,r.endIndex)}else{const a=t.targets[t.targetIndex];this.addOrRemoveTracedCoordinates_(a,r.endIndex)}t.targetIndex=r.index;const n=t.targets[t.targetIndex];n.endIndex=r.endIndex;const s=q(n.coordinates,n.endIndex),o=this.getMap().getPixelFromCoordinate(s);e.coordinate=s,e.pixel=[Math.round(o[0]),Math.round(o[1])]}handleUpEvent(e){let t=!0;if(this.getPointerCount()===0){this.downTimeout_&&(clearTimeout(this.downTimeout_),this.downTimeout_=void 0),this.handlePointerMove_(e);const r=this.traceState_.active;if(this.toggleTraceState_(e),this.shouldHandle_){const n=!this.finishCoordinate_;n&&this.startDrawing_(e.coordinate),!n&&this.freehand_?this.finishDrawing():!this.freehand_&&(!n||this.mode_==="Point")&&(this.atFinish_(e.pixel,r)?this.finishCondition_(e)&&this.finishDrawing():this.addToDrawing_(e.coordinate)),t=!1}else this.freehand_&&this.abortDrawing()}return!t&&this.stopClick_&&e.preventDefault(),t}handlePointerMove_(e){if(this.pointerType_=e.originalEvent.pointerType,this.downPx_&&(!this.freehand_&&this.shouldHandle_||this.freehand_&&!this.shouldHandle_)){const t=this.downPx_,r=e.pixel,n=t[0]-r[0],s=t[1]-r[1],o=n*n+s*s;if(this.shouldHandle_=this.freehand_?o>this.squaredClickTolerance_:o<=this.squaredClickTolerance_,!this.shouldHandle_)return}if(!this.finishCoordinate_){this.createOrUpdateSketchPoint_(e.coordinate.slice());return}this.updateTrace_(e),this.modifyDrawing_(e.coordinate)}atFinish_(e,t){let r=!1;if(this.sketchFeature_){let n=!1,s=[this.finishCoordinate_];const o=this.mode_;if(o==="Point")r=!0;else if(o==="Circle")r=this.sketchCoords_.length===2;else if(o==="LineString")n=!t&&this.sketchCoords_.length>this.minPoints_;else if(o==="Polygon"){const a=this.sketchCoords_;n=a[0].length>this.minPoints_,s=[a[0][0],a[0][a[0].length-2]],t?s=[a[0][0]]:s=[a[0][0],a[0][a[0].length-2]]}if(n){const a=this.getMap();for(let c=0,l=s.length;c<l;c++){const u=s[c],h=a.getPixelFromCoordinate(u),d=e[0]-h[0],f=e[1]-h[1],T=this.freehand_?1:this.snapTolerance_;if(r=Math.sqrt(d*d+f*f)<=T,r){this.finishCoordinate_=u;break}}}}return r}createOrUpdateSketchPoint_(e){this.sketchPoint_?this.sketchPoint_.getGeometry().setCoordinates(e):(this.sketchPoint_=new te(new De(e)),this.updateSketchFeatures_())}createOrUpdateCustomSketchLine_(e){this.sketchLine_||(this.sketchLine_=new te);const t=e.getLinearRing(0);let r=this.sketchLine_.getGeometry();r?(r.setFlatCoordinates(t.getLayout(),t.getFlatCoordinates()),r.changed()):(r=new Ee(t.getFlatCoordinates(),t.getLayout()),this.sketchLine_.setGeometry(r))}startDrawing_(e){const t=this.getMap().getView().getProjection(),r=ct(this.geometryLayout_);for(;e.length<r;)e.push(0);this.finishCoordinate_=e,this.mode_==="Point"?this.sketchCoords_=e.slice():this.mode_==="Polygon"?(this.sketchCoords_=[[e.slice(),e.slice()]],this.sketchLineCoords_=this.sketchCoords_[0]):this.sketchCoords_=[e.slice(),e.slice()],this.sketchLineCoords_&&(this.sketchLine_=new te(new Ee(this.sketchLineCoords_)));const n=this.geometryFunction_(this.sketchCoords_,void 0,t);this.sketchFeature_=new te,this.geometryName_&&this.sketchFeature_.setGeometryName(this.geometryName_),this.sketchFeature_.setGeometry(n),this.updateSketchFeatures_(),this.dispatchEvent(new ue(he.DRAWSTART,this.sketchFeature_))}modifyDrawing_(e){const t=this.getMap(),r=this.sketchFeature_.getGeometry(),n=t.getView().getProjection(),s=ct(this.geometryLayout_);let o,a;for(;e.length<s;)e.push(0);this.mode_==="Point"?a=this.sketchCoords_:this.mode_==="Polygon"?(o=this.sketchCoords_[0],a=o[o.length-1],this.atFinish_(t.getPixelFromCoordinate(e))&&(e=this.finishCoordinate_.slice())):(o=this.sketchCoords_,a=o[o.length-1]),a[0]=e[0],a[1]=e[1],this.geometryFunction_(this.sketchCoords_,r,n),this.sketchPoint_&&this.sketchPoint_.getGeometry().setCoordinates(e),r.getType()==="Polygon"&&this.mode_!=="Polygon"?this.createOrUpdateCustomSketchLine_(r):this.sketchLineCoords_&&this.sketchLine_.getGeometry().setCoordinates(this.sketchLineCoords_),this.updateSketchFeatures_()}addToDrawing_(e){const t=this.sketchFeature_.getGeometry(),r=this.getMap().getView().getProjection();let n,s;const o=this.mode_;o==="LineString"||o==="Circle"?(this.finishCoordinate_=e.slice(),s=this.sketchCoords_,s.length>=this.maxPoints_&&(this.freehand_?s.pop():n=!0),s.push(e.slice()),this.geometryFunction_(s,t,r)):o==="Polygon"&&(s=this.sketchCoords_[0],s.length>=this.maxPoints_&&(this.freehand_?s.pop():n=!0),s.push(e.slice()),n&&(this.finishCoordinate_=s[0]),this.geometryFunction_(this.sketchCoords_,t,r)),this.createOrUpdateSketchPoint_(e.slice()),this.updateSketchFeatures_(),n&&this.finishDrawing()}removeLastPoints_(e){if(!this.sketchFeature_)return;const t=this.sketchFeature_.getGeometry(),r=this.getMap().getView().getProjection(),n=this.mode_;for(let s=0;s<e;++s){let o;if(n==="LineString"||n==="Circle"){if(o=this.sketchCoords_,o.splice(-2,1),o.length>=2){this.finishCoordinate_=o[o.length-2].slice();const a=this.finishCoordinate_.slice();o[o.length-1]=a,this.createOrUpdateSketchPoint_(a)}this.geometryFunction_(o,t,r),t.getType()==="Polygon"&&this.sketchLine_&&this.createOrUpdateCustomSketchLine_(t)}else if(n==="Polygon"){o=this.sketchCoords_[0],o.splice(-2,1);const a=this.sketchLine_.getGeometry();if(o.length>=2){const c=o[o.length-2].slice();o[o.length-1]=c,this.createOrUpdateSketchPoint_(c)}a.setCoordinates(o),this.geometryFunction_(this.sketchCoords_,t,r)}if(o.length===1){this.abortDrawing();break}}this.updateSketchFeatures_()}removeLastPoint(){this.removeLastPoints_(1)}finishDrawing(){const e=this.abortDrawing_();if(!e)return;let t=this.sketchCoords_;const r=e.getGeometry(),n=this.getMap().getView().getProjection();this.mode_==="LineString"?(t.pop(),this.geometryFunction_(t,r,n)):this.mode_==="Polygon"&&(t[0].pop(),this.geometryFunction_(t,r,n),t=r.getCoordinates()),this.type_==="MultiPoint"?e.setGeometry(new Cr([t])):this.type_==="MultiLineString"?e.setGeometry(new wt([t])):this.type_==="MultiPolygon"&&e.setGeometry(new It([t])),this.dispatchEvent(new ue(he.DRAWEND,e)),this.features_&&this.features_.push(e),this.source_&&this.source_.addFeature(e)}abortDrawing_(){this.finishCoordinate_=null;const e=this.sketchFeature_;return this.sketchFeature_=null,this.sketchPoint_=null,this.sketchLine_=null,this.overlay_.getSource().clear(!0),this.deactivateTrace_(),e}abortDrawing(){const e=this.abortDrawing_();e&&this.dispatchEvent(new ue(he.DRAWABORT,e))}appendCoordinates(e){const t=this.mode_,r=!this.sketchFeature_;r&&this.startDrawing_(e[0]);let n;if(t==="LineString"||t==="Circle")n=this.sketchCoords_;else if(t==="Polygon")n=this.sketchCoords_&&this.sketchCoords_.length?this.sketchCoords_[0]:[];else return;r&&n.shift(),n.pop();for(let o=0;o<e.length;o++)this.addToDrawing_(e[o]);const s=e[e.length-1];this.addToDrawing_(s),this.modifyDrawing_(s)}extend(e){const r=e.getGeometry();this.sketchFeature_=e,this.sketchCoords_=r.getCoordinates();const n=this.sketchCoords_[this.sketchCoords_.length-1];this.finishCoordinate_=n.slice(),this.sketchCoords_.push(n.slice()),this.sketchPoint_=new te(new De(n)),this.updateSketchFeatures_(),this.dispatchEvent(new ue(he.DRAWSTART,this.sketchFeature_))}updateSketchFeatures_(){const e=[];this.sketchFeature_&&e.push(this.sketchFeature_),this.sketchLine_&&e.push(this.sketchLine_),this.sketchPoint_&&e.push(this.sketchPoint_);const t=this.overlay_.getSource();t.clear(!0),t.addFeatures(e)}updateState_(){const e=this.getMap(),t=this.getActive();(!e||!t)&&this.abortDrawing(),this.overlay_.setMap(t?e:null)}}function gn(){const i=Lr();return function(e,t){return i[e.getGeometry().getType()]}}function Tn(i){switch(i){case"Point":case"MultiPoint":return"Point";case"LineString":case"MultiLineString":return"LineString";case"Polygon":case"MultiPolygon":return"Polygon";case"Circle":return"Circle";default:throw new Error("Invalid type: "+i)}}const En=_n;function Tt(i){if(i.feature)return i.feature;if(i.element)return i.element}const Ge=[];class pn extends At{constructor(e){e=e||{};const t=e;t.handleDownEvent||(t.handleDownEvent=bt),t.stopDown||(t.stopDown=Pt),super(t),this.source_=e.source?e.source:null,this.vertex_=e.vertex!==void 0?e.vertex:!0,this.edge_=e.edge!==void 0?e.edge:!0,this.features_=e.features?e.features:null,this.featuresListenerKeys_=[],this.featureChangeListenerKeys_={},this.indexedFeaturesExtents_={},this.pendingFeatures_={},this.pixelTolerance_=e.pixelTolerance!==void 0?e.pixelTolerance:10,this.rBush_=new on,this.GEOMETRY_SEGMENTERS_={Point:this.segmentPointGeometry_.bind(this),LineString:this.segmentLineStringGeometry_.bind(this),LinearRing:this.segmentLineStringGeometry_.bind(this),Polygon:this.segmentPolygonGeometry_.bind(this),MultiPoint:this.segmentMultiPointGeometry_.bind(this),MultiLineString:this.segmentMultiLineStringGeometry_.bind(this),MultiPolygon:this.segmentMultiPolygonGeometry_.bind(this),GeometryCollection:this.segmentGeometryCollectionGeometry_.bind(this),Circle:this.segmentCircleGeometry_.bind(this)}}addFeature(e,t){t=t!==void 0?t:!0;const r=M(e),n=e.getGeometry();if(n){const s=this.GEOMETRY_SEGMENTERS_[n.getType()];if(s){this.indexedFeaturesExtents_[r]=n.getExtent(Pr());const o=[];if(s(o,n),o.length===1)this.rBush_.insert(ie(o[0]),{feature:e,segment:o[0]});else if(o.length>1){const a=o.map(l=>ie(l)),c=o.map(l=>({feature:e,segment:l}));this.rBush_.load(a,c)}}}t&&(this.featureChangeListenerKeys_[r]=W(e,H.CHANGE,this.handleFeatureChange_,this))}getFeatures_(){let e;return this.features_?e=this.features_:this.source_&&(e=this.source_.getFeatures()),e}handleEvent(e){const t=this.snapTo(e.pixel,e.coordinate,e.map);return t&&(e.coordinate=t.vertex.slice(0,2),e.pixel=t.vertexPixel),super.handleEvent(e)}handleFeatureAdd_(e){const t=Tt(e);this.addFeature(t)}handleFeatureRemove_(e){const t=Tt(e);this.removeFeature(t)}handleFeatureChange_(e){const t=e.target;if(this.handlingDownUpSequence){const r=M(t);r in this.pendingFeatures_||(this.pendingFeatures_[r]=t)}else this.updateFeature_(t)}handleUpEvent(e){const t=Object.values(this.pendingFeatures_);return t.length&&(t.forEach(this.updateFeature_.bind(this)),this.pendingFeatures_={}),!1}removeFeature(e,t){const r=t!==void 0?t:!0,n=M(e),s=this.indexedFeaturesExtents_[n];if(s){const o=this.rBush_,a=[];o.forEachInExtent(s,function(c){e===c.feature&&a.push(c)});for(let c=a.length-1;c>=0;--c)o.remove(a[c])}r&&(se(this.featureChangeListenerKeys_[n]),delete this.featureChangeListenerKeys_[n])}setMap(e){const t=this.getMap(),r=this.featuresListenerKeys_,n=this.getFeatures_();t&&(r.forEach(se),r.length=0,this.rBush_.clear(),Object.values(this.featureChangeListenerKeys_).forEach(se),this.featureChangeListenerKeys_={}),super.setMap(e),e&&(this.features_?r.push(W(this.features_,lt.ADD,this.handleFeatureAdd_,this),W(this.features_,lt.REMOVE,this.handleFeatureRemove_,this)):this.source_&&r.push(W(this.source_,gt.ADDFEATURE,this.handleFeatureAdd_,this),W(this.source_,gt.REMOVEFEATURE,this.handleFeatureRemove_,this)),n.forEach(s=>this.addFeature(s)))}snapTo(e,t,r){r.getView().getProjection();const n=K(t),s=br(Dr(ie([n]),r.getView().getResolution()*this.pixelTolerance_)),o=this.rBush_.getInExtent(s),a=o.length;if(a===0)return null;let c,l=1/0;const u=this.pixelTolerance_*this.pixelTolerance_,h=()=>{if(c){const d=r.getPixelFromCoordinate(c);if(Te(e,d)<=u)return{vertex:c,vertexPixel:[Math.round(d[0]),Math.round(d[1])]}}return null};if(this.vertex_){for(let f=0;f<a;++f){const T=o[f];T.feature.getGeometry().getType()!=="Circle"&&T.segment.forEach(p=>{const E=K(p),y=Te(n,E);y<l&&(c=p,l=y)})}const d=h();if(d)return d}if(this.edge_){for(let f=0;f<a;++f){let T=null;const p=o[f];if(p.feature.getGeometry().getType()==="Circle"){let E=p.feature.getGeometry();T=wr(n,E)}else{const[E,y]=p.segment;y&&(Ge[0]=K(E),Ge[1]=K(y),T=Ir(n,Ge))}if(T){const E=Te(n,T);E<l&&(c=vr(T),l=E)}}const d=h();if(d)return d}return null}updateFeature_(e){this.removeFeature(e,!1),this.addFeature(e,!1)}segmentCircleGeometry_(e,t){this.getMap().getView().getProjection();const s=Ur(t).getCoordinates()[0];for(let o=0,a=s.length-1;o<a;++o)e.push(s.slice(o,o+2))}segmentGeometryCollectionGeometry_(e,t){const r=t.getGeometriesArray();for(let n=0;n<r.length;++n){const s=this.GEOMETRY_SEGMENTERS_[r[n].getType()];s&&s(e,r[n])}}segmentLineStringGeometry_(e,t){const r=t.getCoordinates();for(let n=0,s=r.length-1;n<s;++n)e.push(r.slice(n,n+2))}segmentMultiLineStringGeometry_(e,t){const r=t.getCoordinates();for(let n=0,s=r.length;n<s;++n){const o=r[n];for(let a=0,c=o.length-1;a<c;++a)e.push(o.slice(a,a+2))}}segmentMultiPointGeometry_(e,t){t.getCoordinates().forEach(r=>{e.push([r])})}segmentMultiPolygonGeometry_(e,t){const r=t.getCoordinates();for(let n=0,s=r.length;n<s;++n){const o=r[n];for(let a=0,c=o.length;a<c;++a){const l=o[a];for(let u=0,h=l.length-1;u<h;++u)e.push(l.slice(u,u+2))}}}segmentPointGeometry_(e,t){e.push([t.getCoordinates()])}segmentPolygonGeometry_(e,t){const r=t.getCoordinates();for(let n=0,s=r.length;n<s;++n){const o=r[n];for(let a=0,c=o.length-1;a<c;++a)e.push(o.slice(a,a+2))}}}const mn=pn;function ye(i){return i instanceof Image||i instanceof HTMLCanvasElement||i instanceof HTMLVideoElement?i:null}function ze(i){return i instanceof Uint8Array||i instanceof Uint8ClampedArray||i instanceof Float32Array||i instanceof DataView?i:null}let re=null;function Rn(i){re||(re=Ve(i.width,i.height,void 0,{willReadFrequently:!0}));const e=re.canvas,t=i.width;e.width!==t&&(e.width=t);const r=i.height;return e.height!==r&&(e.height=r),re.drawImage(i,t,r),re.getImageData(0,0,t,r).data}const xn=[256,256];class yn extends Gr{constructor(e){const t=S.IDLE;super(e.tileCoord,t,{transition:e.transition,interpolate:e.interpolate}),this.loader_=e.loader,this.data_=null,this.error_=null,this.size_=e.size||null}getSize(){if(this.size_)return this.size_;const e=ye(this.data_);return e?[e.width,e.height]:xn}getData(){return this.data_}getError(){return this.error_}load(){if(this.state!==S.IDLE&&this.state!==S.ERROR)return;this.state=S.LOADING,this.changed();const e=this;this.loader_().then(function(t){e.data_=t,e.state=S.LOADED,e.changed()}).catch(function(t){e.error_=t,e.state=S.ERROR,e.changed()})}}const $t=yn;class Cn extends $t{constructor(e){super({tileCoord:e.tileCoord,loader:()=>Promise.resolve(new Uint8Array(4)),interpolate:e.interpolate,transition:e.transition}),this.pixelRatio_=e.pixelRatio,this.gutter_=e.gutter,this.reprojData_=null,this.reprojError_=null,this.reprojSize_=void 0,this.sourceTileGrid_=e.sourceTileGrid,this.targetTileGrid_=e.targetTileGrid,this.wrappedTileCoord_=e.wrappedTileCoord||e.tileCoord,this.sourceTiles_=[],this.sourcesListenerKeys_=null,this.sourceZ_=0;const t=this.targetTileGrid_.getTileCoordExtent(this.wrappedTileCoord_),r=this.targetTileGrid_.getExtent();let n=this.sourceTileGrid_.getExtent();const s=r?J(t,r):t;if(ht(s)===0){this.state=S.EMPTY;return}const o=e.sourceProj,a=o.getExtent();a&&(n?n=J(n,a):n=a);const c=this.targetTileGrid_.getResolution(this.wrappedTileCoord_[0]),l=e.targetProj,u=Nr(o,l,s,c);if(!isFinite(u)||u<=0){this.state=S.EMPTY;return}const h=e.errorThreshold!==void 0?e.errorThreshold:Mr;if(this.triangulation_=new Fr(o,l,s,n,u*h,c),this.triangulation_.getTriangles().length===0){this.state=S.EMPTY;return}this.sourceZ_=this.sourceTileGrid_.getZForResolution(u);let d=this.triangulation_.calculateSourceExtent();if(n&&(o.canWrapX()?(d[1]=Be(d[1],n[1],n[3]),d[3]=Be(d[3],n[1],n[3])):d=J(d,n)),!ht(d))this.state=S.EMPTY;else{const f=this.sourceTileGrid_.getTileRangeForExtentAndZ(d,this.sourceZ_),T=e.getTileFunction;for(let p=f.minX;p<=f.maxX;p++)for(let E=f.minY;E<=f.maxY;E++){const y=T(this.sourceZ_,p,E,this.pixelRatio_);y&&this.sourceTiles_.push(y)}this.sourceTiles_.length===0&&(this.state=S.EMPTY)}}getSize(){return this.reprojSize_}getData(){return this.reprojData_}getError(){return this.reprojError_}reproject_(){const e=[];if(this.sourceTiles_.forEach(t=>{if(!t||t.getState()!==S.LOADED)return;const r=t.getSize(),n=this.gutter_;let s;const o=ze(t.getData());o?s=o:s=Rn(ye(t.getData()));const a=[r[0]+2*n,r[1]+2*n],c=s instanceof Float32Array,l=a[0]*a[1],u=c?Float32Array:Uint8Array,h=new u(s.buffer),d=u.BYTES_PER_ELEMENT,f=d*h.length/l,T=h.byteLength/a[1],p=Math.floor(T/d/a[0]),E=l*p;let y=h;if(h.length!==E){y=new u(E);let x=0,C=0;const L=a[0]*p;for(let w=0;w<a[1];++w){for(let I=0;I<L;++I)y[x++]=h[C+I];C+=T/d}}e.push({extent:this.sourceTileGrid_.getTileCoordExtent(t.tileCoord),data:new Uint8Array(y.buffer),dataType:u,bytesPerPixel:f,pixelSize:a})}),this.sourceTiles_.length=0,e.length===0)this.state=S.ERROR;else{const t=this.wrappedTileCoord_[0],r=this.targetTileGrid_.getTileSize(t),n=typeof r=="number"?r:r[0],s=typeof r=="number"?r:r[1],o=this.targetTileGrid_.getResolution(t),a=this.sourceTileGrid_.getResolution(this.sourceZ_),c=this.targetTileGrid_.getTileCoordExtent(this.wrappedTileCoord_);let l,u;const h=e[0].bytesPerPixel,d=Math.ceil(h/3);for(let f=d-1;f>=0;--f){const T=[];for(let L=0,w=e.length;L<w;++L){const I=e[L],A=I.data,P=I.pixelSize,U=P[0],v=P[1],G=Ve(U,v,we),O=G.createImageData(U,v),N=O.data;let X=f*3;for(let k=0,be=N.length;k<be;k+=4)N[k]=A[X],N[k+1]=A[X+1],N[k+2]=A[X+2],N[k+3]=255,X+=h;G.putImageData(O,0,0),T.push({extent:I.extent,image:G.canvas})}const p=Or(n,s,this.pixelRatio_,a,this.sourceTileGrid_.getExtent(),o,c,this.triangulation_,T,this.gutter_,!1,!1);for(let L=0,w=T.length;L<w;++L){const A=T[L].image.getContext("2d");ut(A),we.push(A.canvas)}const E=p.getContext("2d"),y=E.getImageData(0,0,p.width,p.height);ut(E),we.push(p),l||(u=new Uint8Array(h*y.width*y.height),l=new e[0].dataType(u.buffer));const x=y.data;let C=f*3;for(let L=0,w=x.length;L<w;L+=4)x[L+3]===255?(u[C]=x[L],u[C+1]=x[L+1],u[C+2]=x[L+2]):(u[C]=0,u[C+1]=0,u[C+2]=0),C+=h}this.reprojData_=l,this.reprojSize_=[Math.round(n*this.pixelRatio_),Math.round(s*this.pixelRatio_)],this.state=S.LOADED}this.changed()}load(){if(this.state!==S.IDLE&&this.state!==S.ERROR)return;this.state=S.LOADING,this.changed();let e=0;this.sourcesListenerKeys_=[],this.sourceTiles_.forEach(t=>{const r=t.getState();if(r!==S.IDLE&&r!==S.LOADING)return;e++;const n=W(t,H.CHANGE,function(){const s=t.getState();(s==S.LOADED||s==S.ERROR||s==S.EMPTY)&&(se(n),e--,e===0&&(this.unlistenSources_(),this.reproject_()))},this);this.sourcesListenerKeys_.push(n)}),e===0?setTimeout(this.reproject_.bind(this),0):this.sourceTiles_.forEach(function(t){t.getState()==S.IDLE&&t.load()})}unlistenSources_(){this.sourcesListenerKeys_.forEach(se),this.sourcesListenerKeys_=null}}const Et=Cn,Ke=34962,Ze=34963,Ln=35040,qe=35044,Sn=35048,An=5121,Pn=5123,bn=5125,Xt=5126,pt=["experimental-webgl","webgl","webkit-3d","moz-webgl"];function kt(i,e){e=Object.assign({preserveDrawingBuffer:!0,antialias:!Br},e);const t=pt.length;for(let r=0;r<t;++r)try{const n=i.getContext(pt[r],e);if(n)return n}catch{}return null}const Dn={STATIC_DRAW:qe,STREAM_DRAW:Ln,DYNAMIC_DRAW:Sn};class wn{constructor(e,t){this.array=null,this.type=e,$r(e===Ke||e===Ze,62),this.usage=t!==void 0?t:Dn.STATIC_DRAW}ofSize(e){this.array=new(Oe(this.type))(e)}fromArray(e){this.array=Oe(this.type).from(e)}fromArrayBuffer(e){this.array=new(Oe(this.type))(e)}getType(){return this.type}getArray(){return this.array}getUsage(){return this.usage}getSize(){return this.array?this.array.length:0}}function Oe(i){switch(i){case Ke:return Float32Array;case Ze:return Uint32Array;default:return Float32Array}}const jt=wn;function zt(i,e,t){const r=t?i.LINEAR:i.NEAREST;i.bindTexture(i.TEXTURE_2D,e),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_S,i.CLAMP_TO_EDGE),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_T,i.CLAMP_TO_EDGE),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MIN_FILTER,r),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MAG_FILTER,r)}function In(i,e,t,r){zt(i,e,r),i.texImage2D(i.TEXTURE_2D,0,i.RGBA,i.RGBA,i.UNSIGNED_BYTE,t)}function mt(i,e,t,r,n,s){const o=i.getGL();let a,c;t instanceof Float32Array?(a=o.FLOAT,i.getExtension("OES_texture_float"),c=i.getExtension("OES_texture_float_linear")!==null):(a=o.UNSIGNED_BYTE,c=!0),zt(o,e,s&&c);const l=t.byteLength/r[1];let u=1;l%8===0?u=8:l%4===0?u=4:l%2===0&&(u=2);let h;switch(n){case 1:{h=o.LUMINANCE;break}case 2:{h=o.LUMINANCE_ALPHA;break}case 3:{h=o.RGB;break}case 4:{h=o.RGBA;break}default:throw new Error(`Unsupported number of bands: ${n}`)}const d=o.getParameter(o.UNPACK_ALIGNMENT);o.pixelStorei(o.UNPACK_ALIGNMENT,u),o.texImage2D(o.TEXTURE_2D,0,h,r[0],r[1],0,h,a,t),o.pixelStorei(o.UNPACK_ALIGNMENT,d)}let Y=null;function Un(){Y=Ve(1,1,void 0,{willReadFrequently:!0})}class vn extends Xr{constructor(e){super(),this.tile,this.textures=[],this.handleTileChange_=this.handleTileChange_.bind(this),this.renderSize_=$e(e.grid.getTileSize(e.tile.tileCoord[0])),this.gutter_=e.gutter||0,this.bandCount=NaN,this.helper_=e.helper;const t=new jt(Ke,qe);t.fromArray([0,1,1,1,1,0,0,0]),this.helper_.flushBufferData(t),this.coords=t,this.setTile(e.tile)}setTile(e){if(e!==this.tile)if(this.tile&&this.tile.removeEventListener(H.CHANGE,this.handleTileChange_),this.tile=e,this.textures.length=0,this.loaded=e.getState()===S.LOADED,this.loaded)this.uploadTile_();else{if(e instanceof dt){const t=e.getImage();t instanceof Image&&!t.crossOrigin&&(t.crossOrigin="anonymous")}e.addEventListener(H.CHANGE,this.handleTileChange_)}}uploadTile_(){const e=this.helper_,t=e.getGL(),r=this.tile;let n;r instanceof dt||r instanceof Xe?n=r.getImage():n=r.getData();const s=ye(n);if(s){const x=t.createTexture();this.textures.push(x),this.bandCount=4,In(t,x,s,r.interpolate);return}n=ze(n);const o=r.getSize(),a=[o[0]+2*this.gutter_,o[1]+2*this.gutter_],c=n instanceof Float32Array,l=a[0]*a[1],u=c?Float32Array:Uint8Array,h=u.BYTES_PER_ELEMENT,d=n.byteLength/a[1];this.bandCount=Math.floor(d/h/a[0]);const f=Math.ceil(this.bandCount/4);if(f===1){const x=t.createTexture();this.textures.push(x),mt(e,x,n,a,this.bandCount,r.interpolate);return}const T=new Array(f);for(let x=0;x<f;++x){const C=t.createTexture();this.textures.push(C);const L=x<f-1?4:(this.bandCount-1)%4+1;T[x]=new u(l*L)}let p=0,E=0;const y=a[0]*this.bandCount;for(let x=0;x<a[1];++x){for(let C=0;C<y;++C){const L=n[E+C],w=Math.floor(p/this.bandCount),I=C%this.bandCount,A=Math.floor(I/4),P=T[A],U=P.length/l,v=I%4;P[w*U+v]=L,++p}E+=d/h}for(let x=0;x<f;++x){const C=this.textures[x],L=T[x],w=L.length/l;mt(e,C,L,a,w,r.interpolate)}}handleTileChange_(){this.tile.getState()===S.LOADED&&(this.loaded=!0,this.uploadTile_(),this.dispatchEvent(H.CHANGE))}disposeInternal(){const e=this.helper_.getGL();this.helper_.deleteBuffer(this.coords);for(let t=0;t<this.textures.length;++t)e.deleteTexture(this.textures[t]);this.tile.removeEventListener(H.CHANGE,this.handleTileChange_)}getImagePixelData_(e,t,r){const n=this.gutter_,s=this.renderSize_[0],o=this.renderSize_[1];Y||Un(),Y.clearRect(0,0,1,1);const a=e.width,c=e.height,l=a-2*n,u=c-2*n,h=n+Math.floor(l*(t/s)),d=n+Math.floor(u*(r/o));let f;try{Y.drawImage(e,h,d,1,1,0,0,1,1),f=Y.getImageData(0,0,1,1).data}catch{return Y=null,null}return f}getArrayPixelData_(e,t,r,n){const s=this.gutter_,o=this.renderSize_[0],a=this.renderSize_[1],c=t[0],l=t[1],u=c+2*s,h=l+2*s,d=s+Math.floor(c*(r/o)),f=s+Math.floor(l*(n/a));if(e instanceof DataView){const p=e.byteLength/(u*h),E=p*(f*u+d),y=e.buffer.slice(E,E+p);return new DataView(y)}const T=this.bandCount*(f*u+d);return e.slice(T,T+this.bandCount)}getPixelData(e,t){if(!this.loaded)return null;if(this.tile instanceof $t){const r=this.tile.getData(),n=ze(r);if(n){const s=this.tile.getSize();return this.getArrayPixelData_(n,s,e,t)}return this.getImagePixelData_(ye(r),e,t)}return this.getImagePixelData_(this.tile.getImage(),e,t)}}const Gn=vn,ge={LOST:"webglcontextlost",RESTORED:"webglcontextrestored"},On=`
  precision mediump float;
  
  attribute vec2 a_position;
  varying vec2 v_texCoord;
  varying vec2 v_screenCoord;
  
  uniform vec2 u_screenSize;
   
  void main() {
    v_texCoord = a_position * 0.5 + 0.5;
    v_screenCoord = v_texCoord * u_screenSize;
    gl_Position = vec4(a_position, 0.0, 1.0);
  }
`,Nn=`
  precision mediump float;
   
  uniform sampler2D u_image;
  uniform float u_opacity;
   
  varying vec2 v_texCoord;
   
  void main() {
    gl_FragColor = texture2D(u_image, v_texCoord) * u_opacity;
  }
`;class Mn{constructor(e){this.gl_=e.webGlContext;const t=this.gl_;this.scaleRatio_=e.scaleRatio||1,this.renderTargetTexture_=t.createTexture(),this.renderTargetTextureSize_=null,this.frameBuffer_=t.createFramebuffer();const r=t.createShader(t.VERTEX_SHADER);t.shaderSource(r,e.vertexShader||On),t.compileShader(r);const n=t.createShader(t.FRAGMENT_SHADER);t.shaderSource(n,e.fragmentShader||Nn),t.compileShader(n),this.renderTargetProgram_=t.createProgram(),t.attachShader(this.renderTargetProgram_,r),t.attachShader(this.renderTargetProgram_,n),t.linkProgram(this.renderTargetProgram_),this.renderTargetVerticesBuffer_=t.createBuffer();const s=[-1,-1,1,-1,-1,1,1,-1,1,1,-1,1];t.bindBuffer(t.ARRAY_BUFFER,this.renderTargetVerticesBuffer_),t.bufferData(t.ARRAY_BUFFER,new Float32Array(s),t.STATIC_DRAW),this.renderTargetAttribLocation_=t.getAttribLocation(this.renderTargetProgram_,"a_position"),this.renderTargetUniformLocation_=t.getUniformLocation(this.renderTargetProgram_,"u_screenSize"),this.renderTargetOpacityLocation_=t.getUniformLocation(this.renderTargetProgram_,"u_opacity"),this.renderTargetTextureLocation_=t.getUniformLocation(this.renderTargetProgram_,"u_image"),this.uniforms_=[],e.uniforms&&Object.keys(e.uniforms).forEach(o=>{this.uniforms_.push({value:e.uniforms[o],location:t.getUniformLocation(this.renderTargetProgram_,o)})})}getGL(){return this.gl_}init(e){const t=this.getGL(),r=[t.drawingBufferWidth*this.scaleRatio_,t.drawingBufferHeight*this.scaleRatio_];if(t.bindFramebuffer(t.FRAMEBUFFER,this.getFrameBuffer()),t.viewport(0,0,r[0],r[1]),!this.renderTargetTextureSize_||this.renderTargetTextureSize_[0]!==r[0]||this.renderTargetTextureSize_[1]!==r[1]){this.renderTargetTextureSize_=r;const n=0,s=t.RGBA,o=0,a=t.RGBA,c=t.UNSIGNED_BYTE,l=null;t.bindTexture(t.TEXTURE_2D,this.renderTargetTexture_),t.texImage2D(t.TEXTURE_2D,n,s,r[0],r[1],o,a,c,l),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,this.renderTargetTexture_,0)}}apply(e,t,r,n){const s=this.getGL(),o=e.size;if(s.bindFramebuffer(s.FRAMEBUFFER,t?t.getFrameBuffer():null),s.activeTexture(s.TEXTURE0),s.bindTexture(s.TEXTURE_2D,this.renderTargetTexture_),!t){const c=M(s.canvas);if(!e.renderTargets[c]){const l=s.getContextAttributes();l&&l.preserveDrawingBuffer&&(s.clearColor(0,0,0,0),s.clear(s.COLOR_BUFFER_BIT)),e.renderTargets[c]=!0}}s.enable(s.BLEND),s.blendFunc(s.ONE,s.ONE_MINUS_SRC_ALPHA),s.viewport(0,0,s.drawingBufferWidth,s.drawingBufferHeight),s.bindBuffer(s.ARRAY_BUFFER,this.renderTargetVerticesBuffer_),s.useProgram(this.renderTargetProgram_),s.enableVertexAttribArray(this.renderTargetAttribLocation_),s.vertexAttribPointer(this.renderTargetAttribLocation_,2,s.FLOAT,!1,0,0),s.uniform2f(this.renderTargetUniformLocation_,o[0],o[1]),s.uniform1i(this.renderTargetTextureLocation_,0);const a=e.layerStatesArray[e.layerIndex].opacity;s.uniform1f(this.renderTargetOpacityLocation_,a),this.applyUniforms(e),r&&r(s,e),s.drawArrays(s.TRIANGLES,0,6),n&&n(s,e)}getFrameBuffer(){return this.frameBuffer_}applyUniforms(e){const t=this.getGL();let r,n=1;this.uniforms_.forEach(function(s){if(r=typeof s.value=="function"?s.value(e):s.value,r instanceof HTMLCanvasElement||r instanceof ImageData)s.texture||(s.texture=t.createTexture()),t.activeTexture(t[`TEXTURE${n}`]),t.bindTexture(t.TEXTURE_2D,s.texture),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),r instanceof ImageData?t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,r.width,r.height,0,t.UNSIGNED_BYTE,new Uint8Array(r.data)):t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,r),t.uniform1i(s.location,n++);else if(Array.isArray(r))switch(r.length){case 2:t.uniform2f(s.location,r[0],r[1]);return;case 3:t.uniform3f(s.location,r[0],r[1],r[2]);return;case 4:t.uniform4f(s.location,r[0],r[1],r[2],r[3]);return;default:return}else typeof r=="number"&&t.uniform1f(s.location,r)})}}const Rt=Mn;function Ht(){return[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]}function me(i,e){return i[0]=e[0],i[1]=e[1],i[4]=e[2],i[5]=e[3],i[12]=e[4],i[13]=e[5],i}const z={PROJECTION_MATRIX:"u_projectionMatrix",OFFSET_SCALE_MATRIX:"u_offsetScaleMatrix",OFFSET_ROTATION_MATRIX:"u_offsetRotateMatrix",TIME:"u_time",ZOOM:"u_zoom",RESOLUTION:"u_resolution",SIZE_PX:"u_sizePx",PIXEL_RATIO:"u_pixelRatio"},ne={UNSIGNED_BYTE:An,UNSIGNED_SHORT:Pn,UNSIGNED_INT:bn,FLOAT:Xt},Ce={};function xt(i){return"shared/"+i}let yt=0;function Fn(){const i="unique/"+yt;return yt+=1,i}function Bn(i){let e=Ce[i];if(!e){const t=document.createElement("canvas");t.style.position="absolute",t.style.left="0",e={users:0,canvas:t},Ce[i]=e}return e.users+=1,e.canvas}function $n(i){const e=Ce[i];if(!e||(e.users-=1,e.users>0))return;const t=e.canvas,n=kt(t).getExtension("WEBGL_lose_context");n&&n.loseContext(),delete Ce[i]}class Xn extends kr{constructor(e){super(),e=e||{},this.boundHandleWebGLContextLost_=this.handleWebGLContextLost.bind(this),this.boundHandleWebGLContextRestored_=this.handleWebGLContextRestored.bind(this),this.canvasCacheKey_=e.canvasCacheKey?xt(e.canvasCacheKey):Fn(),this.canvas_=Bn(this.canvasCacheKey_),this.gl_=kt(this.canvas_),this.bufferCache_={},this.extensionCache_={},this.currentProgram_=null,this.canvas_.addEventListener(ge.LOST,this.boundHandleWebGLContextLost_),this.canvas_.addEventListener(ge.RESTORED,this.boundHandleWebGLContextRestored_),this.offsetRotateMatrix_=xe(),this.offsetScaleMatrix_=xe(),this.tmpMat4_=Ht(),this.uniformLocations_={},this.attribLocations_={},this.uniforms_=[],e.uniforms&&this.setUniforms(e.uniforms);const t=this.getGL();this.postProcessPasses_=e.postProcesses?e.postProcesses.map(function(r){return new Rt({webGlContext:t,scaleRatio:r.scaleRatio,vertexShader:r.vertexShader,fragmentShader:r.fragmentShader,uniforms:r.uniforms})}):[new Rt({webGlContext:t})],this.shaderCompileErrors_=null,this.startTime_=Date.now()}setUniforms(e){this.uniforms_=[];for(const t in e)this.uniforms_.push({name:t,value:e[t]});this.uniformLocations_={}}canvasCacheKeyMatches(e){return this.canvasCacheKey_===xt(e)}getExtension(e){if(e in this.extensionCache_)return this.extensionCache_[e];const t=this.gl_.getExtension(e);return this.extensionCache_[e]=t,t}bindBuffer(e){const t=this.getGL(),r=M(e);let n=this.bufferCache_[r];if(!n){const s=t.createBuffer();n={buffer:e,webGlBuffer:s},this.bufferCache_[r]=n}t.bindBuffer(e.getType(),n.webGlBuffer)}flushBufferData(e){const t=this.getGL();this.bindBuffer(e),t.bufferData(e.getType(),e.getArray(),e.getUsage())}deleteBuffer(e){const t=this.getGL(),r=M(e),n=this.bufferCache_[r];n&&!t.isContextLost()&&t.deleteBuffer(n.webGlBuffer),delete this.bufferCache_[r]}disposeInternal(){this.canvas_.removeEventListener(ge.LOST,this.boundHandleWebGLContextLost_),this.canvas_.removeEventListener(ge.RESTORED,this.boundHandleWebGLContextRestored_),$n(this.canvasCacheKey_),delete this.gl_,delete this.canvas_}prepareDraw(e,t){const r=this.getGL(),n=this.getCanvas(),s=e.size,o=e.pixelRatio;n.width=s[0]*o,n.height=s[1]*o,n.style.width=s[0]+"px",n.style.height=s[1]+"px";for(let a=this.postProcessPasses_.length-1;a>=0;a--)this.postProcessPasses_[a].init(e);r.bindTexture(r.TEXTURE_2D,null),r.clearColor(0,0,0,0),r.clear(r.COLOR_BUFFER_BIT),r.enable(r.BLEND),r.blendFunc(r.ONE,t?r.ZERO:r.ONE_MINUS_SRC_ALPHA)}prepareDrawToRenderTarget(e,t,r){const n=this.getGL(),s=t.getSize();n.bindFramebuffer(n.FRAMEBUFFER,t.getFramebuffer()),n.viewport(0,0,s[0],s[1]),n.bindTexture(n.TEXTURE_2D,t.getTexture()),n.clearColor(0,0,0,0),n.clear(n.COLOR_BUFFER_BIT),n.enable(n.BLEND),n.blendFunc(n.ONE,r?n.ZERO:n.ONE_MINUS_SRC_ALPHA)}drawElements(e,t){const r=this.getGL();this.getExtension("OES_element_index_uint");const n=r.UNSIGNED_INT,s=4,o=t-e,a=e*s;r.drawElements(r.TRIANGLES,o,n,a)}finalizeDraw(e,t,r){for(let n=0,s=this.postProcessPasses_.length;n<s;n++)n===s-1?this.postProcessPasses_[n].apply(e,null,t,r):this.postProcessPasses_[n].apply(e,this.postProcessPasses_[n+1])}getCanvas(){return this.canvas_}getGL(){return this.gl_}applyFrameState(e){const t=e.size,r=e.viewState.rotation,n=e.pixelRatio,s=pe(this.offsetScaleMatrix_);ke(s,2/t[0],2/t[1]);const o=pe(this.offsetRotateMatrix_);r!==0&&Gt(o,-r),this.setUniformMatrixValue(z.OFFSET_SCALE_MATRIX,me(this.tmpMat4_,s)),this.setUniformMatrixValue(z.OFFSET_ROTATION_MATRIX,me(this.tmpMat4_,o)),this.setUniformFloatValue(z.TIME,(Date.now()-this.startTime_)*.001),this.setUniformFloatValue(z.ZOOM,e.viewState.zoom),this.setUniformFloatValue(z.RESOLUTION,e.viewState.resolution),this.setUniformFloatValue(z.PIXEL_RATIO,n),this.setUniformFloatVec2(z.SIZE_PX,[t[0],t[1]])}applyUniforms(e){const t=this.getGL();let r,n=0;this.uniforms_.forEach(s=>{if(r=typeof s.value=="function"?s.value(e):s.value,r instanceof HTMLCanvasElement||r instanceof HTMLImageElement||r instanceof ImageData)s.texture||(s.prevValue=void 0,s.texture=t.createTexture()),t.activeTexture(t[`TEXTURE${n}`]),t.bindTexture(t.TEXTURE_2D,s.texture),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),(!(r instanceof HTMLImageElement)||r.complete)&&s.prevValue!==r&&(s.prevValue=r,t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,r)),t.uniform1i(this.getUniformLocation(s.name),n++);else if(Array.isArray(r)&&r.length===6)this.setUniformMatrixValue(s.name,me(this.tmpMat4_,r));else if(Array.isArray(r)&&r.length<=4)switch(r.length){case 2:t.uniform2f(this.getUniformLocation(s.name),r[0],r[1]);return;case 3:t.uniform3f(this.getUniformLocation(s.name),r[0],r[1],r[2]);return;case 4:t.uniform4f(this.getUniformLocation(s.name),r[0],r[1],r[2],r[3]);return;default:return}else typeof r=="number"&&t.uniform1f(this.getUniformLocation(s.name),r)})}useProgram(e,t){this.getGL().useProgram(e),this.currentProgram_=e,this.uniformLocations_={},this.attribLocations_={},this.applyFrameState(t),this.applyUniforms(t)}compileShader(e,t){const r=this.getGL(),n=r.createShader(t);return r.shaderSource(n,e),r.compileShader(n),n}getProgram(e,t){const r=this.getGL(),n=this.compileShader(e,r.FRAGMENT_SHADER),s=this.compileShader(t,r.VERTEX_SHADER),o=r.createProgram();if(r.attachShader(o,n),r.attachShader(o,s),r.linkProgram(o),!r.getShaderParameter(n,r.COMPILE_STATUS)){const a=`Fragment shader compilation failed: ${r.getShaderInfoLog(n)}`;throw new Error(a)}if(r.deleteShader(n),!r.getShaderParameter(s,r.COMPILE_STATUS)){const a=`Vertex shader compilation failed: ${r.getShaderInfoLog(s)}`;throw new Error(a)}if(r.deleteShader(s),!r.getProgramParameter(o,r.LINK_STATUS)){const a=`GL program linking failed: ${r.getShaderInfoLog(s)}`;throw new Error(a)}return o}getUniformLocation(e){return this.uniformLocations_[e]===void 0&&(this.uniformLocations_[e]=this.getGL().getUniformLocation(this.currentProgram_,e)),this.uniformLocations_[e]}getAttributeLocation(e){return this.attribLocations_[e]===void 0&&(this.attribLocations_[e]=this.getGL().getAttribLocation(this.currentProgram_,e)),this.attribLocations_[e]}makeProjectionTransform(e,t){const r=e.size,n=e.viewState.rotation,s=e.viewState.resolution,o=e.viewState.center;return pe(t),Ot(t,0,0,2/(s*r[0]),2/(s*r[1]),-n,-o[0],-o[1]),t}setUniformFloatValue(e,t){this.getGL().uniform1f(this.getUniformLocation(e),t)}setUniformFloatVec2(e,t){this.getGL().uniform2fv(this.getUniformLocation(e),t)}setUniformFloatVec4(e,t){this.getGL().uniform4fv(this.getUniformLocation(e),t)}setUniformMatrixValue(e,t){this.getGL().uniformMatrix4fv(this.getUniformLocation(e),!1,t)}enableAttributeArray_(e,t,r,n,s){const o=this.getAttributeLocation(e);o<0||(this.getGL().enableVertexAttribArray(o),this.getGL().vertexAttribPointer(o,t,r,!1,n,s))}enableAttributes(e){const t=kn(e);let r=0;for(let n=0;n<e.length;n++){const s=e[n];this.enableAttributeArray_(s.name,s.size,s.type||Xt,t,r),r+=s.size*Vt(s.type)}}handleWebGLContextLost(){jr(this.bufferCache_),this.currentProgram_=null}handleWebGLContextRestored(){}createTexture(e,t,r){const n=this.getGL();r=r||n.createTexture();const s=0,o=n.RGBA,a=0,c=n.RGBA,l=n.UNSIGNED_BYTE;return n.bindTexture(n.TEXTURE_2D,r),t?n.texImage2D(n.TEXTURE_2D,s,o,c,l,t):n.texImage2D(n.TEXTURE_2D,s,o,e[0],e[1],a,c,l,null),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MIN_FILTER,n.LINEAR),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_S,n.CLAMP_TO_EDGE),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_T,n.CLAMP_TO_EDGE),r}}function kn(i){let e=0;for(let t=0;t<i.length;t++){const r=i[t];e+=r.size*Vt(r.type)}return e}function Vt(i){switch(i){case ne.UNSIGNED_BYTE:return Uint8Array.BYTES_PER_ELEMENT;case ne.UNSIGNED_SHORT:return Uint16Array.BYTES_PER_ELEMENT;case ne.UNSIGNED_INT:return Uint32Array.BYTES_PER_ELEMENT;case ne.FLOAT:default:return Float32Array.BYTES_PER_ELEMENT}}class Je extends zr{constructor(e,t){super(e),t=t||{},this.inversePixelTransform_=xe(),this.pixelContext_=null,this.postProcesses_=t.postProcesses,this.uniforms_=t.uniforms,this.helper,e.addChangeListener(Nt.MAP,this.removeHelper.bind(this)),this.dispatchPreComposeEvent=this.dispatchPreComposeEvent.bind(this),this.dispatchPostComposeEvent=this.dispatchPostComposeEvent.bind(this)}dispatchPreComposeEvent(e,t){const r=this.getLayer();if(r.hasListener(V.PRECOMPOSE)){const n=new Ie(V.PRECOMPOSE,void 0,t,e);r.dispatchEvent(n)}}dispatchPostComposeEvent(e,t){const r=this.getLayer();if(r.hasListener(V.POSTCOMPOSE)){const n=new Ie(V.POSTCOMPOSE,void 0,t,e);r.dispatchEvent(n)}}reset(e){this.uniforms_=e.uniforms,this.helper&&this.helper.setUniforms(this.uniforms_)}removeHelper(){this.helper&&(this.helper.dispose(),delete this.helper)}prepareFrame(e){if(this.getLayer().getRenderSource()){let t=!0,r=-1,n;for(let o=0,a=e.layerStatesArray.length;o<a;o++){const c=e.layerStatesArray[o].layer,l=c.getRenderer();if(!(l instanceof Je)){t=!0;continue}const u=c.getClassName();if((t||u!==n)&&(r+=1,t=!1),n=u,l===this)break}const s="map/"+e.mapId+"/group/"+r;(!this.helper||!this.helper.canvasCacheKeyMatches(s))&&(this.removeHelper(),this.helper=new Xn({postProcesses:this.postProcesses_,uniforms:this.uniforms_,canvasCacheKey:s}),n&&(this.helper.getCanvas().className=n),this.afterHelperCreated())}return this.prepareFrameInternal(e)}afterHelperCreated(){}prepareFrameInternal(e){return!0}disposeInternal(){this.removeHelper(),super.disposeInternal()}dispatchRenderEvent_(e,t,r){const n=this.getLayer();if(n.hasListener(e)){Ot(this.inversePixelTransform_,0,0,r.pixelRatio,-r.pixelRatio,0,0,-r.size[1]);const s=new Ie(e,this.inversePixelTransform_,r,t);n.dispatchEvent(s)}}preRender(e,t){this.dispatchRenderEvent_(V.PRERENDER,e,t)}postRender(e,t){this.dispatchRenderEvent_(V.POSTRENDER,e,t)}}const jn=Je,m={TILE_TEXTURE_ARRAY:"u_tileTextures",TILE_TRANSFORM:"u_tileTransform",TRANSITION_ALPHA:"u_transitionAlpha",DEPTH:"u_depth",TEXTURE_PIXEL_WIDTH:"u_texturePixelWidth",TEXTURE_PIXEL_HEIGHT:"u_texturePixelHeight",TEXTURE_RESOLUTION:"u_textureResolution",TEXTURE_ORIGIN_X:"u_textureOriginX",TEXTURE_ORIGIN_Y:"u_textureOriginY",RENDER_EXTENT:"u_renderExtent",RESOLUTION:"u_resolution",ZOOM:"u_zoom"},Re={TEXTURE_COORD:"a_textureCoord"},zn=[{name:Re.TEXTURE_COORD,size:2,type:ne.FLOAT}],Hn={};function Vn(i){return 2*(1-1/(i+1))-1}function Wn(){return{tileIds:new Set,texturesByZ:{}}}function Ct(i,e){return i.tileIds.has(M(e))}function Lt(i,e,t){const r=i.texturesByZ;t in r||(r[t]=new Set),r[t].add(e),i.tileIds.add(M(e.tile))}function Ne(i,e){const t=i.layerStatesArray[i.layerIndex];t.extent&&(e=J(e,Mt(t.extent,i.viewState.projection)));const r=t.layer.getRenderSource();if(!r.getWrapX()){const n=r.getTileGridForProjection(i.viewState.projection).getExtent();n&&(e=J(e,n))}return e}function Me(i,e){return`${i.getKey()},${je(e)}`}class Yn extends jn{constructor(e,t){super(e,{uniforms:t.uniforms}),this.renderComplete=!1,this.tileTransform_=xe(),this.tempMat4_=Ht(),this.tempTileRange_=new Hr(0,0,0,0),this.tempTileCoord_=ft(0,0,0),this.tempSize_=[0,0],this.program_,this.vertexShader_=t.vertexShader,this.fragmentShader_=t.fragmentShader,this.indices_=new jt(Ze,qe),this.indices_.fromArray([0,1,3,1,2,3]);const r=t.cacheSize!==void 0?t.cacheSize:512;this.tileTextureCache_=new Vr(r),this.paletteTextures_=t.paletteTextures||[],this.frameState_=null,this.projection_=void 0}reset(e){super.reset({uniforms:e.uniforms}),this.vertexShader_=e.vertexShader,this.fragmentShader_=e.fragmentShader,this.paletteTextures_=e.paletteTextures||[],this.helper&&(this.program_=this.helper.getProgram(this.fragmentShader_,this.vertexShader_))}afterHelperCreated(){this.program_=this.helper.getProgram(this.fragmentShader_,this.vertexShader_),this.helper.flushBufferData(this.indices_)}isDrawableTile_(e){const t=this.getLayer(),r=e.getState(),n=t.getUseInterimTilesOnError();return r==S.LOADED||r==S.EMPTY||r==S.ERROR&&!n}prepareFrameInternal(e){this.projection_?e.viewState.projection!==this.projection_&&(this.clearCache(),this.projection_=e.viewState.projection):this.projection_=e.viewState.projection;const r=this.getLayer().getRenderSource();return!r||Wr(Ne(e,e.extent))?!1:r.getState()==="ready"}enqueueTiles(e,t,r,n,s){const o=e.viewState,a=this.getLayer(),c=a.getRenderSource(),l=c.getTileGridForProjection(o.projection),u=c.getGutterForProjection(o.projection),h=M(c);h in e.wantedTiles||(e.wantedTiles[h]={});const d=e.wantedTiles[h],f=this.tileTextureCache_,T=a.getMapInternal(),p=Math.max(r-s,l.getMinZoom(),l.getZForResolution(Math.min(a.getMaxResolution(),T?T.getView().getResolutionForZoom(Math.max(a.getMinZoom(),0)):l.getResolution(0)),c.zDirection));for(let E=r;E>=p;--E){const y=l.getTileRangeForExtentAndZ(t,E,this.tempTileRange_),x=l.getResolution(E);for(let C=y.minX;C<=y.maxX;++C)for(let L=y.minY;L<=y.maxY;++L){const w=ft(E,C,L,this.tempTileCoord_),I=Me(c,w);let A,P;if(f.containsKey(I)&&(A=f.get(I),P=A.tile),(!A||A.tile.key!==c.getKey())&&(P=c.getTile(E,C,L,e.pixelRatio,o.projection)),Ct(n,P))continue;if(!A)A=new Gn({tile:P,grid:l,helper:this.helper,gutter:u}),f.set(I,A);else if(this.isDrawableTile_(P))A.setTile(P);else{const v=P.getInterimTile();A.setTile(v)}Lt(n,A,E);const U=P.getKey();d[U]=!0,P.getState()===S.IDLE&&(e.tileQueue.isKeyQueued(U)||e.tileQueue.enqueue([P,h,l.getTileCoordCenter(w),x]))}}}renderFrame(e){this.frameState_=e,this.renderComplete=!0;const t=this.helper.getGL();this.preRender(t,e);const r=e.viewState,n=this.getLayer(),s=n.getRenderSource(),o=s.getTileGridForProjection(r.projection),a=s.getGutterForProjection(r.projection),c=Ne(e,e.extent),l=o.getZForResolution(r.resolution,s.zDirection),u=Wn(),h=n.getPreload();if(e.nextExtent){const A=o.getZForResolution(r.nextResolution,s.zDirection),P=Ne(e,e.nextExtent);this.enqueueTiles(e,P,A,u,h)}this.enqueueTiles(e,c,l,u,0),h>0&&setTimeout(()=>{this.enqueueTiles(e,c,l-1,u,h-1)},0);const d={},f=M(this),T=e.time;let p=!1;for(const A of u.texturesByZ[l]){const P=A.tile;if((P instanceof Xe||P instanceof Et)&&P.getState()===S.EMPTY)continue;const U=P.tileCoord;if(A.loaded){const O=P.getAlpha(f,T);if(O===1){P.endTransition(f);continue}p=!0;const N=je(U);d[N]=O}if(this.renderComplete=!1,this.findAltTiles_(o,U,l+1,u))continue;const G=o.getMinZoom();for(let O=l-1;O>=G&&!this.findAltTiles_(o,U,O,u);--O);}this.helper.useProgram(this.program_,e),this.helper.prepareDraw(e,!p);const E=u.texturesByZ,y=Object.keys(E).map(Number).sort(Yr),x=r.center[0],C=r.center[1];for(let A=0,P=y.length;A<P;++A){const U=y[A],v=o.getResolution(U),G=$e(o.getTileSize(U),this.tempSize_),O=o.getOrigin(U),N=G[0]+2*a,X=G[1]+2*a,k=N/X,be=(x-O[0])/(G[0]*v),ar=(O[1]-C)/(G[1]*v),rt=r.resolution/v,cr=Vn(U);for(const Q of E[U]){if(!Q.loaded)continue;const oe=Q.tile.tileCoord,nt=je(oe),it=oe[1],st=oe[2];pe(this.tileTransform_),ke(this.tileTransform_,2/(e.size[0]*rt/N),-2/(e.size[1]*rt/N)),Gt(this.tileTransform_,r.rotation),ke(this.tileTransform_,1,1/k),Kr(this.tileTransform_,(G[0]*(it-be)-a)/N,(G[1]*(st-ar)-a)/X),this.helper.setUniformMatrixValue(m.TILE_TRANSFORM,me(this.tempMat4_,this.tileTransform_)),this.helper.bindBuffer(Q.coords),this.helper.bindBuffer(this.indices_),this.helper.enableAttributes(zn);let $=0;for(;$<Q.textures.length;){const ee="TEXTURE"+$,ce=`${m.TILE_TEXTURE_ARRAY}[${$}]`;t.activeTexture(t[ee]),t.bindTexture(t.TEXTURE_2D,Q.textures[$]),t.uniform1i(this.helper.getUniformLocation(ce),$),++$}for(let ee=0;ee<this.paletteTextures_.length;++ee){const ce=this.paletteTextures_[ee];t.activeTexture(t["TEXTURE"+$]);const lr=ce.getTexture(t);t.bindTexture(t.TEXTURE_2D,lr),t.uniform1i(this.helper.getUniformLocation(ce.name),$),++$}const ot=nt in d?d[nt]:1;ot<1&&(e.animate=!0),this.helper.setUniformFloatValue(m.TRANSITION_ALPHA,ot),this.helper.setUniformFloatValue(m.DEPTH,cr),this.helper.setUniformFloatValue(m.TEXTURE_PIXEL_WIDTH,N),this.helper.setUniformFloatValue(m.TEXTURE_PIXEL_HEIGHT,X),this.helper.setUniformFloatValue(m.TEXTURE_RESOLUTION,v),this.helper.setUniformFloatValue(m.TEXTURE_ORIGIN_X,O[0]+it*G[0]*v-a*v),this.helper.setUniformFloatValue(m.TEXTURE_ORIGIN_Y,O[1]-st*G[1]*v+a*v);let ae=c;a>0&&(ae=o.getTileCoordExtent(oe),J(ae,c,ae)),this.helper.setUniformFloatVec4(m.RENDER_EXTENT,ae),this.helper.setUniformFloatValue(m.RESOLUTION,r.resolution),this.helper.setUniformFloatValue(m.ZOOM,r.zoom),this.helper.drawElements(0,this.indices_.getSize())}}this.helper.finalizeDraw(e,this.dispatchPreComposeEvent,this.dispatchPostComposeEvent);const L=this.helper.getCanvas(),w=this.tileTextureCache_;for(;w.canExpireCache();)w.pop().dispose();const I=function(A,P){s.updateCacheSize(.1,P.viewState.projection),s.expireCache(P.viewState.projection,Hn)};return e.postRenderFunctions.push(I),this.postRender(t,e),L}getData(e){if(!this.helper.getGL())return null;const r=this.frameState_;if(!r)return null;const n=this.getLayer(),s=Zr(r.pixelToCoordinateTransform,e.slice()),o=r.viewState,a=n.getExtent();if(a&&!_t(Mt(a,o.projection),s))return null;const c=n.getSources(ie([s]),o.resolution);let l,u,h;for(l=c.length-1;l>=0;--l)if(u=c[l],u.getState()==="ready"){if(h=u.getTileGridForProjection(o.projection),u.getWrapX())break;const f=h.getExtent();if(!f||_t(f,s))break}if(l<0)return null;const d=this.tileTextureCache_;for(let f=h.getZForResolution(o.resolution);f>=h.getMinZoom();--f){const T=h.getTileCoordForCoordAndZ(s,f),p=Me(u,T);if(!d.containsKey(p))continue;const E=d.get(p),y=E.tile;if((y instanceof Xe||y instanceof Et)&&y.getState()===S.EMPTY)return null;if(!E.loaded)continue;const x=h.getOrigin(f),C=$e(h.getTileSize(f)),L=h.getResolution(f),w=(s[0]-x[0])/L-T[1]*C[0],I=(x[1]-s[1])/L-T[2]*C[1];return E.getPixelData(w,I)}return null}findAltTiles_(e,t,r,n){const s=e.getTileRangeForTileCoordAndZ(t,r,this.tempTileRange_);if(!s)return!1;let o=!0;const a=this.tileTextureCache_,c=this.getLayer().getRenderSource();for(let l=s.minX;l<=s.maxX;++l)for(let u=s.minY;u<=s.maxY;++u){const h=Me(c,[r,l,u]);let d=!1;if(a.containsKey(h)){const f=a.get(h);f.loaded&&!Ct(n,f.tile)&&(Lt(n,f,r),d=!0)}d||(o=!1)}return o}clearCache(){const e=this.tileTextureCache_;e.forEach(t=>t.dispose()),e.clear()}removeHelper(){this.helper&&this.clearCache(),super.removeHelper()}disposeInternal(){const e=this.helper;e&&(e.getGL().deleteProgram(this.program_),delete this.program_,e.deleteBuffer(this.indices_)),super.disposeInternal(),delete this.indices_,delete this.tileTextureCache_,delete this.frameState_}}const Kn=Yn;class Zn{constructor(e,t){this.name=e,this.data=t,this.texture_=null}getTexture(e){if(!this.texture_){const t=e.createTexture();e.bindTexture(e.TEXTURE_2D,t),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,this.data.length/4,1,0,e.RGBA,e.UNSIGNED_BYTE,this.data),this.texture_=t}return this.texture_}}const qn=Zn,_={NUMBER:1,STRING:2,COLOR:4,BOOLEAN:8,NUMBER_ARRAY:16,ANY:31,NONE:0},R={};function F(i){if(typeof i=="number")return _.NUMBER;if(typeof i=="boolean")return _.BOOLEAN;if(typeof i=="string")return Jr(i)?_.COLOR|_.STRING:_.STRING;if(!Array.isArray(i))throw new Error(`Unhandled value type: ${JSON.stringify(i)}`);const e=i;if(e.every(function(n){return typeof n=="number"}))return e.length===3||e.length===4?_.COLOR|_.NUMBER_ARRAY:_.NUMBER_ARRAY;if(typeof e[0]!="string")throw new Error(`Expected an expression operator but received: ${JSON.stringify(e)}`);const r=R[e[0]];if(r===void 0)throw new Error(`Unrecognized expression operator: ${JSON.stringify(e)}`);return r.getReturnType(e.slice(1))}function Jn(i){return Math.log2(i)%1===0}function Ae(i){const e=i.toString();return e.includes(".")?e:e+".0"}function Wt(i){if(i.length<2||i.length>4)throw new Error("`formatArray` can only output `vec2`, `vec3` or `vec4` arrays.");return`vec${i.length}(${i.map(Ae).join(", ")})`}function Qn(i){const e=Qr(i).slice();return e.length<4&&e.push(1),Wt(e.map(function(t,r){return r<3?t/255:t}))}function Yt(i,e){return i.stringLiteralsMap[e]===void 0&&(i.stringLiteralsMap[e]=Object.keys(i.stringLiteralsMap).length),i.stringLiteralsMap[e]}function ei(i,e){return Ae(Yt(i,e))}function g(i,e,t){if(Array.isArray(e)&&typeof e[0]=="string"){const n=R[e[0]];if(n===void 0)throw new Error(`Unrecognized expression operator: ${JSON.stringify(e)}`);return n.toGlsl(i,e.slice(1),t)}const r=F(e);if((r&_.NUMBER)>0)return Ae(e);if((r&_.BOOLEAN)>0)return e.toString();if((r&_.STRING)>0&&(t===void 0||t==_.STRING))return ei(i,e.toString());if((r&_.COLOR)>0&&(t===void 0||t==_.COLOR))return Qn(e);if((r&_.NUMBER_ARRAY)>0)return Wt(e);throw new Error(`Unexpected expression ${e} (expected type ${t})`)}function Kt(i){if(!(F(i)&_.NUMBER))throw new Error(`A numeric value was expected, got ${JSON.stringify(i)} instead`)}function D(i){for(let e=0;e<i.length;e++)Kt(i[e])}function Zt(i){if(!(F(i)&_.STRING))throw new Error(`A string value was expected, got ${JSON.stringify(i)} instead`)}function Qe(i){if(!(F(i)&_.BOOLEAN))throw new Error(`A boolean value was expected, got ${JSON.stringify(i)} instead`)}function b(i,e){if(i.length!==e)throw new Error(`Exactly ${e} arguments were expected, got ${i.length} instead`)}function B(i,e){if(i.length<e)throw new Error(`At least ${e} arguments were expected, got ${i.length} instead`)}function Pe(i,e){if(i.length>e)throw new Error(`At most ${e} arguments were expected, got ${i.length} instead`)}function qt(i){if(i.length%2!==0)throw new Error(`An even amount of arguments was expected, got ${i} instead`)}function ti(i){if(i.length%2===0)throw new Error(`An odd amount of arguments was expected, got ${i} instead`)}function et(i,e){if(!Jn(e))throw new Error(`Could not infer only one type from the following expression: ${JSON.stringify(i)}`)}R.get={getReturnType:function(i){return _.ANY},toGlsl:function(i,e){b(e,1),Zt(e[0]);const t=e[0].toString();return i.attributes.includes(t)||i.attributes.push(t),(i.inFragmentShader?"v_":"a_")+t}};function Jt(i){return"u_var_"+i}R.var={getReturnType:function(i){return _.ANY},toGlsl:function(i,e){b(e,1),Zt(e[0]);const t=e[0].toString();return i.variables.includes(t)||i.variables.push(t),Jt(t)}};const Qt="u_paletteTextures";R.palette={getReturnType:function(i){return _.COLOR},toGlsl:function(i,e){b(e,2),Kt(e[0]);const t=g(i,e[0]),r=e[1];if(!Array.isArray(r))throw new Error("The second argument of palette must be an array");const n=r.length,s=new Uint8Array(n*4);for(let c=0;c<n;c++){const l=r[c];let u;if(typeof l=="string")u=qr(l);else{if(!Array.isArray(l))throw new Error("The second argument of palette must be an array of strings or colors");const d=l.length;if(d===4)u=l;else{if(d!==3)throw new Error(`Expected palette color to have 3 or 4 values, got ${d}`);u=[l[0],l[1],l[2],1]}}const h=c*4;s[h]=u[0],s[h+1]=u[1],s[h+2]=u[2],s[h+3]=u[3]*255}i.paletteTextures||(i.paletteTextures=[]);const o=`${Qt}[${i.paletteTextures.length}]`,a=new qn(o,s);return i.paletteTextures.push(a),`texture2D(${o}, vec2((${t} + 0.5) / ${n}.0, 0.5))`}};const Fe="getBandValue";R.band={getReturnType:function(i){return _.NUMBER},toGlsl:function(i,e){B(e,1),Pe(e,3);const t=e[0];if(!(Fe in i.functions)){let o="";const a=i.bandCount||1;for(let c=0;c<a;c++){const l=Math.floor(c/4);let u=c%4;c===a-1&&u===1&&(u=3);const h=`${m.TILE_TEXTURE_ARRAY}[${l}]`;o+=`
          if (band == ${c+1}.0) {
            return texture2D(${h}, v_textureCoord + vec2(dx, dy))[${u}];
          }
        `}i.functions[Fe]=`
        float getBandValue(float band, float xOffset, float yOffset) {
          float dx = xOffset / ${m.TEXTURE_PIXEL_WIDTH};
          float dy = yOffset / ${m.TEXTURE_PIXEL_HEIGHT};
          ${o}
        }
      `}const r=g(i,t),n=g(i,e[1]||0),s=g(i,e[2]||0);return`${Fe}(${r}, ${n}, ${s})`}};R.time={getReturnType:function(i){return _.NUMBER},toGlsl:function(i,e){return b(e,0),"u_time"}};R.zoom={getReturnType:function(i){return _.NUMBER},toGlsl:function(i,e){return b(e,0),"u_zoom"}};R.resolution={getReturnType:function(i){return _.NUMBER},toGlsl:function(i,e){return b(e,0),"u_resolution"}};R["*"]={getReturnType:function(i){return _.NUMBER},toGlsl:function(i,e){return B(e,2),D(e),`(${e.map(t=>g(i,t)).join(" * ")})`}};R["/"]={getReturnType:function(i){return _.NUMBER},toGlsl:function(i,e){return b(e,2),D(e),`(${g(i,e[0])} / ${g(i,e[1])})`}};R["+"]={getReturnType:function(i){return _.NUMBER},toGlsl:function(i,e){return B(e,2),D(e),`(${e.map(t=>g(i,t)).join(" + ")})`}};R["-"]={getReturnType:function(i){return _.NUMBER},toGlsl:function(i,e){return b(e,2),D(e),`(${g(i,e[0])} - ${g(i,e[1])})`}};R.clamp={getReturnType:function(i){return _.NUMBER},toGlsl:function(i,e){b(e,3),D(e);const t=g(i,e[1]),r=g(i,e[2]);return`clamp(${g(i,e[0])}, ${t}, ${r})`}};R["%"]={getReturnType:function(i){return _.NUMBER},toGlsl:function(i,e){return b(e,2),D(e),`mod(${g(i,e[0])}, ${g(i,e[1])})`}};R["^"]={getReturnType:function(i){return _.NUMBER},toGlsl:function(i,e){return b(e,2),D(e),`pow(${g(i,e[0])}, ${g(i,e[1])})`}};R.abs={getReturnType:function(i){return _.NUMBER},toGlsl:function(i,e){return b(e,1),D(e),`abs(${g(i,e[0])})`}};R.floor={getReturnType:function(i){return _.NUMBER},toGlsl:function(i,e){return b(e,1),D(e),`floor(${g(i,e[0])})`}};R.round={getReturnType:function(i){return _.NUMBER},toGlsl:function(i,e){return b(e,1),D(e),`floor(${g(i,e[0])} + 0.5)`}};R.ceil={getReturnType:function(i){return _.NUMBER},toGlsl:function(i,e){return b(e,1),D(e),`ceil(${g(i,e[0])})`}};R.sin={getReturnType:function(i){return _.NUMBER},toGlsl:function(i,e){return b(e,1),D(e),`sin(${g(i,e[0])})`}};R.cos={getReturnType:function(i){return _.NUMBER},toGlsl:function(i,e){return b(e,1),D(e),`cos(${g(i,e[0])})`}};R.atan={getReturnType:function(i){return _.NUMBER},toGlsl:function(i,e){return B(e,1),Pe(e,2),D(e),e.length===2?`atan(${g(i,e[0])}, ${g(i,e[1])})`:`atan(${g(i,e[0])})`}};R[">"]={getReturnType:function(i){return _.BOOLEAN},toGlsl:function(i,e){return b(e,2),D(e),`(${g(i,e[0])} > ${g(i,e[1])})`}};R[">="]={getReturnType:function(i){return _.BOOLEAN},toGlsl:function(i,e){return b(e,2),D(e),`(${g(i,e[0])} >= ${g(i,e[1])})`}};R["<"]={getReturnType:function(i){return _.BOOLEAN},toGlsl:function(i,e){return b(e,2),D(e),`(${g(i,e[0])} < ${g(i,e[1])})`}};R["<="]={getReturnType:function(i){return _.BOOLEAN},toGlsl:function(i,e){return b(e,2),D(e),`(${g(i,e[0])} <= ${g(i,e[1])})`}};function er(i){return{getReturnType:function(e){return _.BOOLEAN},toGlsl:function(e,t){b(t,2);let r=_.ANY;for(let n=0;n<t.length;n++)r&=F(t[n]);if(r===_.NONE)throw new Error(`All arguments should be of compatible type, got ${JSON.stringify(t)} instead`);return r&=~_.COLOR,`(${g(e,t[0],r)} ${i} ${g(e,t[1],r)})`}}}R["=="]=er("==");R["!="]=er("!=");R["!"]={getReturnType:function(i){return _.BOOLEAN},toGlsl:function(i,e){return b(e,1),Qe(e[0]),`(!${g(i,e[0])})`}};function tr(i){return{getReturnType:function(e){return _.BOOLEAN},toGlsl:function(e,t){B(t,2);for(let n=0;n<t.length;n++)Qe(t[n]);let r="";return r=t.map(n=>g(e,n)).join(` ${i} `),r=`(${r})`,r}}}R.all=tr("&&");R.any=tr("||");R.between={getReturnType:function(i){return _.BOOLEAN},toGlsl:function(i,e){b(e,3),D(e);const t=g(i,e[1]),r=g(i,e[2]),n=g(i,e[0]);return`(${n} >= ${t} && ${n} <= ${r})`}};R.array={getReturnType:function(i){return _.NUMBER_ARRAY},toGlsl:function(i,e){B(e,2),Pe(e,4),D(e);const t=e.map(function(r){return g(i,r,_.NUMBER)});return`vec${e.length}(${t.join(", ")})`}};R.color={getReturnType:function(i){return _.COLOR},toGlsl:function(i,e){B(e,3),Pe(e,4),D(e);const t=e;e.length===3&&t.push(1);const r=e.map(function(n,s){return g(i,n,_.NUMBER)+(s<3?" / 255.0":"")});return`vec${e.length}(${r.join(", ")})`}};R.interpolate={getReturnType:function(i){let e=_.COLOR|_.NUMBER;for(let t=3;t<i.length;t+=2)e=e&F(i[t]);return e},toGlsl:function(i,e,t){qt(e),B(e,6);const r=e[0];let n;switch(r[0]){case"linear":n=1;break;case"exponential":n=r[1];break;default:n=null}if(!n)throw new Error(`Invalid interpolation type for "interpolate" operator, received: ${JSON.stringify(r)}`);t=t!==void 0?t:_.ANY;const s=R.interpolate.getReturnType(e)&t;et(e,s);const o=g(i,e[1]),a=Ae(n);let c="";for(let l=2;l<e.length-2;l+=2){const u=g(i,e[l]),h=c||g(i,e[l+1],s),d=g(i,e[l+2]),f=g(i,e[l+3],s);c=`mix(${h}, ${f}, pow(clamp((${o} - ${u}) / (${d} - ${u}), 0.0, 1.0), ${a}))`}return c}};R.match={getReturnType:function(i){let e=_.ANY;for(let t=2;t<i.length;t+=2)e=e&F(i[t]);return e=e&F(i[i.length-1]),e},toGlsl:function(i,e,t){qt(e),B(e,4),t=t!==void 0?t:_.ANY;const r=R.match.getReturnType(e)&t;et(e,r);const n=g(i,e[0]),s=g(i,e[e.length-1],r);let o=null;for(let a=e.length-3;a>=1;a-=2){const c=g(i,e[a]),l=g(i,e[a+1],r);o=`(${n} == ${c} ? ${l} : ${o||s})`}return o}};R.case={getReturnType:function(i){let e=_.ANY;for(let t=1;t<i.length;t+=2)e=e&F(i[t]);return e=e&F(i[i.length-1]),e},toGlsl:function(i,e,t){ti(e),B(e,3),t=t!==void 0?t:_.ANY;const r=R.case.getReturnType(e)&t;et(e,r);for(let o=0;o<e.length-1;o+=2)Qe(e[o]);const n=g(i,e[e.length-1],r);let s=null;for(let o=e.length-3;o>=0;o-=2){const a=g(i,e[o]),c=g(i,e[o+1],r);s=`(${a} ? ${c} : ${s||n})`}return s}};function St(i,e){const t=`
    attribute vec2 ${Re.TEXTURE_COORD};
    uniform mat4 ${m.TILE_TRANSFORM};
    uniform float ${m.TEXTURE_PIXEL_WIDTH};
    uniform float ${m.TEXTURE_PIXEL_HEIGHT};
    uniform float ${m.TEXTURE_RESOLUTION};
    uniform float ${m.TEXTURE_ORIGIN_X};
    uniform float ${m.TEXTURE_ORIGIN_Y};
    uniform float ${m.DEPTH};

    varying vec2 v_textureCoord;
    varying vec2 v_mapCoord;

    void main() {
      v_textureCoord = ${Re.TEXTURE_COORD};
      v_mapCoord = vec2(
        ${m.TEXTURE_ORIGIN_X} + ${m.TEXTURE_RESOLUTION} * ${m.TEXTURE_PIXEL_WIDTH} * v_textureCoord[0],
        ${m.TEXTURE_ORIGIN_Y} - ${m.TEXTURE_RESOLUTION} * ${m.TEXTURE_PIXEL_HEIGHT} * v_textureCoord[1]
      );
      gl_Position = ${m.TILE_TRANSFORM} * vec4(${Re.TEXTURE_COORD}, ${m.DEPTH}, 1.0);
    }
  `,r={inFragmentShader:!0,variables:[],attributes:[],stringLiteralsMap:{},functions:{},bandCount:e},n=[];if(i.color!==void 0){const h=g(r,i.color,_.COLOR);n.push(`color = ${h};`)}if(i.contrast!==void 0){const h=g(r,i.contrast,_.NUMBER);n.push(`color.rgb = clamp((${h} + 1.0) * color.rgb - (${h} / 2.0), vec3(0.0, 0.0, 0.0), vec3(1.0, 1.0, 1.0));`)}if(i.exposure!==void 0){const h=g(r,i.exposure,_.NUMBER);n.push(`color.rgb = clamp((${h} + 1.0) * color.rgb, vec3(0.0, 0.0, 0.0), vec3(1.0, 1.0, 1.0));`)}if(i.saturation!==void 0){const h=g(r,i.saturation,_.NUMBER);n.push(`
      float saturation = ${h} + 1.0;
      float sr = (1.0 - saturation) * 0.2126;
      float sg = (1.0 - saturation) * 0.7152;
      float sb = (1.0 - saturation) * 0.0722;
      mat3 saturationMatrix = mat3(
        sr + saturation, sr, sr,
        sg, sg + saturation, sg,
        sb, sb, sb + saturation
      );
      color.rgb = clamp(saturationMatrix * color.rgb, vec3(0.0, 0.0, 0.0), vec3(1.0, 1.0, 1.0));
    `)}if(i.gamma!==void 0){const h=g(r,i.gamma,_.NUMBER);n.push(`color.rgb = pow(color.rgb, vec3(1.0 / ${h}));`)}if(i.brightness!==void 0){const h=g(r,i.brightness,_.NUMBER);n.push(`color.rgb = clamp(color.rgb + ${h}, vec3(0.0, 0.0, 0.0), vec3(1.0, 1.0, 1.0));`)}const s={},o=r.variables.length;if(o>1&&!i.variables)throw new Error(`Missing variables in style (expected ${r.variables})`);for(let h=0;h<o;++h){const d=r.variables[h];if(!(d in i.variables))throw new Error(`Missing '${d}' in style variables`);const f=Jt(d);s[f]=function(){let T=i.variables[d];return typeof T=="string"&&(T=Yt(r,T)),T!==void 0?T:-9999999}}const a=Object.keys(s).map(function(h){return`uniform float ${h};`}),c=Math.ceil(e/4);a.push(`uniform sampler2D ${m.TILE_TEXTURE_ARRAY}[${c}];`),r.paletteTextures&&a.push(`uniform sampler2D ${Qt}[${r.paletteTextures.length}];`);const l=Object.keys(r.functions).map(function(h){return r.functions[h]}),u=`
    #ifdef GL_FRAGMENT_PRECISION_HIGH
    precision highp float;
    #else
    precision mediump float;
    #endif

    varying vec2 v_textureCoord;
    varying vec2 v_mapCoord;
    uniform vec4 ${m.RENDER_EXTENT};
    uniform float ${m.TRANSITION_ALPHA};
    uniform float ${m.TEXTURE_PIXEL_WIDTH};
    uniform float ${m.TEXTURE_PIXEL_HEIGHT};
    uniform float ${m.RESOLUTION};
    uniform float ${m.ZOOM};

    ${a.join(`
`)}

    ${l.join(`
`)}

    void main() {
      if (
        v_mapCoord[0] < ${m.RENDER_EXTENT}[0] ||
        v_mapCoord[1] < ${m.RENDER_EXTENT}[1] ||
        v_mapCoord[0] > ${m.RENDER_EXTENT}[2] ||
        v_mapCoord[1] > ${m.RENDER_EXTENT}[3]
      ) {
        discard;
      }

      vec4 color = texture2D(${m.TILE_TEXTURE_ARRAY}[0],  v_textureCoord);

      ${n.join(`
`)}

      if (color.a == 0.0) {
        discard;
      }

      gl_FragColor = color;
      gl_FragColor.rgb *= gl_FragColor.a;
      gl_FragColor *= ${m.TRANSITION_ALPHA};
    }`;return{vertexShader:t,fragmentShader:u,uniforms:s,paletteTextures:r.paletteTextures}}class rr extends un{constructor(e){e=e?Object.assign({},e):{};const t=e.style||{};delete e.style;const r=e.cacheSize;delete e.cacheSize,super(e),this.sources_=e.sources,this.renderedSource_=null,this.renderedResolution_=NaN,this.style_=t,this.cacheSize_=r,this.styleVariables_=this.style_.variables||{},this.addChangeListener(Nt.SOURCE,this.handleSourceUpdate_)}getSources(e,t){const r=this.getSource();return this.sources_?typeof this.sources_=="function"?this.sources_(e,t):this.sources_:r?[r]:[]}getRenderSource(){return this.renderedSource_||this.getSource()}getSourceState(){const e=this.getRenderSource();return e?e.getState():"undefined"}handleSourceUpdate_(){this.hasRenderer()&&this.getRenderer().clearCache(),this.getSource()&&this.setStyle(this.style_)}getSourceBandCount_(){const e=Number.MAX_SAFE_INTEGER,t=this.getSources([-e,-e,e,e],e);return t&&t.length&&"bandCount"in t[0]?t[0].bandCount:4}createRenderer(){const e=St(this.style_,this.getSourceBandCount_());return new Kn(this,{vertexShader:e.vertexShader,fragmentShader:e.fragmentShader,uniforms:e.uniforms,cacheSize:this.cacheSize_,paletteTextures:e.paletteTextures})}renderSources(e,t){const r=this.getRenderer();let n;for(let s=0,o=t.length;s<o;++s)this.renderedSource_=t[s],r.prepareFrame(e)&&(n=r.renderFrame(e));return n}render(e,t){this.rendered=!0;const r=e.viewState,n=this.getSources(e.extent,r.resolution);let s=!0;for(let a=0,c=n.length;a<c;++a){const l=n[a],u=l.getState();if(u=="loading"){const h=()=>{l.getState()=="ready"&&(l.removeEventListener("change",h),this.changed())};l.addEventListener("change",h)}s=s&&u=="ready"}const o=this.renderSources(e,n);if(this.getRenderer().renderComplete&&s)return this.renderedResolution_=r.resolution,o;if(this.renderedResolution_>.5*r.resolution){const a=this.getSources(e.extent,this.renderedResolution_).filter(c=>!n.includes(c));if(a.length>0)return this.renderSources(e,a)}return o}setStyle(e){this.styleVariables_=e.variables||{},this.style_=e;const t=St(this.style_,this.getSourceBandCount_());this.getRenderer().reset({vertexShader:t.vertexShader,fragmentShader:t.fragmentShader,uniforms:t.uniforms,paletteTextures:t.paletteTextures}),this.changed()}updateStyleVariables(e){Object.assign(this.styleVariables_,e),this.changed()}}rr.prototype.dispose;const ri=rr;class ni extends an{constructor(e){e=e||{};const t=e.projection!==void 0?e.projection:"EPSG:3857",r=e.tileGrid!==void 0?e.tileGrid:en({extent:tn(t),maxResolution:e.maxResolution,maxZoom:e.maxZoom,minZoom:e.minZoom,tileSize:e.tileSize});super({attributions:e.attributions,cacheSize:e.cacheSize,crossOrigin:e.crossOrigin,interpolate:e.interpolate,opaque:e.opaque,projection:t,reprojectionErrorThreshold:e.reprojectionErrorThreshold,tileGrid:r,tileLoadFunction:e.tileLoadFunction,tilePixelRatio:e.tilePixelRatio,tileUrlFunction:e.tileUrlFunction,url:e.url,urls:e.urls,wrapX:e.wrapX!==void 0?e.wrapX:!0,transition:e.transition,attributionsCollapsible:e.attributionsCollapsible,zDirection:e.zDirection}),this.gutter_=e.gutter!==void 0?e.gutter:0}getGutter(){return this.gutter_}}const ii=ni,si=new ri({source:new ii({url:"https://api.maptiler.com/tiles/satellite/{z}/{x}/{y}.jpg?key=get_your_own_D6rA4zTHduk6KOKTXzGB",maxZoom:20})}),tt=new We({source:new Ye({format:new cn,url:"../data/geojson/fire.json"}),style:{"fill-color":"rgba(255, 0, 0, 0.3)","stroke-color":"rgba(255, 0, 0, 0.9)","stroke-width":.5}}),nr=new We({source:new Ye,style:{"stroke-color":"rgba(100, 255, 0, 1)","stroke-width":2,"fill-color":"rgba(100, 255, 0, 0.3)"}}),Le=new rn({layers:[si,tt,nr],target:"map",view:new nn({center:[-13378949,5943751],zoom:11})});let He;const ir=new mn({source:tt.getSource()}),sr=document.getElementById("type");function or(){const i=sr.value;i!=="None"&&(He=new En({type:i,source:nr.getSource(),trace:!0,traceSource:tt.getSource(),style:{"stroke-color":"rgba(255, 255, 100, 0.5)","stroke-width":1.5,"fill-color":"rgba(255, 255, 100, 0.25)","circle-radius":6,"circle-fill-color":"rgba(255, 255, 100, 0.5)"}}),Le.addInteraction(He),Le.addInteraction(ir))}sr.onchange=function(){Le.removeInteraction(He),Le.removeInteraction(ir),or()};or();
