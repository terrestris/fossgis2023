import{bJ as ge,u as D,l as U,E as Y,o as S,bK as me,bl as ye,bL as _e,a4 as pe,g as Ee,U as w,b as P,aN as X,aM as xe,aL as Ge,a3 as z,az as L,X as j,h as Ce,r as Fe,bM as Re,ax as Ie,aw as ve,J as we,a0 as Oe,aB as T,H as Ae,aA as be,aC as Te,bN as Se,b4 as Ne,a as q,bO as Pe,ao as Le,m as C,as as je,ay as ae,ac as Me,ak as De,bI as Ue,bP as Xe,bQ as Ke,bR as Q,aI as We,bS as ke,am as He,bT as Ve}from"./Layer.8ccb32f3.js";import{e as Je,t as he,L as Ye,j as Be,f as $e,M as ze,b as qe,m as Z,H as b,d as Qe,h as Ze,c as ee,n as te,g as et,E as re,r as ne,o as tt,B as rt,R as nt,x as ie}from"./featureloader.afeb0822.js";class B extends ge{constructor(e){if(super(),this.on,this.once,this.un,this.id_=void 0,this.geometryName_="geometry",this.style_=null,this.styleFunction_=void 0,this.geometryChangeKey_=null,this.addChangeListener(this.geometryName_,this.handleGeometryChanged_),e)if(typeof e.getSimplifiedGeometry=="function"){const t=e;this.setGeometry(t)}else{const t=e;this.setProperties(t)}}clone(){const e=new B(this.hasProperties()?this.getProperties():null);e.setGeometryName(this.getGeometryName());const t=this.getGeometry();t&&e.setGeometry(t.clone());const r=this.getStyle();return r&&e.setStyle(r),e}getGeometry(){return this.get(this.geometryName_)}getId(){return this.id_}getGeometryName(){return this.geometryName_}getStyle(){return this.style_}getStyleFunction(){return this.styleFunction_}handleGeometryChange_(){this.changed()}handleGeometryChanged_(){this.geometryChangeKey_&&(D(this.geometryChangeKey_),this.geometryChangeKey_=null);const e=this.getGeometry();e&&(this.geometryChangeKey_=U(e,Y.CHANGE,this.handleGeometryChange_,this)),this.changed()}setGeometry(e){this.set(this.geometryName_,e)}setStyle(e){this.style_=e,this.styleFunction_=e?it(e):void 0,this.changed()}setId(e){this.id_=e,this.changed()}setGeometryName(e){this.removeChangeListener(this.geometryName_,this.handleGeometryChanged_),this.geometryName_=e,this.addChangeListener(this.geometryName_,this.handleGeometryChanged_),this.handleGeometryChanged_()}}function it(s){if(typeof s=="function")return s;let e;return Array.isArray(s)?e=s:(S(typeof s.getZIndex=="function",41),e=[s]),function(){return e}}const st=B;class K extends me{constructor(e){super(),this.geometries_=e||null,this.changeEventsKeys_=[],this.listenGeometriesChange_()}unlistenGeometriesChange_(){this.changeEventsKeys_.forEach(D),this.changeEventsKeys_.length=0}listenGeometriesChange_(){if(!!this.geometries_)for(let e=0,t=this.geometries_.length;e<t;++e)this.changeEventsKeys_.push(U(this.geometries_[e],Y.CHANGE,this.changed,this))}clone(){const e=new K(null);return e.setGeometries(this.geometries_),e.applyProperties(this),e}closestPointXY(e,t,r,n){if(n<ye(this.getExtent(),e,t))return n;const i=this.geometries_;for(let o=0,a=i.length;o<a;++o)n=i[o].closestPointXY(e,t,r,n);return n}containsXY(e,t){const r=this.geometries_;for(let n=0,i=r.length;n<i;++n)if(r[n].containsXY(e,t))return!0;return!1}computeExtent(e){_e(e);const t=this.geometries_;for(let r=0,n=t.length;r<n;++r)pe(e,t[r].getExtent());return e}getGeometries(){return se(this.geometries_)}getGeometriesArray(){return this.geometries_}getGeometriesArrayRecursive(){let e=[];const t=this.geometries_;for(let r=0,n=t.length;r<n;++r)t[r].getType()===this.getType()?e=e.concat(t[r].getGeometriesArrayRecursive()):e.push(t[r]);return e}getSimplifiedGeometry(e){if(this.simplifiedGeometryRevision!==this.getRevision()&&(this.simplifiedGeometryMaxMinSquaredTolerance=0,this.simplifiedGeometryRevision=this.getRevision()),e<0||this.simplifiedGeometryMaxMinSquaredTolerance!==0&&e<this.simplifiedGeometryMaxMinSquaredTolerance)return this;const t=[],r=this.geometries_;let n=!1;for(let i=0,o=r.length;i<o;++i){const a=r[i],h=a.getSimplifiedGeometry(e);t.push(h),h!==a&&(n=!0)}if(n){const i=new K(null);return i.setGeometriesArray(t),i}return this.simplifiedGeometryMaxMinSquaredTolerance=e,this}getType(){return"GeometryCollection"}intersectsExtent(e){const t=this.geometries_;for(let r=0,n=t.length;r<n;++r)if(t[r].intersectsExtent(e))return!0;return!1}isEmpty(){return this.geometries_.length===0}rotate(e,t){const r=this.geometries_;for(let n=0,i=r.length;n<i;++n)r[n].rotate(e,t);this.changed()}scale(e,t,r){r||(r=Ee(this.getExtent()));const n=this.geometries_;for(let i=0,o=n.length;i<o;++i)n[i].scale(e,t,r);this.changed()}setGeometries(e){this.setGeometriesArray(se(e))}setGeometriesArray(e){this.unlistenGeometriesChange_(),this.geometries_=e,this.listenGeometriesChange_(),this.changed()}applyTransform(e){const t=this.geometries_;for(let r=0,n=t.length;r<n;++r)t[r].applyTransform(e);this.changed()}translate(e,t){const r=this.geometries_;for(let n=0,i=r.length;n<i;++n)r[n].translate(e,t);this.changed()}disposeInternal(){this.unlistenGeometriesChange_(),super.disposeInternal()}}function se(s){const e=[];for(let t=0,r=s.length;t<r;++t)e.push(s[t].clone());return e}const ot=K;class at extends Je{constructor(){super()}getType(){return"json"}readFeature(e,t){return this.readFeatureFromObject(M(e),this.getReadOptions(e,t))}readFeatures(e,t){return this.readFeaturesFromObject(M(e),this.getReadOptions(e,t))}readFeatureFromObject(e,t){return w()}readFeaturesFromObject(e,t){return w()}readGeometry(e,t){return this.readGeometryFromObject(M(e),this.getReadOptions(e,t))}readGeometryFromObject(e,t){return w()}readProjection(e){return this.readProjectionFromObject(M(e))}readProjectionFromObject(e){return w()}writeFeature(e,t){return JSON.stringify(this.writeFeatureObject(e,t))}writeFeatureObject(e,t){return w()}writeFeatures(e,t){return JSON.stringify(this.writeFeaturesObject(e,t))}writeFeaturesObject(e,t){return w()}writeGeometry(e,t){return JSON.stringify(this.writeGeometryObject(e,t))}writeGeometryObject(e,t){return w()}}function M(s){if(typeof s=="string"){const e=JSON.parse(s);return e||null}else if(s!==null)return s;return null}const ht=at;class ut extends ht{constructor(e){e=e||{},super(),this.dataProjection=P(e.dataProjection?e.dataProjection:"EPSG:4326"),e.featureProjection&&(this.defaultFeatureProjection=P(e.featureProjection)),this.geometryName_=e.geometryName,this.extractGeometryName_=e.extractGeometryName,this.supportedMediaTypes=["application/geo+json","application/vnd.geo+json"]}readFeatureFromObject(e,t){let r=null;e.type==="Feature"?r=e:r={type:"Feature",geometry:e,properties:null};const n=V(r.geometry,t),i=new st;return this.geometryName_?i.setGeometryName(this.geometryName_):this.extractGeometryName_&&"geometry_name"in r!==void 0&&i.setGeometryName(r.geometry_name),i.setGeometry(n),"id"in r&&i.setId(r.id),r.properties&&i.setProperties(r.properties,!0),i}readFeaturesFromObject(e,t){const r=e;let n=null;if(r.type==="FeatureCollection"){const i=e;n=[];const o=i.features;for(let a=0,h=o.length;a<h;++a)n.push(this.readFeatureFromObject(o[a],t))}else n=[this.readFeatureFromObject(e,t)];return n}readGeometryFromObject(e,t){return V(e,t)}readProjectionFromObject(e){const t=e.crs;let r;return t?t.type=="name"?r=P(t.properties.name):t.type==="EPSG"?r=P("EPSG:"+t.properties.code):S(!1,36):r=this.dataProjection,r}writeFeatureObject(e,t){t=this.adaptOptions(t);const r={type:"Feature",geometry:null,properties:null},n=e.getId();if(n!==void 0&&(r.id=n),!e.hasProperties())return r;const i=e.getProperties(),o=e.getGeometry();return o&&(r.geometry=J(o,t),delete i[e.getGeometryName()]),X(i)||(r.properties=i),r}writeFeaturesObject(e,t){t=this.adaptOptions(t);const r=[];for(let n=0,i=e.length;n<i;++n)r.push(this.writeFeatureObject(e[n],t));return{type:"FeatureCollection",features:r}}writeGeometryObject(e,t){return J(e,this.adaptOptions(t))}}function V(s,e){if(!s)return null;let t;switch(s.type){case"Point":{t=ct(s);break}case"LineString":{t=dt(s);break}case"Polygon":{t=yt(s);break}case"MultiPoint":{t=gt(s);break}case"MultiLineString":{t=ft(s);break}case"MultiPolygon":{t=mt(s);break}case"GeometryCollection":{t=lt(s);break}default:throw new Error("Unsupported GeoJSON type: "+s.type)}return he(t,!1,e)}function lt(s,e){const t=s.geometries.map(function(r){return V(r,e)});return new ot(t)}function ct(s){return new xe(s.coordinates)}function dt(s){return new Ye(s.coordinates)}function ft(s){return new Be(s.coordinates)}function gt(s){return new $e(s.coordinates)}function mt(s){return new ze(s.coordinates)}function yt(s){return new Ge(s.coordinates)}function J(s,e){s=he(s,!0,e);const t=s.getType();let r;switch(t){case"Point":{r=Ct(s);break}case"LineString":{r=pt(s);break}case"Polygon":{r=Ft(s,e);break}case"MultiPoint":{r=xt(s);break}case"MultiLineString":{r=Et(s);break}case"MultiPolygon":{r=Gt(s,e);break}case"GeometryCollection":{r=_t(s,e);break}case"Circle":{r={type:"GeometryCollection",geometries:[]};break}default:throw new Error("Unsupported geometry type: "+t)}return r}function _t(s,e){return e=Object.assign({},e),delete e.featureProjection,{type:"GeometryCollection",geometries:s.getGeometriesArray().map(function(r){return J(r,e)})}}function pt(s,e){return{type:"LineString",coordinates:s.getCoordinates()}}function Et(s,e){return{type:"MultiLineString",coordinates:s.getCoordinates()}}function xt(s,e){return{type:"MultiPoint",coordinates:s.getCoordinates()}}function Gt(s,e){let t;return e&&(t=e.rightHanded),{type:"MultiPolygon",coordinates:s.getCoordinates(t)}}function Ct(s,e){return{type:"Point",coordinates:s.getCoordinates()}}function Ft(s,e){let t;return e&&(t=e.rightHanded),{type:"Polygon",coordinates:s.getCoordinates(t)}}const St=ut;class Rt extends qe{constructor(e){super(e),this.boundHandleStyleImageChange_=this.handleStyleImageChange_.bind(this),this.animatingOrInteracting_,this.hitDetectionImageData_=null,this.renderedFeatures_=null,this.renderedRevision_=-1,this.renderedResolution_=NaN,this.renderedExtent_=z(),this.wrappedRenderedExtent_=z(),this.renderedRotation_,this.renderedCenter_=null,this.renderedProjection_=null,this.renderedRenderOrder_=null,this.replayGroup_=null,this.replayGroupChanged=!0,this.declutterExecutorGroup=null,this.clipping=!0,this.compositionContext_=null,this.opacity_=1}renderWorlds(e,t,r){const n=t.extent,i=t.viewState,o=i.center,a=i.resolution,h=i.projection,c=i.rotation,u=h.getExtent(),l=this.getLayer().getSource(),d=t.pixelRatio,p=t.viewHints,y=!(p[L.ANIMATING]||p[L.INTERACTING]),g=this.compositionContext_,_=Math.round(t.size[0]*d),f=Math.round(t.size[1]*d),x=l.getWrapX()&&h.canWrapX(),F=x?j(u):null,I=x?Math.ceil((n[2]-u[2])/F)+1:1;let A=x?Math.floor((n[0]-u[0])/F):0;do{const O=this.getRenderTransform(o,a,c,d,_,f,A*F);e.execute(g,1,O,c,y,void 0,r)}while(++A<I)}setupCompositionContext_(){if(this.opacity_!==1){const e=Ce(this.context.canvas.width,this.context.canvas.height,Z);this.compositionContext_=e}else this.compositionContext_=this.context}releaseCompositionContext_(){if(this.opacity_!==1){const e=this.context.globalAlpha;this.context.globalAlpha=this.opacity_,this.context.drawImage(this.compositionContext_.canvas,0,0),this.context.globalAlpha=e,Fe(this.compositionContext_),Z.push(this.compositionContext_.canvas),this.compositionContext_=null}}renderDeclutter(e){this.declutterExecutorGroup&&(this.setupCompositionContext_(),this.renderWorlds(this.declutterExecutorGroup,e,e.declutterTree),this.releaseCompositionContext_())}renderFrame(e,t){const r=e.pixelRatio,n=e.layerStatesArray[e.layerIndex];Re(this.pixelTransform,1/r,1/r),Ie(this.inversePixelTransform,this.pixelTransform);const i=ve(this.pixelTransform);this.useContainer(t,i,this.getBackground(e));const o=this.context,a=o.canvas,h=this.replayGroup_,c=this.declutterExecutorGroup;if((!h||h.isEmpty())&&(!c||c.isEmpty()))return null;const u=Math.round(e.size[0]*r),l=Math.round(e.size[1]*r);a.width!=u||a.height!=l?(a.width=u,a.height=l,a.style.transform!==i&&(a.style.transform=i)):this.containerReused||o.clearRect(0,0,u,l),this.preRender(o,e);const d=e.viewState,p=d.projection;this.opacity_=n.opacity,this.setupCompositionContext_();let y=!1,g=!0;if(n.extent&&this.clipping){const _=we(n.extent,p);g=Oe(_,e.extent),y=g&&!T(_,e.extent),y&&this.clipUnrotated(this.compositionContext_,e,_)}return g&&this.renderWorlds(h,e),y&&this.compositionContext_.restore(),this.releaseCompositionContext_(),this.postRender(o,e),this.renderedRotation_!==d.rotation&&(this.renderedRotation_=d.rotation,this.hitDetectionImageData_=null),this.container}getFeatures(e){return new Promise(t=>{if(!this.hitDetectionImageData_&&!this.animatingOrInteracting_){const r=[this.context.canvas.width,this.context.canvas.height];Ae(this.pixelTransform,r);const n=this.renderedCenter_,i=this.renderedResolution_,o=this.renderedRotation_,a=this.renderedProjection_,h=this.wrappedRenderedExtent_,c=this.getLayer(),u=[],l=r[0]*b,d=r[1]*b;u.push(this.getRenderTransform(n,i,o,b,l,d,0).slice());const p=c.getSource(),y=a.getExtent();if(p.getWrapX()&&a.canWrapX()&&!T(y,h)){let g=h[0];const _=j(y);let f=0,x;for(;g<y[0];)--f,x=_*f,u.push(this.getRenderTransform(n,i,o,b,l,d,x).slice()),g+=_;for(f=0,g=h[2];g>y[2];)++f,x=_*f,u.push(this.getRenderTransform(n,i,o,b,l,d,x).slice()),g-=_}this.hitDetectionImageData_=Qe(r,u,this.renderedFeatures_,c.getStyleFunction(),h,i,o)}t(Ze(e,this.renderedFeatures_,this.hitDetectionImageData_))})}forEachFeatureAtCoordinate(e,t,r,n,i){if(!this.replayGroup_)return;const o=t.viewState.resolution,a=t.viewState.rotation,h=this.getLayer(),c={},u=function(p,y,g){const _=C(p),f=c[_];if(f){if(f!==!0&&g<f.distanceSq){if(g===0)return c[_]=!0,i.splice(i.lastIndexOf(f),1),n(p,h,y);f.geometry=y,f.distanceSq=g}}else{if(g===0)return c[_]=!0,n(p,h,y);i.push(c[_]={feature:p,layer:h,geometry:y,distanceSq:g,callback:n})}};let l;const d=[this.replayGroup_];return this.declutterExecutorGroup&&d.push(this.declutterExecutorGroup),d.some(p=>l=p.forEachFeatureAtCoordinate(e,o,a,r,u,p===this.declutterExecutorGroup&&t.declutterTree?t.declutterTree.all().map(y=>y.value):null)),l}handleFontsChanged(){const e=this.getLayer();e.getVisible()&&this.replayGroup_&&e.changed()}handleStyleImageChange_(e){this.renderIfReadyAndVisible()}prepareFrame(e){const t=this.getLayer(),r=t.getSource();if(!r)return!1;const n=e.viewHints[L.ANIMATING],i=e.viewHints[L.INTERACTING],o=t.getUpdateWhileAnimating(),a=t.getUpdateWhileInteracting();if(this.ready&&!o&&n||!a&&i)return this.animatingOrInteracting_=!0,!0;this.animatingOrInteracting_=!1;const h=e.extent,c=e.viewState,u=c.projection,l=c.resolution,d=e.pixelRatio,p=t.getRevision(),y=t.getRenderBuffer();let g=t.getRenderOrder();g===void 0&&(g=tt);const _=c.center.slice(),f=be(h,y*l),x=f.slice(),F=[f.slice()],I=u.getExtent();if(r.getWrapX()&&u.canWrapX()&&!T(I,e.extent)){const m=j(I),G=Math.max(j(f)/2,m);f[0]=I[0]-G,f[2]=I[2]+G,Te(_,u);const E=Se(F[0],u);E[0]<I[0]&&E[2]<I[2]?F.push([E[0]+m,E[1],E[2]+m,E[3]]):E[0]>I[0]&&E[2]>I[2]&&F.push([E[0]-m,E[1],E[2]-m,E[3]])}if(this.ready&&this.renderedResolution_==l&&this.renderedRevision_==p&&this.renderedRenderOrder_==g&&T(this.wrappedRenderedExtent_,f))return Ne(this.renderedExtent_,x)||(this.hitDetectionImageData_=null,this.renderedExtent_=x),this.renderedCenter_=_,this.replayGroupChanged=!1,!0;this.replayGroup_=null;const A=new ee(te(l,d),f,l,d);let O;this.getLayer().getDeclutter()&&(O=new ee(te(l,d),f,l,d));const W=je();let $;if(W){for(let m=0,G=F.length;m<G;++m){const E=F[m],H=q(E,u);r.loadFeatures(H,Pe(l,u),W)}$=Le(W,u)}else for(let m=0,G=F.length;m<G;++m)r.loadFeatures(F[m],l,u);const ue=et(l,d);let k=!0;const le=m=>{let G;const E=m.getStyleFunction()||t.getStyleFunction();if(E&&(G=E(m,l)),G){const H=this.renderFeature(m,ue,G,A,$,O);k=k&&!H}},ce=q(f,u),N=r.getFeaturesInExtent(ce);g&&N.sort(g);for(let m=0,G=N.length;m<G;++m)le(N[m]);this.renderedFeatures_=N,this.ready=k;const de=A.finish(),fe=new re(f,l,d,r.getOverlaps(),de,t.getRenderBuffer());return O&&(this.declutterExecutorGroup=new re(f,l,d,r.getOverlaps(),O.finish(),t.getRenderBuffer())),this.renderedResolution_=l,this.renderedRevision_=p,this.renderedRenderOrder_=g,this.renderedExtent_=x,this.wrappedRenderedExtent_=f,this.renderedCenter_=_,this.renderedProjection_=u,this.replayGroup_=fe,this.hitDetectionImageData_=null,this.replayGroupChanged=!0,!0}renderFeature(e,t,r,n,i,o){if(!r)return!1;let a=!1;if(Array.isArray(r))for(let h=0,c=r.length;h<c;++h)a=ne(n,e,r[h],t,this.boundHandleStyleImageChange_,i,o)||a;else a=ne(n,e,r,t,this.boundHandleStyleImageChange_,i,o);return a}}const It=Rt;class vt extends rt{constructor(e){super(e)}createRenderer(){return new It(this)}}const Nt=vt;class wt{constructor(e){this.rbush_=new nt(e),this.items_={}}insert(e,t){const r={minX:e[0],minY:e[1],maxX:e[2],maxY:e[3],value:t};this.rbush_.insert(r),this.items_[C(t)]=r}load(e,t){const r=new Array(t.length);for(let n=0,i=t.length;n<i;n++){const o=e[n],a=t[n],h={minX:o[0],minY:o[1],maxX:o[2],maxY:o[3],value:a};r[n]=h,this.items_[C(a)]=h}this.rbush_.load(r)}remove(e){const t=C(e),r=this.items_[t];return delete this.items_[t],this.rbush_.remove(r)!==null}update(e,t){const r=this.items_[C(t)],n=[r.minX,r.minY,r.maxX,r.maxY];ae(n,e)||(this.remove(t),this.insert(e,t))}getAll(){return this.rbush_.all().map(function(t){return t.value})}getInExtent(e){const t={minX:e[0],minY:e[1],maxX:e[2],maxY:e[3]};return this.rbush_.search(t).map(function(n){return n.value})}forEach(e){return this.forEach_(this.getAll(),e)}forEachInExtent(e,t){return this.forEach_(this.getInExtent(e),t)}forEach_(e,t){let r;for(let n=0,i=e.length;n<i;n++)if(r=t(e[n]),r)return r;return r}isEmpty(){return X(this.items_)}clear(){this.rbush_.clear(),this.items_={}}getExtent(e){const t=this.rbush_.toJSON();return Me(t.minX,t.minY,t.maxX,t.maxY,e)}concat(e){this.rbush_.load(e.rbush_.all());for(const t in e.items_)this.items_[t]=e.items_[t]}}const oe=wt,R={ADDFEATURE:"addfeature",CHANGEFEATURE:"changefeature",CLEAR:"clear",REMOVEFEATURE:"removefeature",FEATURESLOADSTART:"featuresloadstart",FEATURESLOADEND:"featuresloadend",FEATURESLOADERROR:"featuresloaderror"};function Ot(s,e){return[[-1/0,-1/0,1/0,1/0]]}function Pt(s,e){return[s]}class v extends He{constructor(e,t,r){super(e),this.feature=t,this.features=r}}class At extends De{constructor(e){e=e||{},super({attributions:e.attributions,interpolate:!0,projection:void 0,state:"ready",wrapX:e.wrapX!==void 0?e.wrapX:!0}),this.on,this.once,this.un,this.loader_=Ue,this.format_=e.format,this.overlaps_=e.overlaps===void 0?!0:e.overlaps,this.url_=e.url,e.loader!==void 0?this.loader_=e.loader:this.url_!==void 0&&(S(this.format_,7),this.loader_=ie(this.url_,this.format_)),this.strategy_=e.strategy!==void 0?e.strategy:Ot;const t=e.useSpatialIndex!==void 0?e.useSpatialIndex:!0;this.featuresRtree_=t?new oe:null,this.loadedExtentsRtree_=new oe,this.loadingExtentsCount_=0,this.nullGeometryFeatures_={},this.idIndex_={},this.uidIndex_={},this.featureChangeKeys_={},this.featuresCollection_=null;let r,n;Array.isArray(e.features)?n=e.features:e.features&&(r=e.features,n=r.getArray()),!t&&r===void 0&&(r=new Xe(n)),n!==void 0&&this.addFeaturesInternal(n),r!==void 0&&this.bindFeaturesCollection_(r)}addFeature(e){this.addFeatureInternal(e),this.changed()}addFeatureInternal(e){const t=C(e);if(!this.addToIndex_(t,e)){this.featuresCollection_&&this.featuresCollection_.remove(e);return}this.setupChangeEvents_(t,e);const r=e.getGeometry();if(r){const n=r.getExtent();this.featuresRtree_&&this.featuresRtree_.insert(n,e)}else this.nullGeometryFeatures_[t]=e;this.dispatchEvent(new v(R.ADDFEATURE,e))}setupChangeEvents_(e,t){this.featureChangeKeys_[e]=[U(t,Y.CHANGE,this.handleFeatureChange_,this),U(t,Ke.PROPERTYCHANGE,this.handleFeatureChange_,this)]}addToIndex_(e,t){let r=!0;const n=t.getId();return n!==void 0&&(n.toString()in this.idIndex_?r=!1:this.idIndex_[n.toString()]=t),r&&(S(!(e in this.uidIndex_),30),this.uidIndex_[e]=t),r}addFeatures(e){this.addFeaturesInternal(e),this.changed()}addFeaturesInternal(e){const t=[],r=[],n=[];for(let i=0,o=e.length;i<o;i++){const a=e[i],h=C(a);this.addToIndex_(h,a)&&r.push(a)}for(let i=0,o=r.length;i<o;i++){const a=r[i],h=C(a);this.setupChangeEvents_(h,a);const c=a.getGeometry();if(c){const u=c.getExtent();t.push(u),n.push(a)}else this.nullGeometryFeatures_[h]=a}if(this.featuresRtree_&&this.featuresRtree_.load(t,n),this.hasListener(R.ADDFEATURE))for(let i=0,o=r.length;i<o;i++)this.dispatchEvent(new v(R.ADDFEATURE,r[i]))}bindFeaturesCollection_(e){let t=!1;this.addEventListener(R.ADDFEATURE,function(r){t||(t=!0,e.push(r.feature),t=!1)}),this.addEventListener(R.REMOVEFEATURE,function(r){t||(t=!0,e.remove(r.feature),t=!1)}),e.addEventListener(Q.ADD,r=>{t||(t=!0,this.addFeature(r.element),t=!1)}),e.addEventListener(Q.REMOVE,r=>{t||(t=!0,this.removeFeature(r.element),t=!1)}),this.featuresCollection_=e}clear(e){if(e){for(const r in this.featureChangeKeys_)this.featureChangeKeys_[r].forEach(D);this.featuresCollection_||(this.featureChangeKeys_={},this.idIndex_={},this.uidIndex_={})}else if(this.featuresRtree_){const r=n=>{this.removeFeatureInternal(n)};this.featuresRtree_.forEach(r);for(const n in this.nullGeometryFeatures_)this.removeFeatureInternal(this.nullGeometryFeatures_[n])}this.featuresCollection_&&this.featuresCollection_.clear(),this.featuresRtree_&&this.featuresRtree_.clear(),this.nullGeometryFeatures_={};const t=new v(R.CLEAR);this.dispatchEvent(t),this.changed()}forEachFeature(e){if(this.featuresRtree_)return this.featuresRtree_.forEach(e);this.featuresCollection_&&this.featuresCollection_.forEach(e)}forEachFeatureAtCoordinateDirect(e,t){const r=[e[0],e[1],e[0],e[1]];return this.forEachFeatureInExtent(r,function(n){if(n.getGeometry().intersectsCoordinate(e))return t(n)})}forEachFeatureInExtent(e,t){if(this.featuresRtree_)return this.featuresRtree_.forEachInExtent(e,t);this.featuresCollection_&&this.featuresCollection_.forEach(t)}forEachFeatureIntersectingExtent(e,t){return this.forEachFeatureInExtent(e,function(r){if(r.getGeometry().intersectsExtent(e)){const i=t(r);if(i)return i}})}getFeaturesCollection(){return this.featuresCollection_}getFeatures(){let e;return this.featuresCollection_?e=this.featuresCollection_.getArray().slice(0):this.featuresRtree_&&(e=this.featuresRtree_.getAll(),X(this.nullGeometryFeatures_)||We(e,Object.values(this.nullGeometryFeatures_))),e}getFeaturesAtCoordinate(e){const t=[];return this.forEachFeatureAtCoordinateDirect(e,function(r){t.push(r)}),t}getFeaturesInExtent(e,t){if(this.featuresRtree_){if(!(t&&t.canWrapX()&&this.getWrapX()))return this.featuresRtree_.getInExtent(e);const n=ke(e,t);return[].concat(...n.map(i=>this.featuresRtree_.getInExtent(i)))}else if(this.featuresCollection_)return this.featuresCollection_.getArray().slice(0);return[]}getClosestFeatureToCoordinate(e,t){const r=e[0],n=e[1];let i=null;const o=[NaN,NaN];let a=1/0;const h=[-1/0,-1/0,1/0,1/0];return t=t||Ve,this.featuresRtree_.forEachInExtent(h,function(c){if(t(c)){const u=c.getGeometry(),l=a;if(a=u.closestPointXY(r,n,o,a),a<l){i=c;const d=Math.sqrt(a);h[0]=r-d,h[1]=n-d,h[2]=r+d,h[3]=n+d}}}),i}getExtent(e){return this.featuresRtree_.getExtent(e)}getFeatureById(e){const t=this.idIndex_[e.toString()];return t!==void 0?t:null}getFeatureByUid(e){const t=this.uidIndex_[e];return t!==void 0?t:null}getFormat(){return this.format_}getOverlaps(){return this.overlaps_}getUrl(){return this.url_}handleFeatureChange_(e){const t=e.target,r=C(t),n=t.getGeometry();if(!n)r in this.nullGeometryFeatures_||(this.featuresRtree_&&this.featuresRtree_.remove(t),this.nullGeometryFeatures_[r]=t);else{const o=n.getExtent();r in this.nullGeometryFeatures_?(delete this.nullGeometryFeatures_[r],this.featuresRtree_&&this.featuresRtree_.insert(o,t)):this.featuresRtree_&&this.featuresRtree_.update(o,t)}const i=t.getId();if(i!==void 0){const o=i.toString();this.idIndex_[o]!==t&&(this.removeFromIdIndex_(t),this.idIndex_[o]=t)}else this.removeFromIdIndex_(t),this.uidIndex_[r]=t;this.changed(),this.dispatchEvent(new v(R.CHANGEFEATURE,t))}hasFeature(e){const t=e.getId();return t!==void 0?t in this.idIndex_:C(e)in this.uidIndex_}isEmpty(){return this.featuresRtree_?this.featuresRtree_.isEmpty()&&X(this.nullGeometryFeatures_):this.featuresCollection_?this.featuresCollection_.getLength()===0:!0}loadFeatures(e,t,r){const n=this.loadedExtentsRtree_,i=this.strategy_(e,t,r);for(let o=0,a=i.length;o<a;++o){const h=i[o];n.forEachInExtent(h,function(u){return T(u.extent,h)})||(++this.loadingExtentsCount_,this.dispatchEvent(new v(R.FEATURESLOADSTART)),this.loader_.call(this,h,t,r,u=>{--this.loadingExtentsCount_,this.dispatchEvent(new v(R.FEATURESLOADEND,void 0,u))},()=>{--this.loadingExtentsCount_,this.dispatchEvent(new v(R.FEATURESLOADERROR))}),n.insert(h,{extent:h.slice()}))}this.loading=this.loader_.length<4?!1:this.loadingExtentsCount_>0}refresh(){this.clear(!0),this.loadedExtentsRtree_.clear(),super.refresh()}removeLoadedExtent(e){const t=this.loadedExtentsRtree_;let r;t.forEachInExtent(e,function(n){if(ae(n.extent,e))return r=n,!0}),r&&t.remove(r)}removeFeature(e){if(!e)return;const t=C(e);t in this.nullGeometryFeatures_?delete this.nullGeometryFeatures_[t]:this.featuresRtree_&&this.featuresRtree_.remove(e),this.removeFeatureInternal(e)&&this.changed()}removeFeatureInternal(e){const t=C(e),r=this.featureChangeKeys_[t];if(!r)return;r.forEach(D),delete this.featureChangeKeys_[t];const n=e.getId();return n!==void 0&&delete this.idIndex_[n.toString()],delete this.uidIndex_[t],this.dispatchEvent(new v(R.REMOVEFEATURE,e)),e}removeFromIdIndex_(e){let t=!1;for(const r in this.idIndex_)if(this.idIndex_[r]===e){delete this.idIndex_[r],t=!0;break}return t}setLoader(e){this.loader_=e}setUrl(e){S(this.format_,7),this.url_=e,this.setLoader(ie(e,this.format_))}}const Lt=At;export{st as F,St as G,oe as R,Nt as V,Lt as a,Pt as b,ot as c,R as d};
