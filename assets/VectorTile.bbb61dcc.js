import{l as Fe,i as W,F as we,M as Ce,L as _e,a as Ee,b as Re,t as me}from"./Feature.b6b724ef.js";import{aG as Se,aH as ve,r as Pe,aI as Ge,aJ as De,aK as Me,A as le,k as J,m as Ie,aw as Ve,x as de,aL as Le,C as ue,aM as Oe,aN as Be,aO as ke,aP as C,V,y as G,g as he,al as N,w as Ae,p as B,aQ as Ne,e as je,q as Ue,aR as ze,R as He,U as ce,aS as Ke,aT as X,aU as Q,aV as Xe,z as Ze,aW as Ye,E as q,aX as $e,aC as We}from"./Source.c163b9e6.js";import{c as b,g as Je,d as ee,H as Z,e as Qe,h as qe,r as te,B as be,l as et}from"./featureloader.66bc25dd.js";import{C as tt,U as it}from"./UrlTile.81a9c245.js";import{f as U,g as fe,e as rt,b as st,h as nt,i as ot,j as at,d as lt,k as dt}from"./TileEventType.49efe80f.js";const ie=de();class j{constructor(e,i,r,s,n){this.styleFunction,this.extent_,this.id_=n,this.type_=e,this.flatCoordinates_=i,this.flatInteriorPoints_=null,this.flatMidpoints_=null,this.ends_=r,this.properties_=s}get(e){return this.properties_[e]}getExtent(){return this.extent_||(this.extent_=this.type_==="Point"?Se(this.flatCoordinates_):ve(this.flatCoordinates_,0,this.flatCoordinates_.length,2)),this.extent_}getFlatInteriorPoint(){if(!this.flatInteriorPoints_){const e=Pe(this.getExtent());this.flatInteriorPoints_=Ge(this.flatCoordinates_,0,this.ends_,2,e,0)}return this.flatInteriorPoints_}getFlatInteriorPoints(){if(!this.flatInteriorPoints_){const e=Fe(this.flatCoordinates_,0,this.ends_,2);this.flatInteriorPoints_=De(this.flatCoordinates_,0,this.ends_,2,e)}return this.flatInteriorPoints_}getFlatMidpoint(){return this.flatMidpoints_||(this.flatMidpoints_=W(this.flatCoordinates_,0,this.flatCoordinates_.length,2,.5)),this.flatMidpoints_}getFlatMidpoints(){if(!this.flatMidpoints_){this.flatMidpoints_=[];const e=this.flatCoordinates_;let i=0;const r=this.ends_;for(let s=0,n=r.length;s<n;++s){const o=r[s],d=W(e,i,o,2,.5);Me(this.flatMidpoints_,d),i=o}}return this.flatMidpoints_}getId(){return this.id_}getOrientedFlatCoordinates(){return this.flatCoordinates_}getGeometry(){return this}getSimplifiedGeometry(e){return this}simplifyTransformed(e,i){return this}getProperties(){return this.properties_}getStride(){return 2}getStyleFunction(){return this.styleFunction}getType(){return this.type_}transform(e){e=le(e);const i=e.getExtent(),r=e.getWorldExtent();if(i&&r){const s=J(r)/J(i);Ie(ie,r[0],r[3],s,-s,0,0,0),Ve(this.flatCoordinates_,0,this.flatCoordinates_.length,2,ie,this.flatCoordinates_)}}getEnds(){return this.ends_}}j.prototype.getEndss=j.prototype.getEnds;j.prototype.getFlatCoordinates=j.prototype.getOrientedFlatCoordinates;const re=j;var $={};/*! ieee754. BSD-3-Clause License. Feross Aboukhadijeh <https://feross.org/opensource> */$.read=function(t,e,i,r,s){var n,o,d=s*8-r-1,l=(1<<d)-1,u=l>>1,a=-7,h=i?s-1:0,f=i?-1:1,c=t[e+h];for(h+=f,n=c&(1<<-a)-1,c>>=-a,a+=d;a>0;n=n*256+t[e+h],h+=f,a-=8);for(o=n&(1<<-a)-1,n>>=-a,a+=r;a>0;o=o*256+t[e+h],h+=f,a-=8);if(n===0)n=1-u;else{if(n===l)return o?NaN:(c?-1:1)*(1/0);o=o+Math.pow(2,r),n=n-u}return(c?-1:1)*o*Math.pow(2,n-r)};$.write=function(t,e,i,r,s,n){var o,d,l,u=n*8-s-1,a=(1<<u)-1,h=a>>1,f=s===23?Math.pow(2,-24)-Math.pow(2,-77):0,c=r?0:n-1,g=r?1:-1,x=e<0||e===0&&1/e<0?1:0;for(e=Math.abs(e),isNaN(e)||e===1/0?(d=isNaN(e)?1:0,o=a):(o=Math.floor(Math.log(e)/Math.LN2),e*(l=Math.pow(2,-o))<1&&(o--,l*=2),o+h>=1?e+=f/l:e+=f*Math.pow(2,1-h),e*l>=2&&(o++,l/=2),o+h>=a?(d=0,o=a):o+h>=1?(d=(e*l-1)*Math.pow(2,s),o=o+h):(d=e*Math.pow(2,h-1)*Math.pow(2,s),o=0));s>=8;t[i+c]=d&255,c+=g,d/=256,s-=8);for(o=o<<s|d,u+=s;u>0;t[i+c]=o&255,c+=g,o/=256,u-=8);t[i+c-g]|=x*128};var ut=y,z=$;function y(t){this.buf=ArrayBuffer.isView&&ArrayBuffer.isView(t)?t:new Uint8Array(t||0),this.pos=0,this.type=0,this.length=this.buf.length}y.Varint=0;y.Fixed64=1;y.Bytes=2;y.Fixed32=5;var Y=(1<<16)*(1<<16),se=1/Y,ht=12,ge=typeof TextDecoder>"u"?null:new TextDecoder("utf8");y.prototype={destroy:function(){this.buf=null},readFields:function(t,e,i){for(i=i||this.length;this.pos<i;){var r=this.readVarint(),s=r>>3,n=this.pos;this.type=r&7,t(s,e,this),this.pos===n&&this.skip(r)}return e},readMessage:function(t,e){return this.readFields(t,e,this.readVarint()+this.pos)},readFixed32:function(){var t=H(this.buf,this.pos);return this.pos+=4,t},readSFixed32:function(){var t=oe(this.buf,this.pos);return this.pos+=4,t},readFixed64:function(){var t=H(this.buf,this.pos)+H(this.buf,this.pos+4)*Y;return this.pos+=8,t},readSFixed64:function(){var t=H(this.buf,this.pos)+oe(this.buf,this.pos+4)*Y;return this.pos+=8,t},readFloat:function(){var t=z.read(this.buf,this.pos,!0,23,4);return this.pos+=4,t},readDouble:function(){var t=z.read(this.buf,this.pos,!0,52,8);return this.pos+=8,t},readVarint:function(t){var e=this.buf,i,r;return r=e[this.pos++],i=r&127,r<128||(r=e[this.pos++],i|=(r&127)<<7,r<128)||(r=e[this.pos++],i|=(r&127)<<14,r<128)||(r=e[this.pos++],i|=(r&127)<<21,r<128)?i:(r=e[this.pos],i|=(r&15)<<28,ct(i,t,this))},readVarint64:function(){return this.readVarint(!0)},readSVarint:function(){var t=this.readVarint();return t%2===1?(t+1)/-2:t/2},readBoolean:function(){return Boolean(this.readVarint())},readString:function(){var t=this.readVarint()+this.pos,e=this.pos;return this.pos=t,t-e>=ht&&ge?St(this.buf,e,t):mt(this.buf,e,t)},readBytes:function(){var t=this.readVarint()+this.pos,e=this.buf.subarray(this.pos,t);return this.pos=t,e},readPackedVarint:function(t,e){if(this.type!==y.Bytes)return t.push(this.readVarint(e));var i=M(this);for(t=t||[];this.pos<i;)t.push(this.readVarint(e));return t},readPackedSVarint:function(t){if(this.type!==y.Bytes)return t.push(this.readSVarint());var e=M(this);for(t=t||[];this.pos<e;)t.push(this.readSVarint());return t},readPackedBoolean:function(t){if(this.type!==y.Bytes)return t.push(this.readBoolean());var e=M(this);for(t=t||[];this.pos<e;)t.push(this.readBoolean());return t},readPackedFloat:function(t){if(this.type!==y.Bytes)return t.push(this.readFloat());var e=M(this);for(t=t||[];this.pos<e;)t.push(this.readFloat());return t},readPackedDouble:function(t){if(this.type!==y.Bytes)return t.push(this.readDouble());var e=M(this);for(t=t||[];this.pos<e;)t.push(this.readDouble());return t},readPackedFixed32:function(t){if(this.type!==y.Bytes)return t.push(this.readFixed32());var e=M(this);for(t=t||[];this.pos<e;)t.push(this.readFixed32());return t},readPackedSFixed32:function(t){if(this.type!==y.Bytes)return t.push(this.readSFixed32());var e=M(this);for(t=t||[];this.pos<e;)t.push(this.readSFixed32());return t},readPackedFixed64:function(t){if(this.type!==y.Bytes)return t.push(this.readFixed64());var e=M(this);for(t=t||[];this.pos<e;)t.push(this.readFixed64());return t},readPackedSFixed64:function(t){if(this.type!==y.Bytes)return t.push(this.readSFixed64());var e=M(this);for(t=t||[];this.pos<e;)t.push(this.readSFixed64());return t},skip:function(t){var e=t&7;if(e===y.Varint)for(;this.buf[this.pos++]>127;);else if(e===y.Bytes)this.pos=this.readVarint()+this.pos;else if(e===y.Fixed32)this.pos+=4;else if(e===y.Fixed64)this.pos+=8;else throw new Error("Unimplemented type: "+e)},writeTag:function(t,e){this.writeVarint(t<<3|e)},realloc:function(t){for(var e=this.length||16;e<this.pos+t;)e*=2;if(e!==this.length){var i=new Uint8Array(e);i.set(this.buf),this.buf=i,this.length=e}},finish:function(){return this.length=this.pos,this.pos=0,this.buf.subarray(0,this.length)},writeFixed32:function(t){this.realloc(4),O(this.buf,t,this.pos),this.pos+=4},writeSFixed32:function(t){this.realloc(4),O(this.buf,t,this.pos),this.pos+=4},writeFixed64:function(t){this.realloc(8),O(this.buf,t&-1,this.pos),O(this.buf,Math.floor(t*se),this.pos+4),this.pos+=8},writeSFixed64:function(t){this.realloc(8),O(this.buf,t&-1,this.pos),O(this.buf,Math.floor(t*se),this.pos+4),this.pos+=8},writeVarint:function(t){if(t=+t||0,t>268435455||t<0){ft(t,this);return}this.realloc(4),this.buf[this.pos++]=t&127|(t>127?128:0),!(t<=127)&&(this.buf[this.pos++]=(t>>>=7)&127|(t>127?128:0),!(t<=127)&&(this.buf[this.pos++]=(t>>>=7)&127|(t>127?128:0),!(t<=127)&&(this.buf[this.pos++]=t>>>7&127)))},writeSVarint:function(t){this.writeVarint(t<0?-t*2-1:t*2)},writeBoolean:function(t){this.writeVarint(Boolean(t))},writeString:function(t){t=String(t),this.realloc(t.length*4),this.pos++;var e=this.pos;this.pos=vt(this.buf,t,this.pos);var i=this.pos-e;i>=128&&ne(e,i,this),this.pos=e-1,this.writeVarint(i),this.pos+=i},writeFloat:function(t){this.realloc(4),z.write(this.buf,t,this.pos,!0,23,4),this.pos+=4},writeDouble:function(t){this.realloc(8),z.write(this.buf,t,this.pos,!0,52,8),this.pos+=8},writeBytes:function(t){var e=t.length;this.writeVarint(e),this.realloc(e);for(var i=0;i<e;i++)this.buf[this.pos++]=t[i]},writeRawMessage:function(t,e){this.pos++;var i=this.pos;t(e,this);var r=this.pos-i;r>=128&&ne(i,r,this),this.pos=i-1,this.writeVarint(r),this.pos+=r},writeMessage:function(t,e,i){this.writeTag(t,y.Bytes),this.writeRawMessage(e,i)},writePackedVarint:function(t,e){e.length&&this.writeMessage(t,pt,e)},writePackedSVarint:function(t,e){e.length&&this.writeMessage(t,Tt,e)},writePackedBoolean:function(t,e){e.length&&this.writeMessage(t,wt,e)},writePackedFloat:function(t,e){e.length&&this.writeMessage(t,yt,e)},writePackedDouble:function(t,e){e.length&&this.writeMessage(t,Ft,e)},writePackedFixed32:function(t,e){e.length&&this.writeMessage(t,Ct,e)},writePackedSFixed32:function(t,e){e.length&&this.writeMessage(t,_t,e)},writePackedFixed64:function(t,e){e.length&&this.writeMessage(t,Et,e)},writePackedSFixed64:function(t,e){e.length&&this.writeMessage(t,Rt,e)},writeBytesField:function(t,e){this.writeTag(t,y.Bytes),this.writeBytes(e)},writeFixed32Field:function(t,e){this.writeTag(t,y.Fixed32),this.writeFixed32(e)},writeSFixed32Field:function(t,e){this.writeTag(t,y.Fixed32),this.writeSFixed32(e)},writeFixed64Field:function(t,e){this.writeTag(t,y.Fixed64),this.writeFixed64(e)},writeSFixed64Field:function(t,e){this.writeTag(t,y.Fixed64),this.writeSFixed64(e)},writeVarintField:function(t,e){this.writeTag(t,y.Varint),this.writeVarint(e)},writeSVarintField:function(t,e){this.writeTag(t,y.Varint),this.writeSVarint(e)},writeStringField:function(t,e){this.writeTag(t,y.Bytes),this.writeString(e)},writeFloatField:function(t,e){this.writeTag(t,y.Fixed32),this.writeFloat(e)},writeDoubleField:function(t,e){this.writeTag(t,y.Fixed64),this.writeDouble(e)},writeBooleanField:function(t,e){this.writeVarintField(t,Boolean(e))}};function ct(t,e,i){var r=i.buf,s,n;if(n=r[i.pos++],s=(n&112)>>4,n<128||(n=r[i.pos++],s|=(n&127)<<3,n<128)||(n=r[i.pos++],s|=(n&127)<<10,n<128)||(n=r[i.pos++],s|=(n&127)<<17,n<128)||(n=r[i.pos++],s|=(n&127)<<24,n<128)||(n=r[i.pos++],s|=(n&1)<<31,n<128))return L(t,s,e);throw new Error("Expected varint not more than 10 bytes")}function M(t){return t.type===y.Bytes?t.readVarint()+t.pos:t.pos+1}function L(t,e,i){return i?e*4294967296+(t>>>0):(e>>>0)*4294967296+(t>>>0)}function ft(t,e){var i,r;if(t>=0?(i=t%4294967296|0,r=t/4294967296|0):(i=~(-t%4294967296),r=~(-t/4294967296),i^4294967295?i=i+1|0:(i=0,r=r+1|0)),t>=18446744073709552e3||t<-18446744073709552e3)throw new Error("Given varint doesn't fit into 10 bytes");e.realloc(10),gt(i,r,e),xt(r,e)}function gt(t,e,i){i.buf[i.pos++]=t&127|128,t>>>=7,i.buf[i.pos++]=t&127|128,t>>>=7,i.buf[i.pos++]=t&127|128,t>>>=7,i.buf[i.pos++]=t&127|128,t>>>=7,i.buf[i.pos]=t&127}function xt(t,e){var i=(t&7)<<4;e.buf[e.pos++]|=i|((t>>>=3)?128:0),t&&(e.buf[e.pos++]=t&127|((t>>>=7)?128:0),t&&(e.buf[e.pos++]=t&127|((t>>>=7)?128:0),t&&(e.buf[e.pos++]=t&127|((t>>>=7)?128:0),t&&(e.buf[e.pos++]=t&127|((t>>>=7)?128:0),t&&(e.buf[e.pos++]=t&127)))))}function ne(t,e,i){var r=e<=16383?1:e<=2097151?2:e<=268435455?3:Math.floor(Math.log(e)/(Math.LN2*7));i.realloc(r);for(var s=i.pos-1;s>=t;s--)i.buf[s+r]=i.buf[s]}function pt(t,e){for(var i=0;i<t.length;i++)e.writeVarint(t[i])}function Tt(t,e){for(var i=0;i<t.length;i++)e.writeSVarint(t[i])}function yt(t,e){for(var i=0;i<t.length;i++)e.writeFloat(t[i])}function Ft(t,e){for(var i=0;i<t.length;i++)e.writeDouble(t[i])}function wt(t,e){for(var i=0;i<t.length;i++)e.writeBoolean(t[i])}function Ct(t,e){for(var i=0;i<t.length;i++)e.writeFixed32(t[i])}function _t(t,e){for(var i=0;i<t.length;i++)e.writeSFixed32(t[i])}function Et(t,e){for(var i=0;i<t.length;i++)e.writeFixed64(t[i])}function Rt(t,e){for(var i=0;i<t.length;i++)e.writeSFixed64(t[i])}function H(t,e){return(t[e]|t[e+1]<<8|t[e+2]<<16)+t[e+3]*16777216}function O(t,e,i){t[i]=e,t[i+1]=e>>>8,t[i+2]=e>>>16,t[i+3]=e>>>24}function oe(t,e){return(t[e]|t[e+1]<<8|t[e+2]<<16)+(t[e+3]<<24)}function mt(t,e,i){for(var r="",s=e;s<i;){var n=t[s],o=null,d=n>239?4:n>223?3:n>191?2:1;if(s+d>i)break;var l,u,a;d===1?n<128&&(o=n):d===2?(l=t[s+1],(l&192)===128&&(o=(n&31)<<6|l&63,o<=127&&(o=null))):d===3?(l=t[s+1],u=t[s+2],(l&192)===128&&(u&192)===128&&(o=(n&15)<<12|(l&63)<<6|u&63,(o<=2047||o>=55296&&o<=57343)&&(o=null))):d===4&&(l=t[s+1],u=t[s+2],a=t[s+3],(l&192)===128&&(u&192)===128&&(a&192)===128&&(o=(n&15)<<18|(l&63)<<12|(u&63)<<6|a&63,(o<=65535||o>=1114112)&&(o=null))),o===null?(o=65533,d=1):o>65535&&(o-=65536,r+=String.fromCharCode(o>>>10&1023|55296),o=56320|o&1023),r+=String.fromCharCode(o),s+=d}return r}function St(t,e,i){return ge.decode(t.subarray(e,i))}function vt(t,e,i){for(var r=0,s,n;r<e.length;r++){if(s=e.charCodeAt(r),s>55295&&s<57344)if(n)if(s<56320){t[i++]=239,t[i++]=191,t[i++]=189,n=s;continue}else s=n-55296<<10|s-56320|65536,n=null;else{s>56319||r+1===e.length?(t[i++]=239,t[i++]=191,t[i++]=189):n=s;continue}else n&&(t[i++]=239,t[i++]=191,t[i++]=189,n=null);s<128?t[i++]=s:(s<2048?t[i++]=s>>6|192:(s<65536?t[i++]=s>>12|224:(t[i++]=s>>18|240,t[i++]=s>>12&63|128),t[i++]=s>>6&63|128),t[i++]=s&63|128)}return i}class Pt extends we{constructor(e){super(),e=e||{},this.dataProjection=new Le({code:"",units:"tile-pixels"}),this.featureClass_=e.featureClass?e.featureClass:re,this.geometryName_=e.geometryName,this.layerName_=e.layerName?e.layerName:"layer",this.layers_=e.layers?e.layers:null,this.idProperty_=e.idProperty,this.supportedMediaTypes=["application/vnd.mapbox-vector-tile","application/x-protobuf"]}readRawGeometry_(e,i,r,s){e.pos=i.geometry;const n=e.readVarint()+e.pos;let o=1,d=0,l=0,u=0,a=0,h=0;for(;e.pos<n;){if(!d){const f=e.readVarint();o=f&7,d=f>>3}d--,o===1||o===2?(l+=e.readSVarint(),u+=e.readSVarint(),o===1&&a>h&&(s.push(a),h=a),r.push(l,u),a+=2):o===7?a>h&&(r.push(r[h],r[h+1]),a+=2):ue(!1,59)}a>h&&(s.push(a),h=a)}createFeature_(e,i,r){const s=i.type;if(s===0)return null;let n;const o=i.properties;let d;this.idProperty_?(d=o[this.idProperty_],delete o[this.idProperty_]):d=i.id,o[this.layerName_]=i.layer.name;const l=[],u=[];this.readRawGeometry_(e,i,l,u);const a=Vt(s,u.length);if(this.featureClass_===re)n=new this.featureClass_(a,l,u,o,d),n.transform(r.dataProjection);else{let h;if(a=="Polygon"){const g=Oe(l,u);h=g.length>1?new Ce(l,"XY",g):new Be(l,"XY",u)}else h=a==="Point"?new ke(l,"XY"):a==="LineString"?new _e(l,"XY"):a==="MultiPoint"?new Ee(l,"XY"):a==="MultiLineString"?new Re(l,"XY",u):null;const f=this.featureClass_;n=new f,this.geometryName_&&n.setGeometryName(this.geometryName_);const c=me(h,!1,r);n.setGeometry(c),d!==void 0&&n.setId(d),n.setProperties(o,!0)}return n}getType(){return"arraybuffer"}readFeatures(e,i){const r=this.layers_;i=this.adaptOptions(i);const s=le(i.dataProjection);s.setWorldExtent(i.extent),i.dataProjection=s;const n=new ut(e),o=n.readFields(Gt,{}),d=[];for(const l in o){if(r&&!r.includes(l))continue;const u=o[l],a=u?[0,0,u.extent,u.extent]:null;s.setExtent(a);for(let h=0,f=u.length;h<f;++h){const c=It(n,u,h),g=this.createFeature_(n,c,i);g!==null&&d.push(g)}}return d}readProjection(e){return this.dataProjection}setLayers(e){this.layers_=e}}function Gt(t,e,i){if(t===3){const r={keys:[],values:[],features:[]},s=i.readVarint()+i.pos;i.readFields(Dt,r,s),r.length=r.features.length,r.length&&(e[r.name]=r)}}function Dt(t,e,i){if(t===15)e.version=i.readVarint();else if(t===1)e.name=i.readString();else if(t===5)e.extent=i.readVarint();else if(t===2)e.features.push(i.pos);else if(t===3)e.keys.push(i.readString());else if(t===4){let r=null;const s=i.readVarint()+i.pos;for(;i.pos<s;)t=i.readVarint()>>3,r=t===1?i.readString():t===2?i.readFloat():t===3?i.readDouble():t===4?i.readVarint64():t===5?i.readVarint():t===6?i.readSVarint():t===7?i.readBoolean():null;e.values.push(r)}}function Mt(t,e,i){if(t==1)e.id=i.readVarint();else if(t==2){const r=i.readVarint()+i.pos;for(;i.pos<r;){const s=e.layer.keys[i.readVarint()],n=e.layer.values[i.readVarint()];e.properties[s]=n}}else t==3?e.type=i.readVarint():t==4&&(e.geometry=i.pos)}function It(t,e,i){t.pos=e.features[i];const r=t.readVarint()+t.pos,s={layer:e,type:0,properties:{}};return t.readFields(Mt,s,r),s}function Vt(t,e){let i;return t===1?i=e===1?"Point":"MultiPoint":t===2?i=e===1?"LineString":"MultiLineString":t===3&&(i="Polygon"),i}const Jt=Pt,Lt={image:["Polygon","Circle","LineString","Image","Text"],hybrid:["Polygon","LineString"],vector:[]},Ot={hybrid:["Image","Text","Default"],vector:["Polygon","Circle","LineString","Image","Text","Default"]};class Bt extends tt{constructor(e){super(e),this.boundHandleStyleImageChange_=this.handleStyleImageChange_.bind(this),this.renderedLayerRevision_,this.renderedPixelToCoordinateTransform_=null,this.renderedRotation_,this.tmpTransform_=de()}prepareTile(e,i,r){let s;const n=e.getState();return(n===C.LOADED||n===C.ERROR)&&(this.updateExecutorGroup_(e,i,r),this.tileImageNeedsRender_(e)&&(s=!0)),s}getTile(e,i,r,s){const n=s.pixelRatio,o=s.viewState,d=o.resolution,l=o.projection,u=this.getLayer(),a=u.getSource().getTile(e,i,r,n,l),h=s.viewHints,f=!(h[V.ANIMATING]||h[V.INTERACTING]);return(f||!a.wantedResolution)&&(a.wantedResolution=d),this.prepareTile(a,n,l)&&(f||Date.now()-s.time<8)&&u.getRenderMode()!=="vector"&&this.renderTileImage_(a,s),super.getTile(e,i,r,s)}isDrawableTile(e){const i=this.getLayer();return super.isDrawableTile(e)&&(i.getRenderMode()==="vector"?G(i)in e.executorGroups:e.hasContext(i))}getTileImage(e){return e.getImage(this.getLayer())}prepareFrame(e){const i=this.getLayer().getRevision();return this.renderedLayerRevision_!==i&&(this.renderedLayerRevision_=i,this.renderedTiles.length=0),super.prepareFrame(e)}updateExecutorGroup_(e,i,r){const s=this.getLayer(),n=s.getRevision(),o=s.getRenderOrder()||null,d=e.wantedResolution,l=e.getReplayState(s);if(!l.dirty&&l.renderedResolution===d&&l.renderedRevision==n&&l.renderedRenderOrder==o)return;const u=s.getSource(),a=s.getDeclutter(),h=u.getTileGrid(),c=u.getTileGridForProjection(r).getTileCoordExtent(e.wrappedTileCoord),g=u.getSourceTiles(i,r,e),x=G(s);delete e.hitDetectionImageData[x],e.executorGroups[x]=[],a&&(e.declutterExecutorGroups[x]=[]),l.dirty=!1;for(let F=0,_=g.length;F<_;++F){const T=g[F];if(T.getState()!=C.LOADED)continue;const p=T.tileCoord,w=h.getTileCoordExtent(p),m=he(c,w),P=N(m,s.getRenderBuffer()*d,this.tmpExtent),S=Ae(w,m)?null:P,E=new b(0,P,d,i),R=a?new b(0,m,d,i):void 0,I=Je(d,i),v=function(D){let k;const A=D.getStyleFunction()||s.getStyleFunction();if(A&&(k=A(D,d)),k){const ye=this.renderFeature(D,I,k,E,R);l.dirty=l.dirty||ye}},K=T.getFeatures();o&&o!==l.renderedRenderOrder&&K.sort(o);for(let D=0,k=K.length;D<k;++D){const A=K[D];(!S||B(S,A.getGeometry().getExtent()))&&v.call(this,A)}const xe=E.finish(),pe=s.getRenderMode()!=="vector"&&a&&g.length===1?null:m,Te=new ee(pe,d,i,u.getOverlaps(),xe,s.getRenderBuffer());if(e.executorGroups[x].push(Te),R){const D=new ee(null,d,i,u.getOverlaps(),R.finish(),s.getRenderBuffer());e.declutterExecutorGroups[x].push(D)}}l.renderedRevision=n,l.renderedRenderOrder=o,l.renderedResolution=d}forEachFeatureAtCoordinate(e,i,r,s,n){const o=i.viewState.resolution,d=i.viewState.rotation;r=r==null?0:r;const l=this.getLayer(),a=l.getSource().getTileGridForProjection(i.viewState.projection),h=Ne([e]);N(h,o*r,h);const f={},c=function(F,_,T){let p=F.getId();p===void 0&&(p=G(F));const w=f[p];if(w){if(w!==!0&&T<w.distanceSq){if(T===0)return f[p]=!0,n.splice(n.lastIndexOf(w),1),s(F,l,_);w.geometry=_,w.distanceSq=T}}else{if(T===0)return f[p]=!0,s(F,l,_);n.push(f[p]={feature:F,layer:l,geometry:_,distanceSq:T,callback:s})}},g=this.renderedTiles;let x;for(let F=0,_=g.length;!x&&F<_;++F){const T=g[F],p=a.getTileCoordExtent(T.wrappedTileCoord);if(!B(p,h))continue;const w=G(l),m=[T.executorGroups[w]],P=T.declutterExecutorGroups[w];P&&m.push(P),m.some(S=>{const E=S===P?i.declutterTree.all().map(R=>R.value):null;for(let R=0,I=S.length;R<I;++R)if(x=S[R].forEachFeatureAtCoordinate(e,o,d,r,c,E),x)return!0})}return x}getFeatures(e){return new Promise((i,r)=>{const s=this.getLayer(),n=G(s),o=s.getSource(),d=this.renderedProjection,l=d.getExtent(),u=this.renderedResolution,a=o.getTileGridForProjection(d),h=je(this.renderedPixelToCoordinateTransform_,e.slice()),f=a.getTileCoordForCoordAndResolution(h,u);let c;for(let p=0,w=this.renderedTiles.length;p<w;++p)if(f.toString()===this.renderedTiles[p].tileCoord.toString()){if(c=this.renderedTiles[p],c.getState()===C.LOADED){const m=a.getTileCoordExtent(c.tileCoord);o.getWrapX()&&d.canWrapX()&&!Ue(l,m)&&ze(h,d);break}c=void 0}if(!c||c.loadingSourceTiles>0){i([]);return}const g=a.getTileCoordExtent(c.wrappedTileCoord),x=He(g),F=[(h[0]-x[0])/u,(x[1]-h[1])/u],_=c.getSourceTiles().reduce(function(p,w){return p.concat(w.getFeatures())},[]);let T=c.hitDetectionImageData[n];if(!T){const p=ce(a.getTileSize(a.getZForResolution(u,o.zDirection))),w=this.renderedRotation_,m=[this.getRenderTransform(a.getTileCoordCenter(c.wrappedTileCoord),u,0,Z,p[0]*Z,p[1]*Z,0)];T=Qe(p,m,_,s.getStyleFunction(),a.getTileCoordExtent(c.wrappedTileCoord),c.getReplayState(s).renderedResolution,w),c.hitDetectionImageData[n]=T}i(qe(F,_,T))})}handleFontsChanged(){const e=this.getLayer();e.getVisible()&&this.renderedLayerRevision_!==void 0&&e.changed()}handleStyleImageChange_(e){this.renderIfReadyAndVisible()}renderDeclutter(e){const i=this.context,r=i.globalAlpha;i.globalAlpha=this.getLayer().getOpacity();const s=e.viewHints,n=!(s[V.ANIMATING]||s[V.INTERACTING]),o=this.renderedTiles;for(let d=0,l=o.length;d<l;++d){const u=o[d],a=u.declutterExecutorGroups[G(this.getLayer())];if(a)for(let h=a.length-1;h>=0;--h)a[h].execute(this.context,1,this.getTileRenderTransform(u,e),e.viewState.rotation,n,void 0,e.declutterTree)}i.globalAlpha=r}getTileRenderTransform(e,i){const r=i.pixelRatio,s=i.viewState,n=s.center,o=s.resolution,d=s.rotation,l=i.size,u=Math.round(l[0]*r),a=Math.round(l[1]*r),f=this.getLayer().getSource().getTileGridForProjection(i.viewState.projection),c=e.tileCoord,g=f.getTileCoordExtent(e.wrappedTileCoord),x=f.getTileCoordExtent(c,this.tmpExtent)[0]-g[0];return Ke(X(this.inversePixelTransform.slice(),1/r,1/r),this.getRenderTransform(n,o,d,r,u,a,x))}postRender(e,i){const r=i.viewHints,s=!(r[V.ANIMATING]||r[V.INTERACTING]);this.renderedPixelToCoordinateTransform_=i.pixelToCoordinateTransform.slice(),this.renderedRotation_=i.viewState.rotation;const n=this.getLayer(),o=n.getRenderMode(),d=e.globalAlpha;e.globalAlpha=n.getOpacity();const l=Ot[o],u=i.viewState,a=u.rotation,h=n.getSource(),c=h.getTileGridForProjection(u.projection).getZForResolution(u.resolution,h.zDirection),g=this.renderedTiles,x=[],F=[];let _=!0;for(let T=g.length-1;T>=0;--T){const p=g[T];_=_&&!p.getReplayState(n).dirty;const w=p.executorGroups[G(n)].filter(R=>R.hasExecutors(l));if(w.length===0)continue;const m=this.getTileRenderTransform(p,i),P=p.tileCoord[0];let S=!1;const E=w[0].getClipCoords(m);if(E){for(let R=0,I=x.length;R<I;++R)if(c!==P&&P<F[R]){const v=x[R];B([E[0],E[3],E[4],E[7]],[v[0],v[3],v[4],v[7]])&&(S||(e.save(),S=!0),e.beginPath(),e.moveTo(E[0],E[1]),e.lineTo(E[2],E[3]),e.lineTo(E[4],E[5]),e.lineTo(E[6],E[7]),e.moveTo(v[6],v[7]),e.lineTo(v[4],v[5]),e.lineTo(v[2],v[3]),e.lineTo(v[0],v[1]),e.clip())}x.push(E),F.push(P)}for(let R=0,I=w.length;R<I;++R)w[R].execute(e,1,m,a,s,l);S&&e.restore()}e.globalAlpha=d,this.ready=_,super.postRender(e,i)}renderFeature(e,i,r,s,n){if(!r)return!1;let o=!1;if(Array.isArray(r))for(let d=0,l=r.length;d<l;++d)o=te(s,e,r[d],i,this.boundHandleStyleImageChange_,void 0,n)||o;else o=te(s,e,r,i,this.boundHandleStyleImageChange_,void 0,n);return o}tileImageNeedsRender_(e){const i=this.getLayer();if(i.getRenderMode()==="vector")return!1;const r=e.getReplayState(i),s=i.getRevision(),n=e.wantedResolution;return r.renderedTileResolution!==n||r.renderedTileRevision!==s}renderTileImage_(e,i){const r=this.getLayer(),s=e.getReplayState(r),n=r.getRevision(),o=e.executorGroups[G(r)];s.renderedTileRevision=n;const d=e.wrappedTileCoord,l=d[0],u=r.getSource();let a=i.pixelRatio;const f=i.viewState.projection,c=u.getTileGridForProjection(f),g=c.getResolution(e.tileCoord[0]),x=i.pixelRatio/e.wantedResolution*g,F=c.getResolution(l),_=e.getContext(r);a=Math.round(Math.max(a,x/a));const T=u.getTilePixelSize(l,a,f);_.canvas.width=T[0],_.canvas.height=T[1];const p=a/x;if(p!==1){const S=Q(this.tmpTransform_);X(S,p,p),_.setTransform.apply(_,S)}const w=c.getTileCoordExtent(d,this.tmpExtent),m=x/F,P=Q(this.tmpTransform_);X(P,m,-m),Xe(P,-w[0],-w[3]);for(let S=0,E=o.length;S<E;++S)o[S].execute(_,p,P,0,!0,Lt[r.getRenderMode()]);s.renderedTileResolution=e.wantedResolution}}const kt=Bt;class At extends be{constructor(e){e=e||{};const i=Object.assign({},e);delete i.preload,delete i.useInterimTilesOnError,super(i),this.on,this.once,this.un;const r=e.renderMode||"hybrid";ue(r=="hybrid"||r=="vector",28),this.renderMode_=r,this.setPreload(e.preload?e.preload:0),this.setUseInterimTilesOnError(e.useInterimTilesOnError!==void 0?e.useInterimTilesOnError:!0),this.getBackground,this.setBackground}createRenderer(){return new kt(this)}getFeatures(e){return super.getFeatures(e)}getRenderMode(){return this.renderMode_}getPreload(){return this.get(U.PRELOAD)}getUseInterimTilesOnError(){return this.get(U.USE_INTERIM_TILES_ON_ERROR)}setPreload(e){this.set(U.PRELOAD,e)}setUseInterimTilesOnError(e){this.set(U.USE_INTERIM_TILES_ON_ERROR,e)}}const Qt=At;class Nt extends fe{constructor(e,i,r,s,n,o){super(e,i,o),this.extent=null,this.format_=s,this.features_=null,this.loader_,this.projection=null,this.resolution,this.tileLoadFunction_=n,this.url_=r,this.key=r}getFormat(){return this.format_}getFeatures(){return this.features_}load(){this.state==C.IDLE&&(this.setState(C.LOADING),this.tileLoadFunction_(this,this.url_),this.loader_&&this.loader_(this.extent,this.resolution,this.projection))}onLoad(e,i){this.setFeatures(e)}onError(){this.setState(C.ERROR)}setFeatures(e){this.features_=e,this.setState(C.LOADED)}setLoader(e){this.loader_=e}}const jt=Nt,ae=[];class Ut extends fe{constructor(e,i,r,s){super(e,i,{transition:0}),this.context_={},this.executorGroups={},this.declutterExecutorGroups={},this.loadingSourceTiles=0,this.hitDetectionImageData={},this.replayState_={},this.sourceTiles=[],this.errorTileKeys={},this.wantedResolution,this.getSourceTiles=s.bind(void 0,this),this.wrappedTileCoord=r}getContext(e){const i=G(e);return i in this.context_||(this.context_[i]=Ze(1,1,ae)),this.context_[i]}hasContext(e){return G(e)in this.context_}getImage(e){return this.hasContext(e)?this.getContext(e).canvas:null}getReplayState(e){const i=G(e);return i in this.replayState_||(this.replayState_[i]={dirty:!1,renderedRenderOrder:null,renderedResolution:NaN,renderedRevision:-1,renderedTileResolution:NaN,renderedTileRevision:-1,renderedTileZ:-1}),this.replayState_[i]}load(){this.getSourceTiles()}release(){for(const e in this.context_){const i=this.context_[e];Ye(i),ae.push(i.canvas),delete this.context_[e]}super.release()}}const zt=Ut;class Ht extends it{constructor(e){const i=e.projection||"EPSG:3857",r=e.extent||rt(i),s=e.tileGrid||st({extent:r,maxResolution:e.maxResolution,maxZoom:e.maxZoom!==void 0?e.maxZoom:22,minZoom:e.minZoom,tileSize:e.tileSize||512});super({attributions:e.attributions,attributionsCollapsible:e.attributionsCollapsible,cacheSize:e.cacheSize,interpolate:!0,opaque:!1,projection:i,state:e.state,tileGrid:s,tileLoadFunction:e.tileLoadFunction?e.tileLoadFunction:Kt,tileUrlFunction:e.tileUrlFunction,url:e.url,urls:e.urls,wrapX:e.wrapX===void 0?!0:e.wrapX,transition:e.transition,zDirection:e.zDirection===void 0?1:e.zDirection}),this.format_=e.format?e.format:null,this.sourceTileCache=new nt(this.tileCache.highWaterMark),this.overlaps_=e.overlaps==null?!0:e.overlaps,this.tileClass=e.tileClass?e.tileClass:jt,this.tileGrids_={}}getFeaturesInExtent(e){const i=[],r=this.tileCache;if(r.getCount()===0)return i;const s=ot(r.peekFirstKey())[0],n=this.tileGrid;return r.forEach(function(o){if(o.tileCoord[0]!==s||o.getState()!==C.LOADED)return;const d=o.getSourceTiles();for(let l=0,u=d.length;l<u;++l){const a=d[l],h=a.tileCoord;if(B(e,n.getTileCoordExtent(h))){const f=a.getFeatures();if(f)for(let c=0,g=f.length;c<g;++c){const x=f[c],F=x.getGeometry();B(e,F.getExtent())&&i.push(x)}}}}),i}getOverlaps(){return this.overlaps_}clear(){this.tileCache.clear(),this.sourceTileCache.clear()}expireCache(e,i){const r=this.getTileCacheForProjection(e),s=Object.keys(i).reduce((n,o)=>{const d=at(o),l=r.peek(d);if(l){const u=l.sourceTiles;for(let a=0,h=u.length;a<h;++a)n[u[a].getKey()]=!0}return n},{});super.expireCache(e,i),this.sourceTileCache.expireCache(s)}getSourceTiles(e,i,r){if(r.getState()===C.IDLE){r.setState(C.LOADING);const s=r.wrappedTileCoord,n=this.getTileGridForProjection(i),o=n.getTileCoordExtent(s),d=s[0],l=n.getResolution(d);N(o,-l,o);const u=this.tileGrid,a=u.getExtent();a&&he(o,a,o);const h=u.getZForResolution(l,this.zDirection);u.forEachTileCoord(o,h,f=>{const c=this.tileUrlFunction(f,e,i),g=this.sourceTileCache.containsKey(c)?this.sourceTileCache.get(c):new this.tileClass(f,c?C.IDLE:C.EMPTY,c,this.format_,this.tileLoadFunction);r.sourceTiles.push(g);const x=g.getState();if(x<C.LOADED){const F=_=>{this.handleTileChange(_);const T=g.getState();if(T===C.LOADED||T===C.ERROR){const p=g.getKey();p in r.errorTileKeys?g.getState()===C.LOADED&&delete r.errorTileKeys[p]:r.loadingSourceTiles--,T===C.ERROR?r.errorTileKeys[p]=!0:g.removeEventListener(q.CHANGE,F),r.loadingSourceTiles===0&&r.setState(We(r.errorTileKeys)?C.LOADED:C.ERROR)}};g.addEventListener(q.CHANGE,F),r.loadingSourceTiles++}x===C.IDLE&&(g.extent=u.getTileCoordExtent(f),g.projection=i,g.resolution=u.getResolution(f[0]),this.sourceTileCache.set(c,g),g.load())}),r.loadingSourceTiles||r.setState(r.sourceTiles.some(f=>f.getState()===C.ERROR)?C.ERROR:C.LOADED)}return r.sourceTiles}getTile(e,i,r,s,n){const o=dt(e,i,r),d=this.getKey();let l;if(this.tileCache.containsKey(o)&&(l=this.tileCache.get(o),l.key===d))return l;const u=[e,i,r];let a=this.getTileCoordForTileUrlFunction(u,n);const h=this.getTileGrid().getExtent(),f=this.getTileGridForProjection(n);if(a&&h){const x=f.getTileCoordExtent(a);N(x,-f.getResolution(e),x),B(h,x)||(a=null)}let c=!0;if(a!==null){const x=this.tileGrid,F=f.getResolution(e),_=x.getZForResolution(F,1),T=f.getTileCoordExtent(a);N(T,-F,T),x.forEachTileCoord(T,_,p=>{c=c&&!this.tileUrlFunction(p,s,n)})}const g=new zt(u,c?C.EMPTY:C.IDLE,a,this.getSourceTiles.bind(this,s,n));return g.key=d,l?(g.interimTile=l,g.refreshInterimChain(),this.tileCache.replace(o,g)):this.tileCache.set(o,g),g}getTileGridForProjection(e){const i=e.getCode();let r=this.tileGrids_[i];if(!r){const s=this.tileGrid,n=s.getResolutions().slice(),o=n.map(function(u,a){return s.getOrigin(a)}),d=n.map(function(u,a){return s.getTileSize(a)}),l=$e+1;for(let u=n.length;u<l;++u)n.push(n[u-1]/2),o.push(o[u-1]),d.push(d[u-1]);r=new lt({extent:s.getExtent(),origins:o,resolutions:n,tileSizes:d}),this.tileGrids_[i]=r}return r}getTilePixelRatio(e){return e}getTilePixelSize(e,i,r){const s=this.getTileGridForProjection(r),n=ce(s.getTileSize(e),this.tmpSize);return[Math.round(n[0]*i),Math.round(n[1]*i)]}updateCacheSize(e,i){super.updateCacheSize(e*2,i),this.sourceTileCache.highWaterMark=this.getTileCacheForProjection(i).highWaterMark}}const qt=Ht;function Kt(t,e){t.setLoader(function(i,r,s){et(e,t.getFormat(),i,r,s,t.onLoad.bind(t),t.onError.bind(t))})}export{Jt as M,re as R,Qt as V,qt as a,Kt as d};
