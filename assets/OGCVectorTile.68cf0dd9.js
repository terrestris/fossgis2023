import{a as G}from"./VectorTile.e3b4ef73.js";import{T as H}from"./ImageTile.305100e9.js";import{m as D,b as F,c as V,e as W}from"./Layer.8ccb32f3.js";function Z(i,e,o,n){const l=document.createElement("script"),s="olc_"+D(e);function a(){delete window[s],l.parentNode.removeChild(l)}l.async=!0,l.src=i+(i.includes("?")?"&":"?")+(n||"callback")+"="+s;const r=setTimeout(function(){a(),o&&o()},1e4);window[s]=function(m){clearTimeout(r),a(),e(m)},document.head.appendChild(l)}class X extends Error{constructor(e){const o="Unexpected response status: "+e.status;super(o),this.name="ResponseError",this.response=e}}class _ extends Error{constructor(e){super("Failed to issue request"),this.name="ClientError",this.client=e}}function j(i){return new Promise(function(e,o){function n(a){const r=a.target;if(!r.status||r.status>=200&&r.status<300){let m;try{m=JSON.parse(r.responseText)}catch(g){const w="Error parsing response text as JSON: "+g.message;o(new Error(w));return}e(m);return}o(new X(r))}function l(a){o(new _(a.target))}const s=new XMLHttpRequest;s.addEventListener("load",n),s.addEventListener("error",l),s.open("GET",i),s.setRequestHeader("Accept","application/json"),s.send()})}function z(i,e){return e.includes("://")?e:new URL(e,i).href}const N={"image/png":!0,"image/jpeg":!0,"image/gif":!0,"image/webp":!0},q={"application/vnd.mapbox-vector-tile":!0,"application/geo+json":!0};function J(i,e){let o,n;for(let l=0;l<i.length;++l){const s=i[l];if(s.rel==="item"){if(s.type===e){o=s.href;break}(N[s.type]||!n&&s.type.startsWith("image/"))&&(n=s.href)}}if(!o)if(n)o=n;else throw new Error('Could not find "item" link');return o}function P(i,e,o){let n,l;const s={};for(let a=0;a<i.length;++a){const r=i[a];if(s[r.type]=r.href,r.rel==="item"){if(r.type===e){n=r.href;break}q[r.type]&&(l=r.href)}}if(!n&&o)for(let a=0;a<o.length;++a){const r=o[a];if(s[r]){n=s[r];break}}if(!n)if(l)n=l;else throw new Error('Could not find "item" link');return n}function U(i,e,o,n){let l=i.projection;if(!l&&(l=F(e.crs),!l))throw new Error(`Unsupported CRS: ${e.crs}`);const s=l.getAxisOrientation().substr(0,2)!=="en",a=e.tileMatrices,r={};for(let t=0;t<a.length;++t){const u=a[t];r[u.id]=u}const m={},g=[];if(n)for(let t=0;t<n.length;++t){const u=n[t],c=u.tileMatrix;g.push(c),m[c]=u}else for(let t=0;t<a.length;++t){const u=a[t].id;g.push(u)}const w=g.length,d=new Array(w),R=new Array(w),M=new Array(w),O=new Array(w),y=[-1/0,-1/0,1/0,1/0];for(let t=0;t<w;++t){const u=g[t],c=r[u],T=c.pointOfOrigin;s?d[t]=[T[1],T[0]]:d[t]=T,R[t]=c.cellSize,M[t]=[c.matrixWidth,c.matrixHeight],O[t]=[c.tileWidth,c.tileHeight];const p=m[u];if(p){const x=c.cellSize*c.tileWidth,h=d[t][0]+p.minTileCol*x,b=d[t][0]+(p.maxTileCol+1)*x,f=c.cellSize*c.tileHeight,E=c.cornerOfOrigin==="bottomLeft";let k,C;E?(k=d[t][1]+p.minTileRow*f,C=d[t][1]+(p.maxTileRow+1)*f):(k=d[t][1]-(p.maxTileRow+1)*f,C=d[t][1]-p.minTileRow*f),V(y,[h,k,b,C],y)}}const v=new H({origins:d,resolutions:R,sizes:M,tileSizes:O,extent:n?y:void 0}),S=i.context,L=i.url;function A(t,u,c){if(!t)return;const T=g[t[0]],p=r[T],x=p.cornerOfOrigin==="bottomLeft",h={tileMatrix:T,tileCol:t[1],tileRow:x?-t[2]-1:t[2]};if(n){const f=m[p.id];if(h.tileCol<f.minTileCol||h.tileCol>f.maxTileCol||h.tileRow<f.minTileRow||h.tileRow>f.maxTileRow)return}Object.assign(h,S);const b=o.replace(/\{(\w+?)\}/g,function(f,E){return h[E]});return z(L,b)}return{grid:v,urlTemplate:o,urlFunction:A}}function Y(i,e){const o=e.tileMatrixSetLimits;let n;if(e.dataType==="map")n=J(e.links,i.mediaType);else if(e.dataType==="vector")n=P(e.links,i.mediaType,i.supportedMediaTypes);else throw new Error('Expected tileset data type to be "map" or "vector"');if(e.tileMatrixSet)return U(i,e.tileMatrixSet,n,o);const l=e.links.find(r=>r.rel==="http://www.opengis.net/def/rel/ogc/1.0/tiling-scheme");if(!l)throw new Error("Expected http://www.opengis.net/def/rel/ogc/1.0/tiling-scheme link or tileMatrixSet");const s=l.href,a=z(i.url,s);return j(a).then(function(r){return U(i,r,n,o)})}function $(i){return j(i.url).then(function(e){return Y(i,e)})}class B extends G{constructor(e){super({attributions:e.attributions,attributionsCollapsible:e.attributionsCollapsible,cacheSize:e.cacheSize,format:e.format,overlaps:e.overlaps,projection:e.projection,tileClass:e.tileClass,transition:e.transition,wrapX:e.wrapX,zDirection:e.zDirection,state:"loading"});const o={url:e.url,projection:this.getProjection(),mediaType:e.mediaType,supportedMediaTypes:e.format.supportedMediaTypes,context:e.context||null};$(o).then(this.handleTileSetInfo_.bind(this)).catch(this.handleError_.bind(this))}handleTileSetInfo_(e){this.tileGrid=e.grid,this.setTileUrlFunction(e.urlFunction,e.urlTemplate),this.setState("ready")}handleError_(e){W(e),this.setState("error")}}const ee=B;export{ee as O,Z as j};
